<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>Controle Financeiro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* =================================================================== */
        /* 1. CONFIGURAÇÃO GERAL E TEMA (DARK MODE)                            */
        /* =================================================================== */
        body.dark-mode h1,
        body.dark-mode h3,
        body.dark-mode h5 {
            color: #f5f5f5;
        }

        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .list-group-item {
            background-color: #404040;
            border-color: #555;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 15px;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        body.dark-mode .card {
            background-color: #2d2d2d;
            border-color: #404040;
        }

        body.dark-mode .form-control {
            background-color: #404040;
            border-color: #555;
            color: #ffffff;
        }

        /* Ajusta a cor do texto de placeholder nos inputs */
        body.dark-mode .form-control::placeholder {
            color: #a0a0a0;
            opacity: 1;
            /* Garante que a cor seja aplicada */
        }

        /* Estiliza o container de ações em lote (Aplicar Categoria / Deletar) */
        body.dark-mode #bulkActionContainer {
            background-color: #3a3a3a;
            border: 1px solid #555;
        }

        /* Estiliza o botão de ID da transação */
        body.dark-mode .id-btn {
            background-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .id-btn:hover {
            background-color: #666;
        }

        /* Melhora o contraste de botões "outline" */
        body.dark-mode .btn-outline-secondary {
            --bs-btn-color: #adb5bd;
            --bs-btn-border-color: #adb5bd;
            --bs-btn-hover-bg: #adb5bd;
            --bs-btn-hover-color: #1a1a1a;
        }

        body.dark-mode .btn-outline-info {
            --bs-btn-color: #58a6ff;
            --bs-btn-border-color: #58a6ff;
            --bs-btn-hover-bg: #58a6ff;
            --bs-btn-hover-color: #ffffff;
        }

        /* Garante que o texto de labels (como "Selecionar todos") fique claro */
        body.dark-mode .form-check-label {
            color: #e0e0e0;
        }

        /* Melhora o contraste e a cor dos botões e texto da paginação */
        body.dark-mode .pagination-controls .btn-outline-primary {
            --bs-btn-color: #8ab4f8;
            --bs-btn-border-color: #8ab4f8;
            --bs-btn-hover-bg: #8ab4f8;
            --bs-btn-hover-color: #1a1a1a;
            /* Cor do texto no hover */
            --bs-btn-disabled-color: #495057;
            --bs-btn-disabled-border-color: #495057;
        }

        body.dark-mode .page-info {
            color: #e0e0e0;
        }

        /* Garante que o texto base nos containers de Metas e Análise Financeira fique claro */
        body.dark-mode #goalsView,
        body.dark-mode #futureView {
            color: #e0e0e0;
        }

        /* Regra específica para textos secundários, como em "Metas" */
        body.dark-mode .text-muted {
            color: #a0a0a0 !important;
        }

        /* Corrige o fundo do cabeçalho da tabela no modo escuro */
        body.dark-mode thead {
            background-color: #2d2d2d !important;
        }

        /* =================================================================== */
        /* 2. COMPONENTES PRINCIPAIS DA UI
            /* =================================================================== */

        /* Cards de Resumo (Topo) */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .summary-card.income {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .summary-card.expense {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .summary-card.balance {
            background: linear-gradient(135deg, #007bff, #6f42c1);
        }

        .summary-card.budget {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .summary-card h3 {
            margin: 0;
            font-size: 1.8rem;
        }

        .summary-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        /* Seção de Filtros */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* CSS dos Filtros */
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filters-row>div {
            display: flex;
            flex-direction: column;
        }

        .filters-row .d-flex {
            flex-direction: row;
            align-items: end;
            gap: 8px;
        }

        .filters-row .form-label.small {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        /* Botões de Ação (Importar, Exportar, etc.) */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Gráficos */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        /* Metas e Orçamento */
        .goal-progress {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        body.dark-mode .goal-progress {
            background: #404040;
        }

        .progress-bar {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #e9ecef;
        }

        body.dark-mode .progress-bar {
            background: #555;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        body.dark-mode .filters-section {
            background: #2d2d2d;
            color: white;
        }

        /* Paginação */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        /* Layout do Conteiner de Analise Financeira Detalhada */
        .analysis-details-content {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-top: -5px;
        }

        body.dark-mode .analysis-details-content {
            background-color: #3a3a3a;
        }

        /* =================================================================== */
        /* 3. LISTA DE TRANSAÇÕES (Desktop)
            /* =================================================================== */

        .list-group-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        .list-group-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .list-group-item.selected {
            background-color: #e9ecef;
        }

        body.dark-mode .list-group-item.selected {
            background-color: #3a3a3a;
        }

        /* Por padrão, nenhum elemento da linha encolhe */
        .list-group-item>* {
            flex-shrink: 0;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: -5px;
        }

        .status-pending {
            background-color: #ffc107;
            /* Amarelo */
            border: 1px solid #b38600;
        }

        .status-caixa {
            background-color: #28a745;
            /* Verde */
            border: 1px solid #1c6c32;
        }

        .status-pago,
        .status-reconciled {
            background-color: #0d6efd;
            /* Azul */
            border: 1px solid #0a58ca;
        }

        .transaction-data {
            font-weight: bold;
            font-size: 0.9rem;
            width: 90px;
        }

        /* O único elemento que pode crescer e deve encolher */
        .transaction-details {
            flex: 1 1 0;
            min-width: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: calc(100% - 350px);
            /* Reserva espaço para outros elementos */
        }

        .transaction-name,
        .transaction-type-sub {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .transaction-name {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .transaction-type-sub {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
        }

        body.dark-mode .transaction-type-sub {
            color: #adb5bd;
        }

        .id-btn {
            background-color: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .transaction-value-positive,
        .transaction-value-negative {
            font-weight: bold;
            width: 110px;
            text-align: right;
            font-size: 0.95rem;
        }

        .transaction-value-positive {
            color: #28a745;
        }

        .transaction-value-negative {
            color: #dc3545;
        }

        .category-select {
            min-width: 130px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* =================================================================== */
        /* 4. COMPONENTES FLUTUANTES (Botão de Tema, FAB, Modal, Nav Bar)
            /* =================================================================== */

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            /* ... */
        }

        .fab {
            position: fixed;
            bottom: 85px;
            right: 25px;
            z-index: 1050;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            font-size: 28px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* #########################################################################################*/
        /*				CSS PARA OS MODAIS					    */
        /* #########################################################################################*/

/* Garante que modais apareçam corretamente */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    display: none; /* Padrão: escondido */
    justify-content: center;
    align-items: center;
    z-index: 1055;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

/* Quando o modal está visível */
.modal-backdrop[style*="display: flex"] {
    display: flex !important;
}

.modal-backdrop.visible {
    opacity: 1;
}

.modal-dialog {
    max-width: 500px;
    width: 95%;
    transform: scale(0.95);
    transition: transform 0.2s ease-in-out;
    z-index: 1056;
}

.modal-backdrop.visible .modal-dialog {
    transform: scale(1);
}


        .modal-content {
            background-color: #ffffff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            /* Garante que o conteúdo respeite as bordas arredondadas */
        }

        .modal-header {
            background-color: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.2rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            background-color: #f8f9fa;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Modais com scroll para conteúdos grandes */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-dialog.modal-scrollable .modal-body {
            max-height: 60vh;
        }

        /* Estilos para a lista de conciliação */
        .reconciliation-list {
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }

        body.dark-mode .reconciliation-list {
            border-color: #495057;
        }

        .reconciliation-list .list-group-item {
            cursor: pointer;
        }

        .reconciliation-list .list-group-item.selected {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0a58ca !important;
        }

        /* --- Estilos Dark Mode para Modais --- */
        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }

        body.dark-mode .modal-header,
        body.dark-mode .modal-footer {
            background-color: #343a40;
            border-color: #495057;
        }

        /* GERENCIADOR DE CATEGORIAS*/
        .category-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        body.dark-mode .category-manager-item {
            border-bottom-color: #404040;
        }

        .category-manager-item:last-child {
            border-bottom: none;
        }

        .page-content {
            padding-bottom: 80px;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1040;
        }

        body.dark-mode .nav-bar {
            background-color: #2d2d2d;
        }

        .nav-button {
            background: none;
            border: none;
            color: #6c757d;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 12px;
        }

        body.dark-mode .nav-button {
            color: #adb5bd;
        }

        .nav-button.active {
            color: #0d6efd;
            font-weight: bold;
        }

        body.dark-mode .nav-button.active {
            color: #58a6ff;
        }

        .nav-icon {
            font-size: 24px;
        }

        /* Indicador visual de scroll em modais */
        .modal-body::after {
            content: '';
            position: sticky;
            bottom: 0;
            display: block;
            height: 20px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.1), transparent);
            pointer-events: none;
        }

        body.dark-mode .modal-body::after {
            background: linear-gradient(to top, rgba(255, 255, 255, 0.1), transparent);
        }


        /* ############################## Abas de Análise ############################## */


        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 2px solid transparent;
            background: none;
            padding: 10px 15px;
            cursor: pointer;
        }

        .nav-tabs .nav-link:hover {
            border-color: transparent;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom-color: #0d6efd;
            background-color: transparent;
            font-weight: 600;
        }

        body.dark-mode .nav-tabs .nav-link {
            color: #adb5bd;
        }

        body.dark-mode .nav-tabs .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .nav-tabs .nav-link.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        /* Dashboard Executivo */
        .dashboard-executivo .card {
            transition: transform 0.2s ease;
        }

        .dashboard-executivo .card:hover {
            transform: translateY(-2px);
        }

        /* Relatório Comparativo */
        .table th {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .table td {
            font-size: 0.85rem;
        }

        body.dark-mode .table {
            color: #e0e0e0;
        }

        body.dark-mode .table th {
            border-color: #404040;
        }

        body.dark-mode .table td {
            border-color: #404040;
        }

        body.dark-mode .table-striped>tbody>tr:nth-of-type(odd)>td {
            background-color: rgba(255, 255, 255, 0.05);
        }


        /* =================================================================== */
        /* 5. RESPONSIVIDADE (Telas Pequenas / Mobile)*/
        /* =================================================================== */


        @media (max-width: 768px) {
            .nav-button {
                padding: 12px 8px;
                min-height: 60px;
            }

            .nav-icon {
                font-size: 28px;
                /* Aumentado de 24px */
            }

            /* Ajusta posição do FAB */
            .fab {
                bottom: 95px;
                /* Aumentado de 85px */
                right: 20px;
                width: 56px;
                height: 56px;
            }

            /* Move botão de tema para não sobrepor conteúdo */
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 44px;
                height: 44px;
            }

            .list-group-item {
                display: grid;
                grid-template-columns: auto 1fr;
                /* Coluna para ícones/check, Coluna para conteúdo */
                gap: 8px 15px;
                padding: 15px;
                align-items: center;
            }

            /* Linha 1: Itens superiores */
            .status-dot {
                grid-column: 1;
                grid-row: 1;
                align-self: center;
                /* CORREÇÃO: Força o alinhamento ao centro, evitando esticar */
            }

            .transaction-checkbox {
                grid-column: 1;
                grid-row: 2;
                align-self: center;
                /* CORREÇÃO: Força o alinhamento ao centro, evitando esticar */
                width: 24px;
                height: 24px;
                cursor: pointer;
            }

            .transaction-data {
                grid-column: 2;
                grid-row: 1 / span 2;
            }

            /* Linha 3: Descrição */
            .transaction-details {
                grid-column: 1 / -1;
                /* Ocupa a largura total */
                grid-row: 3;
                min-width: 0;
                /* Permite que o texto filho seja truncado */
                margin: 5px 0;
                width: 100%;
                /* ADICIONE esta linha */
                max-width: none;
                /* ADICIONE esta linha - remove a limitação do desktop */
            }

            .transaction-value-positive,
            .transaction-value-negative {
                grid-column: 1;
                grid-row: 4;
                text-align: left;
                font-size: 1.1rem;
                /* Melhora legibilidade de valores */
                font-size: 1.15rem;
                font-weight: 600;
            }

            .id-btn {
                grid-column: 2;
                grid-row: 4;
                justify-self: end;
                /* Alinha o botão à direita */
            }

            .category-select,
            .list-group-item .btn {
                /* Captura o botão de Editar */
                grid-column: 1 / -1;
                /* Ocupa a largura total */
                width: 100%;
                /* Aumenta espaçamento entre itens da lista */
                padding: 18px 12px;
                margin-bottom: 8px;
            }

            .category-select {
                grid-row: 5;
            }

            .list-group-item .btn {
                grid-row: 6;
            }

            /* Botões maiores em modais */
            .modal-footer .btn {
                min-height: 48px;
                font-size: 1rem;
            }

            /* Layout geral para mobile */
            .action-buttons {
                grid-template-columns: 1fr;
                flex-direction: column;
            }

            .filters-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .modal-body {
                max-height: 65vh;
                padding: 1rem;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 1.5rem;
            }

            /* Reduz itens por página no mobile */
            .body[data-mobile="true"] {
                --items-per-page: 20;
            }

            /* Scroll suave e bounce effect (iOS-like) */
            .body {
                -webkit-overflow-scrolling: touch;
            }

            .modal-body {
                -webkit-overflow-scrolling: touch;
            }

            /* Melhora filtros no mobile */
            .filters-row {
                gap: 15px;
            }

            .filters-row>div {
                margin-bottom: 5px;
            }

            /* Labels mais visíveis */
            .form-label {
                font-weight: 600;
                margin-bottom: 8px;
            }

            /* Gráficos responsivos */
            .chart-container {
                height: 250px;
                /* Reduzido de 300px */
            }

            /* Pull-to-refresh visual (apenas estético) */
            .page-content {
                position: relative;
            }

            /* Espaço extra no topo para melhor UX */
            .page-content::before {
                content: '';
                display: block;
                height: 10px;
            }

            /* Tabelas responsivas com scroll horizontal */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 1rem;
            }

            .table-responsive table {
                min-width: 600px;
            }

            /* Indicador de scroll horizontal */
            .table-responsive::after {
                content: '← Deslize para ver mais →';
                display: block;
                text-align: center;
                font-size: 0.75rem;
                color: #6c757d;
                margin-top: -0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        /* Estilo das abas de metas */
        .metas-tab-content {
            min-height: 300px;
        }

        /* Melhorias nos switches de reservas */
        .form-check-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            cursor: pointer;
        }

        /* Cards de objetivos e reservas inativos */
        .opacity-50 {
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .opacity-50:hover {
            opacity: 0.7;
        }

        /* Histórico - destaque dos cards */
        #conteudoHistorico .card-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        body.dark-mode #conteudoHistorico .card-header {
            background-color: #343a40;
        }

        /* Mobile - ajustes para abas de metas */
        @media (max-width: 768px) {
            #metasTabsNav {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #metasTabsNav .nav-item {
                flex-shrink: 0;
            }

            #metasTabsNav .nav-link {
                white-space: nowrap;
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }

/* Botões de ação em objetivos e reservas */
.btn-group .btn-sm {
    min-width: 36px;
    min-height: 36px;
}

@media (max-width: 768px) {
    .btn-group .btn-sm {
        min-width: 44px;
        min-height: 44px;
    }
}

/* Melhora visual dos cards de reservas desativadas */
.card.opacity-50 .form-check-switch {
    opacity: 1;
}

/* Botão de configuração de meta */
.btn-outline-primary:hover {
    transform: translateY(-1px);
    transition: all 0.2s;
}
    </style>
</head>

<body>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Alternar tema">
        🌙
    </button>
    <div class="container">
        <h1 class="text-center my-4">Controle Financeiro Doméstico</h1>
        <div id="page-transactions" class="page-content">
            <div class="summary-cards" id="summaryCards"></div>
            <div class="filters-section">
                <h5>🔍 Filtros e Busca</h5>
                <div class="filters-row">
                    <div>
                        <label class="form-label">Buscar por descrição:</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Ex: Supermercado, iFood..." oninput="debounceSearch()">
                    </div>
                    <div>
                        <label for="statusFilter" class="form-label">Status:</label>
                        <select id="statusFilter" class="form-control" onchange="applyFilters()">
                            <option value="">Todos os Status</option>
                            <option value="caixa">Caixa (Conta Corrente)</option>
                            <option value="pendente">Pendente (Cartão)</option>
                            <option value="pago">Pago (Cartão)</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Filtrar por:</label>
                        <div class="btn-group w-100 mb-2" role="group">
                            <input type="radio" class="btn-check" name="tipoFiltroData" id="filtroMes" checked onchange="alternarTipoFiltroData('mes')">
                            <label class="btn btn-outline-secondary btn-sm" for="filtroMes">Mês</label>
                            <input type="radio" class="btn-check" name="tipoFiltroData" id="filtroPeriodo" onchange="alternarTipoFiltroData('periodo')">
                            <label class="btn btn-outline-secondary btn-sm" for="filtroPeriodo">Período Personalizado</label>
                        </div>
                        <div id="seletorMes">
                            <select id="monthYearFilter" class="form-control" onchange="aplicarFiltroMes()">
                                <option value="">Todos os meses</option>
                            </select>
                        </div>
                        <div id="filtroPeriodoPersonalizado" style="display: none;">
                            <div class="d-flex gap-2">
                                <div><label for="startDateFilter" class="form-label small">De:</label><input type="date" id="startDateFilter" class="form-control" onchange="applyFilters()"></div>
                                <div><label for="endDateFilter" class="form-label small">Até:</label><input type="date" id="endDateFilter" class="form-control" onchange="applyFilters()"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Categoria:</label>
                        <select id="categoryFilter" class="form-control" onchange="applyFilters()">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>
                    <div>
                        <label for="valueOperator" class="form-label">Valor:</label>
                        <div class="d-flex gap-2 align-items-end">
                            <select id="valueOperator" class="form-control" onchange="toggleValueInputs()">
                                <option value="">Qualquer valor</option>
                                <option value="equals">Igual a</option>
                                <option value="greater_than">Maior que</option>
                                <option value="less_than">Menor que</option>
                                <option value="between">Entre</option>
                            </select>
                            <input type="number" inputmode="decimal" id="valueFilter1" class="form-control" placeholder="R$" oninput="debounceSearch()" style="display: none;">
                            <span id="valueSeparator" style="display: none;">e</span>
                            <input type="number" inputmode="decimal" id="valueFilter2" class="form-control" placeholder="R$" oninput="debounceSearch()" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-body">
                    <h5>💳 Transações</h5>
                    <div id="bulkActionContainer" class="d-flex gap-2 align-items-center p-2 mb-2 rounded bg-light" style="display: none;"></div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        <label class="form-check-label" for="selectAllCheckbox">Selecionar todos na página</label>
                    </div>
                    <div class="pagination-controls d-flex justify-content-center align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-primary btn-first" onclick="goToPage(1)">« Primeira</button>
                        <button class="btn btn-sm btn-outline-primary btn-prev" onclick="changePage(-1)">‹ Anterior</button>
                        <span class="page-info fw-bold">Página 1 de 1</span>
                        <button class="btn btn-sm btn-outline-primary btn-next" onclick="changePage(1)">Próxima ›</button>
                        <button class="btn btn-sm btn-outline-primary btn-last" onclick="goToPage('last')">Última »</button>
                    </div>
                    <div id="transactionsContainer">
                        <ul id="transactionList" class="list-group"></ul>
                        <div id="emptyState" class="text-center text-muted p-4" style="display: none;">
                            <p>📋 Nenhuma transação encontrada.</p>
                        </div>
                    </div>
                    <div class="pagination-controls d-flex justify-content-center align-items-center gap-2 mt-3">
                        <button class="btn btn-sm btn-outline-primary btn-first" onclick="goToPage(1)">« Primeira</button>
                        <button class="btn btn-sm btn-outline-primary btn-prev" onclick="changePage(-1)">‹ Anterior</button>
                        <span class="page-info fw-bold">Página 1 de 1</span>
                        <button class="btn btn-sm btn-outline-primary btn-next" onclick="changePage(1)">Próxima ›</button>
                        <button class="btn btn-sm btn-outline-primary btn-last" onclick="goToPage('last')">Última »</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-analysis" class="page-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Resumo Executivo</h5>
                        <select id="periodoAnalise" class="form-select w-auto" onchange="atualizarAnalises()">
                            <option value="">Selecione o período</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-8" id="dashboardExecutivo"></div>
                        <div class="col-md-4">
                            <h6>Gastos por Categoria</h6>
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5>📈 Evolução Mensal</h5>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5>💰 Tendências Financeiras</h5>
                            <div class="chart-container">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="analysisTabsNav">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" onclick="showAnalysisTab('detalhada')">📈 Análise Detalhada</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" onclick="showAnalysisTab('comparativa')">📊 Comparativo Histórico</a></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div id="analysisTabDetalhada" class="analysis-tab-content">
                        <div id="futureView" class="mb-3"></div>
                        <button class="btn btn-info" onclick="calculateFuture()">🔄 Atualizar Análise</button>
                    </div>
                    <div id="analysisTabComparativa" class="analysis-tab-content" style="display: none;">
                        <div id="comparativeReport"></div>
                        <button class="btn btn-info" onclick="atualizarRelatorioComparativo()">🔄 Atualizar Relatório</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-goals" class="page-content" style="display: none;">
            <!-- Resumo Geral -->
            <div class="row mb-3">
                <div class="col-6 col-md-3">
                    <div class="card text-center">
                        <div class="card-body p-2">
                            <h6 class="mb-1" style="font-size: 0.9rem;">Metas Ativas</h6>
                            <h4 class="mb-0" id="totalMetasAtivas">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body p-2">
                            <h6 class="mb-1" style="font-size: 0.9rem;">Cumpridas</h6>
                            <h4 class="mb-0" id="totalMetasCumpridas">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card text-center bg-warning text-white">
                        <div class="card-body p-2">
                            <h6 class="mb-1" style="font-size: 0.9rem;">Em Alerta</h6>
                            <h4 class="mb-0" id="totalMetasAlerta">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card text-center bg-danger text-white">
                        <div class="card-body p-2">
                            <h6 class="mb-1" style="font-size: 0.9rem;">Falharam</h6>
                            <h4 class="mb-0" id="totalMetasFalhadas">0</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Abas do Sistema de Metas -->
            <ul class="nav nav-tabs mb-3" id="metasTabsNav">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showMetasTab('mensais')">📊 Metas Mensais</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showMetasTab('objetivos')">🎯 Objetivos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showMetasTab('reservas')">🛡️ Reservas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showMetasTab('historico')">📈 Histórico</a>
                </li>
            </ul>

            <!-- Conteúdo das Abas -->
            <div id="metasTabMensais" class="metas-tab-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>Metas do Mês Atual</h6>
                    <button class="btn btn-success btn-sm" onclick="abrirModalNovaMeta()">+ Nova Meta</button>
                </div>
                <div id="listaMetasMensais"></div>
            </div>

            <div id="metasTabObjetivos" class="metas-tab-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6>Objetivos de Poupança</h6>
                    <button class="btn btn-success btn-sm" onclick="abrirModalNovoObjetivo()">+ Novo Objetivo</button>
                </div>
                <div id="listaObjetivosPoupanca"></div>
            </div>

            <div id="metasTabReservas" class="metas-tab-content" style="display: none;">
                <div class="mb-3">
                    <h6>Sistema de Reservas Financeiras</h6>
                    <p class="text-muted small">Construa sua segurança financeira em 3 pilares</p>
                </div>
                <div id="listaReservasFinanceiras"></div>
            </div>

            <div id="metasTabHistorico" class="metas-tab-content" style="display: none;">
                <div class="mb-3">
                    <label for="seletorMesHistorico" class="form-label">Selecione o mês:</label>
                    <select id="seletorMesHistorico" class="form-select" onchange="renderizarHistoricoMes()">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div id="conteudoHistorico"></div>
            </div>
        </div>
        <div id="page-tools" class="page-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <h5>📁 Importar e Exportar</h5>
                    <div class="mb-3">
                        <input type="file" id="csvFile" accept=".csv" class="form-control mb-2" multiple>
                        <small class="form-text text-muted">Selecione um ou mais arquivos de Conta Corrente e/ou Fatura de Cartão.</small>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="processSelectedFiles()">📥 Processar Arquivos</button>
                        <button class="btn btn-info" onclick="exportData()">📤 Exportar CSV</button>
                        <button class="btn btn-outline-success" onclick="exportBackup()">💾 Backup Completo</button>
                        <button class="btn btn-outline-warning" onclick="importBackup()">📂 Restaurar Backup</button>
                        <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="processBackupFile()">
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="planningTabsNav">
                        <li class="nav-item"><a class="nav-link active" onclick="showPlanningTab('orcamento')">💰 Orçamento Base Zero</a></li>
                        <li class="nav-item"><a class="nav-link" onclick="showPlanningTab('outros')">⚙️ Outras Ferramentas</a></li>
                    </ul>
                </div>
                <div class="card-body">
                    <div id="planningTabOrcamento" class="planning-tab-content">
                        <div id="orcamentoBaseZeroView"></div>
                    </div>
                    <div id="planningTabObjetivos" class="planning-tab-content" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Seus Objetivos de Longo Prazo</h6>
                            <button class="btn btn-success btn-sm" onclick="criarObjetivoLongoPrazo()">+ Novo Objetivo</button>
                        </div>
                        <div id="objetivosLongoPrazoView"></div>
                    </div>
                    <div id="planningTabReservas" class="planning-tab-content" style="display: none;">
                        <div class="mb-3">
                            <h6>Sistema de Reservas Financeiras</h6>
                            <p class="text-muted small">Mantenha diferentes tipos de reserva para diferentes propósitos</p>
                        </div>
                        <div id="sistemaReservasView"></div>
                    </div>
                    <div id="planningTabOutros" class="planning-tab-content" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Inteligência Artificial</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="criarRegraCategorizacao()">🤖 Criar Regra de Categorização</button>
                                    <button class="btn btn-outline-info" onclick="gerenciarRegras()">⚙️ Gerenciar Regras</button>
                                    <button class="btn btn-outline-success" onclick="abrirAnaliseComportamental()">🧠 Análise Comportamental</button>
                                    <button class="btn btn-outline-warning" onclick="abrirSimuladorEse()">🎲 Simulador "E Se"</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Conciliação</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-info" onclick="openManualReconciliationModal()" id="reconcileBtn">🔗 Conciliação Manual</button>
                                    <button class="btn btn-outline-warning" onclick="gerenciarConciliacao()">🔄 Gerenciar Conciliação</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Gestão</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" onclick="manageCategoriesModal()">🏷️ Gerenciar Categorias</button>
                                    <button class="btn btn-outline-danger" onclick="clearAllData()">🗑️ Limpar Tudo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="nav-bar">
        <button class="nav-button active" onclick="showPage('page-transactions', this)"><span class="nav-icon">💳</span><span class="nav-text">Transações</span></button>
        <button class="nav-button" onclick="showPage('page-analysis', this)"><span class="nav-icon">📊</span><span class="nav-text">Análise</span></button>
        <button class="nav-button" onclick="showPage('page-goals', this)"><span class="nav-icon">🎯</span><span class="nav-text">Metas</span></button>
        <button class="nav-button" onclick="showPage('page-tools', this)"><span class="nav-icon">⚙️</span><span class="nav-text">Ferramentas</span></button>
    </nav>
    <div class="modal-backdrop" id="manualEntryModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">⭐ Novo Lançamento</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTransactionId">
                    <div class="mb-3">
                        <label for="modalDate" class="form-label">Data</label>
                        <input type="date" id="modalDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="modalName" class="form-label">Descrição</label>
                        <input type="text" id="modalName" class="form-control" placeholder="Ex: Almoço, Uber...">
                    </div>
                    <div class="mb-3">
                        <label for="modalValue" class="form-label">Valor (R$)</label>
                        <input type="number" inputmode="decimal" id="modalValue" class="form-control" placeholder="Ex: 25.50">
                    </div>
                    <div class="mb-3">
                        <label for="modalCategory" class="form-label">Categoria</label>
                        <select id="modalCategory" class="form-control" onchange="handleGenericCategoryChange(this)"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop" id="categoryModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🏷️ Gerenciar Categorias</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Aqui você pode excluir categorias personalizadas. As transações associadas serão movidas para "Não classificada".</p>
                    <div id="categoryManagerList" style="max-height: 40vh; overflow-y: auto;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop" id="addCategoryModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🏷️ Adicionar Nova Categoria</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
<div class="modal-body">
    <div class="mb-3">
        <label for="newCategoryName" class="form-label">Nome da Categoria</label>
        <input type="text" id="newCategoryName" class="form-control" placeholder="Ex: Lazer, Educação, Investimentos...">
    </div>
    
    <div class="mb-3">
        <label for="newCategoryClassificacao" class="form-label">Classificação (para análise 50/30/20)</label>
        <select id="newCategoryClassificacao" class="form-control">
            <option value="necessidades">💡 Necessidades (50%) - Essencial para viver</option>
            <option value="desejos">🎉 Desejos (30%) - Melhora qualidade de vida</option>
            <option value="poupanca">💰 Poupança (20%) - Investimentos e reservas</option>
        </select>
        <small class="text-muted">Esta classificação ajuda na análise financeira 50/30/20</small>
    </div>
    
    <p class="text-muted small mt-2">
        Tente criar categorias genéricas que agrupem bem seus gastos.
    </p>
</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewCategory()">Salvar Categoria</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop" id="manualReconciliationModal" style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">🔗 Conciliação Manual de Lançamentos</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Selecione um lançamento manual da lista à esquerda e o seu correspondente importado da lista à direita para conciliá-los.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Lançamentos Manuais Pendentes</h6>
                            <div id="manualPendingList" class="list-group reconciliation-list">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Lançamentos Importados (Cartão)</h6>
                            <div id="importedUnreconciledList" class="list-group reconciliation-list">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Fechar</button>
                    <button type="button" class="btn btn-primary" id="executeReconciliationBtn" onclick="executeManualReconciliation()" disabled>Conciliar Selecionados</button>
                </div>
            </div>
        </div>
    </div>
<div class="modal-backdrop" id="editReserveModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editReserveModalTitle">Editar Meta</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editReserveModalType">
                    <div class="mb-3">
                        <label for="editReserveModalValue" class="form-label" id="editReserveModalLabel">Novo Valor</label>
                        <input type="number" inputmode="decimal" id="editReserveModalValue" class="form-control" step="0.01" min="0">
                        <small id="editReserveModalHelp" class="form-text text-muted"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarMetaReserva()">Salvar Meta</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal-backdrop" id="editarMetaMensalModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">✏️ Editar Meta Mensal</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editMetaId">
                    <div class="mb-3">
                        <label for="editMetaNome" class="form-label">Nome da Meta</label>
                        <input type="text" id="editMetaNome" class="form-control">
                    </div>
                    <div id="camposEspecificosEditMeta">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoMeta()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>
    <button class="fab" onclick="openAddModal()" title="Adicionar novo lançamento">+</button>
    <script>
        // =================constantes gerais da aplicação =====================//
        let transactions = [];
        let filteredTransactions = [];
        let categories = ["Comida", "Transporte", "Outros"];
        let goals = {}; // Substituir por estrutura mais complexa
        let smartGoals = []; // Nova estrutura de metas
        let currentPage = 1;
        let itemsPerPage = 40;
        let searchTimeout;
        let monthlyBudget = 0;
        let isReconciliationMode = false;
        let categoryAddCallback = null;
        let selectedManualId = null;
        let selectedImportedId = null;
        // Classificação de categorias para análise 50/30/20
        let classificacaoCategorias = {
            necessidades: [], // 50%
            desejos: [], // 30%
            poupanca: []  // 20%
        };

function salvarClassificacaoCategorias() {
    localStorage.setItem('classificacaoCategorias', JSON.stringify(classificacaoCategorias));
}

function carregarClassificacaoCategorias() {
    const saved = localStorage.getItem('classificacaoCategorias');
    if (saved) {
        classificacaoCategorias = JSON.parse(saved);
    } else {
        // Classificação padrão inicial
        classificacaoCategorias = {
            necessidades: ['Habitação', 'Alimentação', 'Transporte', 'Saúde', 'Comida'],
            desejos: ['Lazer', 'Entretenimento', 'Restaurantes'],
            poupanca: []
        };
        
        // Adiciona categorias de poupança automaticamente
        objetivosPoupanca.forEach(obj => {
            const cat = `Poupança: ${obj.nome}`;
            if (!classificacaoCategorias.poupanca.includes(cat)) {
                classificacaoCategorias.poupanca.push(cat);
            }
        });
        
        Object.values(reservasFinanceiras).forEach(res => {
            if (!classificacaoCategorias.poupanca.includes(res.nome)) {
                classificacaoCategorias.poupanca.push(res.nome);
            }
        });
        
        salvarClassificacaoCategorias();
    }
}

function getClassificacaoCategoria(categoria) {
    if (classificacaoCategorias.necessidades.includes(categoria)) return 'necessidades';
    if (classificacaoCategorias.desejos.includes(categoria)) return 'desejos';
    if (classificacaoCategorias.poupanca.includes(categoria)) return 'poupanca';
    return 'necessidades'; // Padrão
}


        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function saveGoals() {
            localStorage.setItem('goals', JSON.stringify(goals));
        }

        function loadGoals() {
            const savedGoals = localStorage.getItem('goals');
            if (savedGoals) {
                goals = JSON.parse(savedGoals);
            }
        }

        // ===================================================================
        // FUNÇÕES AUXILIARES PARA ANÁLISE TEMPORAL E MÉTRICAS
        // ===================================================================

        function getTransactionsFromLastMonths(months) {
            const now = new Date();
            const cutoffDate = new Date(now.getFullYear(), now.getMonth() - months, 1);

            return transactions.filter(t => {
                if (!t.data) return false;
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionDate = new Date(year, month - 1, day);
                return transactionDate >= cutoffDate;
            });
        }

        function getTransactionsByMonth(transactionList = transactions) {
            const monthlyData = {};

            transactionList.forEach(t => {
                if (!t.data) return;
                const [day, month, year] = t.data.split('/').map(Number);
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        income: 0,
                        expenses: 0,
                        transactions: []
                    };
                }

                monthlyData[monthKey].transactions.push(t);

                if (t.valor > 0) {
                    monthlyData[monthKey].income += t.valor;
                } else if (t.valor < 0 && t.tipo !== 'Pagamento de Fatura') {
                    monthlyData[monthKey].expenses += Math.abs(t.valor);
                }

                monthlyData[monthKey].transactions.push(t);
            });

            return monthlyData;
        }

        function calculateMonthlyBurnRate(transactionList) {
            const monthlyData = getTransactionsByMonth(transactionList);
            const monthlyExpenses = Object.values(monthlyData).map(month => month.expenses);

            if (monthlyExpenses.length === 0) return 0;

            const totalExpenses = monthlyExpenses.reduce((sum, expense) => sum + expense, 0);
            return totalExpenses / monthlyExpenses.length;
        }

        function calculateSavingsRate(transactionList) {
            const monthlyData = getTransactionsByMonth(transactionList);
            const months = Object.values(monthlyData);

            if (months.length === 0) return 0;

            let totalSavings = 0;
            let totalIncome = 0;

            months.forEach(month => {
                const monthSavings = month.income - month.expenses;
                totalSavings += monthSavings;
                totalIncome += month.income;
            });

            return totalIncome > 0 ? (totalSavings / totalIncome) * 100 : 0;
        }

        function calculateVolatility(transactionList) {
            const monthlyData = getTransactionsByMonth(transactionList);
            const monthlyExpenses = Object.values(monthlyData).map(month => month.expenses);

            if (monthlyExpenses.length < 2) return 0;

            const average = monthlyExpenses.reduce((sum, expense) => sum + expense, 0) / monthlyExpenses.length;
            const variance = monthlyExpenses.reduce((sum, expense) => sum + Math.pow(expense - average, 2), 0) / monthlyExpenses.length;

            return Math.sqrt(variance);
        }

        function analyzeCategoryTrends(months = 3) {
            const recentTransactions = getTransactionsFromLastMonths(months);
            const olderTransactions = getTransactionsFromLastMonths(months * 2).filter(t =>
                !recentTransactions.some(rt => rt.identificador === t.identificador)
            );

            const recentByCategory = {};
            const olderByCategory = {};

            // Calcular gastos por categoria nos períodos recente e anterior
            recentTransactions.forEach(t => {
                if (t.valor < 0) {
                    recentByCategory[t.categoria] = (recentByCategory[t.categoria] || 0) + Math.abs(t.valor);
                }
            });

            olderTransactions.forEach(t => {
                if (t.valor < 0) {
                    olderByCategory[t.categoria] = (olderByCategory[t.categoria] || 0) + Math.abs(t.valor);
                }
            });

            const trends = {};

            [...new Set([...Object.keys(recentByCategory), ...Object.keys(olderByCategory)])].forEach(category => {
                const recent = recentByCategory[category] || 0;
                const older = olderByCategory[category] || 0;

                if (older > 0) {
                    const percentChange = ((recent - older) / older) * 100;
                    trends[category] = {
                        recent: recent,
                        older: older,
                        change: percentChange,
                        direction: percentChange > 5 ? 'aumentando' : percentChange < -5 ? 'diminuindo' : 'estável'
                    };
                }
            });

            return trends;
        }

        // ===================================================================
        // SISTEMA INTELIGENTE DE METAS
        // ===================================================================

        const TIPOS_META = {
            ORCAMENTO_CATEGORIA: 'orcamento_categoria',
            ECONOMIA_MENSAL: 'economia_mensal',
            REDUCAO_GASTO: 'reducao_gasto',
            OBJETIVO_COMPRA: 'objetivo_compra',
            RESERVA_EMERGENCIA: 'reserva_emergencia'
        };

        const STATUS_META = {
            ATIVA: 'ativa',
            CUMPRIDA: 'cumprida',
            FALHADA: 'falhada',
            PAUSADA: 'pausada'
        };

        function criarNovaMeta(tipo, dados) {
            const meta = {
                id: `meta-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                tipo: tipo,
                nome: dados.nome,
                valor: dados.valor,
                categoria: dados.categoria || null,
                dataInicio: dados.dataInicio || new Date().toISOString().split('T')[0],
                dataFim: dados.dataFim || null,
                status: STATUS_META.ATIVA,
                progresso: 0,
                alertas: {
                    50: false, // 50% do limite
                    80: false, // 80% do limite
                    100: false // 100% do limite
                },
                historico: [],
                criadaEm: new Date().toISOString()
            };

            // Configurações específicas por tipo de meta
            switch (tipo) {
                case TIPOS_META.ORCAMENTO_CATEGORIA:
                    meta.descricao = `Não gastar mais que ${dados.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} em ${dados.categoria}`;
                    break;
                case TIPOS_META.ECONOMIA_MENSAL:
                    meta.descricao = `Economizar ${dados.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} por mês`;
                    break;
                case TIPOS_META.REDUCAO_GASTO:
                    meta.percentualReducao = dados.percentualReducao || 10;
                    meta.descricao = `Reduzir gastos em ${dados.categoria} em ${dados.percentualReducao}%`;
                    break;
                case TIPOS_META.OBJETIVO_COMPRA:
                    meta.descricao = `Juntar ${dados.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} para ${dados.nome}`;
                    meta.valorJuntado = 0;
                    break;
                case TIPOS_META.RESERVA_EMERGENCIA:
                    meta.mesesReserva = dados.mesesReserva || 6;
                    meta.descricao = `Criar reserva de emergência de ${dados.mesesReserva} meses`;
                    break;
            }

            return meta;
        }

        function adicionarMeta(meta) {
            smartGoals.push(meta);
            salvarMetas();
            atualizarProgressoTodasMetas();
        }

        function salvarMetas() {
            localStorage.setItem('smartGoals', JSON.stringify(smartGoals));
            // Manter compatibilidade com sistema antigo
            localStorage.setItem('goals', JSON.stringify(goals));
        }

        function carregarMetas() {
            const metasSalvas = localStorage.getItem('smartGoals');
            if (metasSalvas) {
                smartGoals = JSON.parse(metasSalvas);
            }

            // Carrega metas antigas para compatibilidade
            const savedGoals = localStorage.getItem('goals');
            if (savedGoals) {
                goals = JSON.parse(savedGoals);
                migrarMetasAntigas();
            }
        }

        function migrarMetasAntigas() {
            Object.entries(goals).forEach(([categoria, valor]) => {
                // Verifica se já existe uma meta equivalente
                const metaExistente = smartGoals.find(m =>
                    m.tipo === TIPOS_META.ORCAMENTO_CATEGORIA &&
                    m.categoria === categoria
                );

                if (!metaExistente) {
                    const metaAntiga = criarNovaMeta(TIPOS_META.ORCAMENTO_CATEGORIA, {
                        nome: `Orçamento ${categoria}`,
                        valor: valor,
                        categoria: categoria
                    });
                    smartGoals.push(metaAntiga);
                }
            });

            if (Object.keys(goals).length > 0) {
                salvarMetas();
            }
        }

        function atualizarProgressoTodasMetas() {
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Atualiza apenas metas mensais
            metasMensais.forEach(meta => {
                if (meta.status !== STATUS_META.ATIVA && meta.status !== STATUS_META.FALHADA) return;

                const progressoAnterior = meta.progresso;

                switch (meta.tipo) {
                    case TIPOS_META.ORCAMENTO_CATEGORIA:
                        atualizarProgressoOrcamento(meta, mesAtual);
                        break;
                    case TIPOS_META.REDUCAO_GASTO:
                        atualizarProgressoReducao(meta);
                        break;
                }

                // Verifica alertas
                verificarAlertas(meta, progressoAnterior);
            });

            // Atualiza objetivos e reservas
            atualizarObjetivosEReservas();

            salvarTodosSistemas();
        }

        function atualizarProgressoOrcamento(meta, mesAtual) {
            const gastosCategoria = filteredTransactions
                .filter(t => {
                    if (t.categoria !== meta.categoria || t.valor >= 0) return false;
                    const [day, month, year] = t.data.split('/').map(Number);
                    const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                    return transactionMonth === mesAtual;
                })
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            meta.progresso = meta.valor > 0 ? (gastosCategoria / meta.valor) * 100 : 0;
            meta.valorAtual = gastosCategoria;

            // Atualiza status
            if (meta.progresso >= 100) {
                meta.status = STATUS_META.FALHADA;
            }
        }

        function atualizarProgressoEconomia(meta, mesAtual) {
            const transacoesMes = filteredTransactions.filter(t => {
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesAtual;
            });

            const receitas = transacoesMes.filter(t => t.valor > 0).reduce((sum, t) => sum + t.valor, 0);
            const gastos = transacoesMes.filter(t => t.valor < 0).reduce((sum, t) => sum + Math.abs(t.valor), 0);
            const economia = receitas - gastos;

            meta.progresso = meta.valor > 0 ? Math.max(0, (economia / meta.valor) * 100) : 0;
            meta.valorAtual = economia;

            if (meta.progresso >= 100) {
                meta.status = STATUS_META.CUMPRIDA;
            }
        }

        function atualizarProgressoReducao(meta) {
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Mês passado
            const dataAnterior = new Date(agora.getFullYear(), agora.getMonth() - 1, 1);
            const mesPassado = `${dataAnterior.getFullYear()}-${String(dataAnterior.getMonth() + 1).padStart(2, '0')}`;

            // Busca gastos do mês passado na categoria
            const gastosPassado = transactions
                .filter(t => {
                    if (!t.categoria || t.categoria !== meta.categoria || t.valor >= 0) return false;
                    const [day, month, year] = t.data.split('/').map(Number);
                    const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                    return transactionMonth === mesPassado;
                })
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            // Gastos do mês atual
            const gastosAtual = transactions
                .filter(t => {
                    if (!t.categoria || t.categoria !== meta.categoria || t.valor >= 0) return false;
                    const [day, month, year] = t.data.split('/').map(Number);
                    const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                    return transactionMonth === mesAtual;
                })
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            // Se não há gastos no mês passado, usa o valor informado pelo usuário como base
            const valorBase = gastosPassado > 0 ? gastosPassado : meta.valor;

            // Calcula meta de redução
            const metaGasto = valorBase * (1 - meta.percentualReducao / 100);

            // Atualiza a meta com os valores
            meta.valorBase = valorBase;
            meta.valorMeta = metaGasto;
            meta.valorAtual = gastosAtual;

            // Calcula progresso (quanto menor o gasto, maior o progresso)
// 1. O progresso agora representa o quanto do novo orçamento foi consumido.
            meta.progresso = metaGasto > 0 ? (gastosAtual / metaGasto) * 100 : 0;

            // 2. O status é simplificado: se passar de 100%, falhou. Senão, está ativa.
            // A meta só é "cumprida" de fato no final do mês se não tiver falhado.
            if (meta.progresso >= 100) {
                meta.status = STATUS_META.FALHADA;
            } else {
                meta.status = STATUS_META.ATIVA;
            }

meta.descricao = `Reduzir gastos em ${meta.categoria} em ${meta.percentualReducao}% (de ${valorBase.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} para ${metaGasto.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})`;
        }

        function atualizarProgressoObjetivo(meta) {
            // Para objetivos de compra, o progresso é manual ou baseado em economia
            const economiaMensal = calcularEconomiaMensal();
            if (economiaMensal > 0 && meta.dataFim) {
                const mesesRestantes = calcularMesesRestantes(meta.dataFim);
                const necessarioPorMes = (meta.valor - meta.valorJuntado) / mesesRestantes;
                meta.progresso = mesesRestantes > 0 ? Math.min(100, (economiaMensal / necessarioPorMes) * 100) : 100;
            } else {
                meta.progresso = meta.valor > 0 ? (meta.valorJuntado / meta.valor) * 100 : 0;
            }
        }

        function atualizarProgressoReserva(meta) {
            const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
            const saldoAtual = transactions
                .filter(t => t.tipoLancamento === 'conta')
                .reduce((sum, t) => sum + t.valor, 0);

            const reservaNecessaria = burnRate * meta.mesesReserva;
            meta.progresso = reservaNecessaria > 0 ? (saldoAtual / reservaNecessaria) * 100 : 0;
            meta.valorAtual = saldoAtual;
            meta.valorNecessario = reservaNecessaria;

            if (meta.progresso >= 100) {
                meta.status = STATUS_META.CUMPRIDA;
            }
        }

        function verificarAlertas(meta, progressoAnterior) {
            const alertasDisparo = [50, 80, 100];

            alertasDisparo.forEach(limite => {
                if (!meta.alertas[limite] && meta.progresso >= limite && progressoAnterior < limite) {
                    meta.alertas[limite] = true;

                    let mensagem = '';
                    if (limite === 50) {
                        mensagem = `⚠️ Alerta: Você atingiu 50% da meta "${meta.nome}"`;
                    } else if (limite === 80) {
                        mensagem = `🚨 Atenção: Você atingiu 80% da meta "${meta.nome}"`;
                    } else if (limite === 100) {
                        if (meta.tipo === TIPOS_META.ORCAMENTO_CATEGORIA) {
                            mensagem = `🔴 Orçamento estourado! Meta "${meta.nome}" ultrapassou 100%`;
                        } else {
                            mensagem = `🎉 Parabéns! Você atingiu a meta "${meta.nome}"`;
                        }
                    }

                    // Armazena alerta para exibir posteriormente
                    if (!window.alertasMetas) window.alertasMetas = [];
                    window.alertasMetas.push({
                        meta: meta.nome,
                        mensagem: mensagem,
                        timestamp: new Date().toISOString()
                    });
                }
            });
        }

        function calcularEconomiaMensal() {
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            const transacoesMes = transactions.filter(t => {
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesAtual;
            });

            const receitas = transacoesMes.filter(t => t.valor > 0).reduce((sum, t) => sum + t.valor, 0);
            const gastos = transacoesMes.filter(t => t.valor < 0).reduce((sum, t) => sum + Math.abs(t.valor), 0);

            return receitas - gastos;
        }

        function calcularMesesRestantes(dataFim) {
            const fim = new Date(dataFim);
            const agora = new Date();

            const diffTime = fim - agora;
            const diffMonths = Math.ceil(diffTime / (1000 * 60 * 60 * 24 * 30));

            return Math.max(0, diffMonths);
        }


        // ===================================================================
        // INTERFACE DO SISTEMA DE METAS
        // ===================================================================

        function atualizarFormularioMeta() {
            const tipo = document.getElementById('tipoMeta').value;
            const container = document.getElementById('camposEspecificos');

            container.innerHTML = '';

            switch (tipo) {
                case 'orcamento_categoria':
                    container.innerHTML = `
                           <div class="col-md-6">
                               <label for="categoriaMeta" class="form-label">Categoria:</label>
                               <select id="categoriaMeta" class="form-control">
                                   <option value="">Selecione categoria</option>
                                   ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                               </select>
                           </div>
                       `;
                    break;

                case 'reducao_gasto':
                    container.innerHTML = `
                           <div class="col-md-4">
                               <label for="categoriaMeta" class="form-label">Categoria:</label>
                               <select id="categoriaMeta" class="form-control">
                                   <option value="">Selecione categoria</option>
                                   ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                               </select>
                           </div>
                           <div class="col-md-4">
                               <label for="percentualReducao" class="form-label">Redução (%):</label>
                               <input type="number" inputmode="decimal" inputmode="decimal" id="percentualReducao" class="form-control" value="10" min="1" max="100">
                           </div>
                       `;
                    break;

                case 'objetivo_compra':
                    container.innerHTML = `
                           <div class="col-md-6">
                               <label for="dataLimite" class="form-label">Data Limite:</label>
                               <input type="date" id="dataLimite" class="form-control">
                           </div>
                       `;
                    break;

                case 'reserva_emergencia':
                    container.innerHTML = `
                           <div class="col-md-6">
                               <label for="mesesReserva" class="form-label">Meses de Reserva:</label>
                               <input type="number" inputmode="decimal" inputmode="decimal" id="mesesReserva" class="form-control" value="6" min="1" max="24">
                           </div>
                       `;
                    break;
            }
        }

        function criarMetaPersonalizada() {
            const tipo = document.getElementById('tipoMeta').value;
            const nome = document.getElementById('nomeMeta').value.trim();
            const valor = parseFloat(document.getElementById('valorMeta').value);

            if (!tipo || !nome || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }

            const dados = {
                nome: nome,
                valor: valor
            };

            // Campos específicos por tipo
            switch (tipo) {
                case 'orcamento_categoria':
                case 'reducao_gasto':
                    const categoria = document.getElementById('categoriaMeta')?.value;
                    if (!categoria) {
                        alert('Selecione uma categoria.');
                        return;
                    }
                    dados.categoria = categoria;
                    if (tipo === 'reducao_gasto') {
                        dados.percentualReducao = parseInt(document.getElementById('percentualReducao').value) || 10;
                    }
                    break;

                case 'objetivo_compra':
                    const dataLimite = document.getElementById('dataLimite')?.value;
                    if (dataLimite) {
                        dados.dataFim = dataLimite;
                    }
                    break;

                case 'reserva_emergencia':
                    dados.mesesReserva = parseInt(document.getElementById('mesesReserva').value) || 6;
                    break;
            }

            const novaMeta = criarNovaMeta(tipo, dados);
            adicionarMeta(novaMeta);

            // Limpar formulário
            document.getElementById('tipoMeta').value = '';
            document.getElementById('nomeMeta').value = '';
            document.getElementById('valorMeta').value = '';
            document.getElementById('camposEspecificos').innerHTML = '';

            atualizarVisualizacaoMetas();
            alert(`Meta "${nome}" criada com sucesso!`);
        }

        function sugerirMetasInteligentes() {
            const last3Months = getTransactionsFromLastMonths(3);
            const monthlyExpenses = getTransactionsByMonth(last3Months);
            const burnRate = calculateMonthlyBurnRate(last3Months);
            const savingsRate = calculateSavingsRate(last3Months);

            let sugestoes = [];

            // Sugestão de orçamento baseado no histórico
            const expensesByCategory = {};
            last3Months.forEach(t => {
                if (t.valor < 0) {
                    expensesByCategory[t.categoria] = (expensesByCategory[t.categoria] || 0) + Math.abs(t.valor);
                }
            });

            Object.entries(expensesByCategory).forEach(([categoria, total]) => {
                const media = total / 3;
                const orcamentoSugerido = Math.round(media * 0.9); // 10% de redução

                if (orcamentoSugerido > 100) {
                    sugestoes.push({
                        tipo: 'Orçamento por Categoria',
                        descricao: `Orçamento de R$ ${orcamentoSugerido.toFixed(2)} para ${categoria}`,
                        categoria: categoria,
                        valor: orcamentoSugerido,
                        tipoMeta: 'orcamento_categoria'
                    });
                }
            });

            // Sugestão de economia mensal
            if (savingsRate > 0) {
                const economiaAtual = burnRate * (savingsRate / 100);
                const metaEconomia = Math.round(economiaAtual * 1.2); // 20% a mais

                sugestoes.push({
                    tipo: 'Economia Mensal',
                    descricao: `Meta de economizar R$ ${metaEconomia.toFixed(2)} por mês`,
                    valor: metaEconomia,
                    tipoMeta: 'economia_mensal'
                });
            }

            // Sugestão de reserva de emergência
            const reservaNecessaria = Math.round(burnRate * 6);
            sugestoes.push({
                tipo: 'Reserva de Emergência',
                descricao: `Criar reserva de 6 meses (R$ ${reservaNecessaria.toFixed(2)})`,
                valor: reservaNecessaria,
                tipoMeta: 'reserva_emergencia',
                mesesReserva: 6
            });

            // Mostrar sugestões
            if (sugestoes.length > 0) {
                const opcoes = sugestoes.map(sug => `${sug.tipo}: ${sug.descricao}`);

                mostrarModalSelecao(
                    'Sugestões de Metas Inteligentes',
                    'Selecione uma meta para criar automaticamente:',
                    opcoes,
                    (indice) => {
                        const sugestao = sugestoes[indice];
                        const dados = {
                            nome: sugestao.tipo,
                            valor: sugestao.valor,
                            categoria: sugestao.categoria,
                            mesesReserva: sugestao.mesesReserva
                        };

                        const novaMeta = criarNovaMeta(sugestao.tipoMeta, dados);
                        adicionarMeta(novaMeta);
                        atualizarVisualizacaoMetas();
                        alert(`Meta "${dados.nome}" criada automaticamente!`);
                    }
                );
            } else {
                alert('Não foi possível gerar sugestões. Importe mais dados financeiros primeiro.');
            }
        }

        function atualizarVisualizacaoMetas() {
            atualizarProgressoTodasMetas();
            atualizarResumoMetas();

            // Renderiza aba ativa
            const abaAtiva = document.querySelector('#metasTabsNav .nav-link.active');
            if (abaAtiva) {
                const texto = abaAtiva.textContent.toLowerCase();
                if (texto.includes('mensais')) renderizarMetasMensais();
                else if (texto.includes('objetivos')) renderizarObjetivosPoupanca();
                else if (texto.includes('reservas')) renderizarReservasFinanceiras();
                else if (texto.includes('histórico')) renderizarHistoricoMes();
            } else {
                // Padrão: renderiza metas mensais
                renderizarMetasMensais();
            }

            exibirAlertas();
        }

        function atualizarResumoMetas() {
            const ativas = smartGoals.filter(m => m.status === STATUS_META.ATIVA).length;
            const cumpridas = smartGoals.filter(m => m.status === STATUS_META.CUMPRIDA).length;
            const alerta = smartGoals.filter(m => m.status === STATUS_META.ATIVA && m.progresso >= 80).length;
            const falhadas = smartGoals.filter(m => m.status === STATUS_META.FALHADA).length;

            document.getElementById('totalMetas').textContent = ativas;
            document.getElementById('metasCumpridas').textContent = cumpridas;
            document.getElementById('metasAlerta').textContent = alerta;
            document.getElementById('metasFalhadas').textContent = falhadas;
        }

        function renderizarListaMetas() {
            const container = document.getElementById('listaMetasInteligentes');
            if (!container) return;

            if (smartGoals.length === 0) {
                // Se não há metas, chama a nova função para renderizar as ações sugeridas.
                container.innerHTML = renderProximasAcoes();
                return;
            }

            let html = '';

            smartGoals.forEach(meta => {
                const corProgresso = getCorProgresso(meta);
                const iconeStatus = getIconeStatus(meta);

                html += `
                       <div class="card mb-3">
                           <div class="card-body">
                               <div class="d-flex justify-content-between align-items-start mb-2">
                                   <div>
                                       <h6>${iconeStatus} ${meta.nome}</h6>
                                       <small class="text-muted">${meta.descricao}</small>
                                   </div>
                                   <div class="text-end">
                                       <small class="badge bg-${getCorStatus(meta.status)}">${getTextStatus(meta.status)}</small>
                                   </div>
                               </div>
                               
                               <div class="progress mb-2" style="height: 20px;">
                                   <div class="progress-bar bg-${corProgresso}" 
                                        style="width: ${Math.min(meta.progresso, 100)}%"
                                        role="progressbar">
                                       ${meta.progresso.toFixed(1)}%
                                   </div>
                               </div>
                               
                               <div class="d-flex justify-content-between align-items-center">
                                   <div>
                                       ${getDetalhesMeta(meta)}
                                   </div>
                                   <div class="btn-group">
                                       <button class="btn btn-sm btn-outline-secondary" onclick="abrirModalEditarMeta('${meta.id}')">Editar</button>
                                       <button class="btn btn-sm btn-outline-danger" onclick="excluirMeta('${meta.id}')">Excluir</button>
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
            });

            container.innerHTML = html;
        }

        // ===================================================================
        // DASHBOARD EXECUTIVO E RELATÓRIOS AUTOMÁTICOS			      
        // ===================================================================

        function gerarDashboardExecutivo() {
            const periodoSelecionado = document.getElementById('periodoAnalise')?.value;
            const agora = new Date();

            // Variáveis de data declaradas aqui <<<
            let dataAtual, mesAtual, mesPassado, mesPassadoKey;

            if (periodoSelecionado) {
                const [year, month] = periodoSelecionado.split('-').map(Number);
                dataAtual = new Date(year, month - 1, 1);
                mesAtual = periodoSelecionado;

                // Cria a data do mês passado e armazena na variável correta
                mesPassado = new Date(year, month - 2, 1);
                mesPassadoKey = `${mesPassado.getFullYear()}-${String(mesPassado.getMonth() + 1).padStart(2, '0')}`;
            } else {
                dataAtual = agora;
                mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

                // Cria a data do mês passado e armazena na variável correta
                mesPassado = new Date(agora.getFullYear(), agora.getMonth() - 1, 1);
                mesPassadoKey = `${mesPassado.getFullYear()}-${String(mesPassado.getMonth() + 1).padStart(2, '0')}`;
            }

            // Dados do mês atual
            const transacoesMesAtual = transactions.filter(t => {
                if (!t.data) return false;
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesAtual;
            });

            // Dados do mês passado
            const transacoesMesPassado = transactions.filter(t => {
                if (!t.data) return false;
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesPassadoKey;
            });

            const resumoMesAtual = calcularResumoMensal(transacoesMesAtual);
            const resumoMesPassado = calcularResumoMensal(transacoesMesPassado);

            const comparativo = calcularComparativoMensal(resumoMesAtual, resumoMesPassado);
            const alertasCriticos = identificarAlertasCriticos();
            const proximasAcoes = sugerirProximasAcoes(resumoMesAtual, comparativo);

            return {
                resumoAtual: resumoMesAtual,
                resumoPassado: resumoMesPassado,
                comparativo: comparativo,
                alertas: alertasCriticos,
                acoes: proximasAcoes,
                // Usando as variáveis de data para formatação <<<
                mesAtual: dataAtual.toLocaleDateString('pt-BR', {
                    month: 'long',
                    year: 'numeric'
                }),
                mesPassado: mesPassado.toLocaleDateString('pt-BR', {
                    month: 'long',
                    year: 'numeric'
                })
            };
        }

        function calcularResumoMensal(transacoesMes) {
            const receitas = transacoesMes
                .filter(t => t.valor > 0)
                .reduce((sum, t) => sum + t.valor, 0);

            // >>> CORREÇÃO APLICADA AQUI <<<
            // Adicionamos a condição para excluir 'Pagamento de Fatura'
            const gastos = transacoesMes
                .filter(t => t.valor < 0 && t.tipo !== 'Pagamento de Fatura')
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            const economia = receitas - gastos;

            // Gastos por categoria (com a mesma correção)
            const gastosPorCategoria = {};
            transacoesMes
                .filter(t => t.valor < 0 && t.tipo !== 'Pagamento de Fatura')
                .forEach(t => {
                    gastosPorCategoria[t.categoria] = (gastosPorCategoria[t.categoria] || 0) + Math.abs(t.valor);
                });

            const categoriaTop = Object.entries(gastosPorCategoria)
                .sort((a, b) => b[1] - a[1])[0] || ['Nenhuma', 0];

            return {
                receitas,
                gastos,
                economia,
                gastosPorCategoria,
                categoriaTop: {
                    nome: categoriaTop[0],
                    valor: categoriaTop[1]
                },
                transacoes: transacoesMes.length
            };
        }

        function calcularComparativoMensal(atual, passado) {
            const calcularVariacao = (valorAtual, valorPassado) => {
                if (valorPassado === 0) return valorAtual > 0 ? 100 : 0;
                return ((valorAtual - valorPassado) / valorPassado) * 100;
            };

            return {
                receitas: {
                    variacao: calcularVariacao(atual.receitas, passado.receitas),
                    diferenca: atual.receitas - passado.receitas
                },
                gastos: {
                    variacao: calcularVariacao(atual.gastos, passado.gastos),
                    diferenca: atual.gastos - passado.gastos
                },
                economia: {
                    variacao: calcularVariacao(atual.economia, passado.economia),
                    diferenca: atual.economia - passado.economia
                }
            };
        }

        function identificarAlertasCriticos() {
            const alertas = [];
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Alerta 1: Gastos muito acima da média
            const last3Months = getTransactionsFromLastMonths(3);
            const mediaGastos = calculateMonthlyBurnRate(last3Months);
            const gastosAtual = transactions.filter(t => {
                if (t.valor >= 0) return false;
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesAtual;
            }).reduce((sum, t) => sum + Math.abs(t.valor), 0);

            if (gastosAtual > mediaGastos * 1.3) {
                alertas.push({
                    tipo: 'critico',
                    icone: '🚨',
                    titulo: 'Gastos Elevados',
                    descricao: `Seus gastos estão 30% acima da média dos últimos 3 meses`,
                    valor: gastosAtual - mediaGastos
                });
            }

            // Alerta 2: Faturas pendentes altas
            const faturaPendente = transactions
                .filter(t => t.status === 'pendente')
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            if (faturaPendente > mediaGastos) {
                alertas.push({
                    tipo: 'aviso',
                    icone: '⚠️',
                    titulo: 'Fatura Alta',
                    descricao: `Fatura pendente acima da média mensal de gastos`,
                    valor: faturaPendente
                });
            }

            // Alerta 3: Metas sendo estouradas
            const metasEmRisco = smartGoals.filter(m =>
                m.status === 'ativa' &&
                m.tipo === 'orcamento_categoria' &&
                m.progresso >= 80
            );

            if (metasEmRisco.length > 0) {
                alertas.push({
                    tipo: 'aviso',
                    icone: '🎯',
                    titulo: 'Metas em Risco',
                    descricao: `${metasEmRisco.length} meta(s) próxima(s) do limite`,
                    detalhes: metasEmRisco.map(m => `${m.nome}: ${m.progresso.toFixed(1)}%`)
                });
            }

            return alertas;
        }

        function sugerirProximasAcoes(resumoAtual, comparativo) {
            const acoes = [];

            // Ação 1: Se gastos aumentaram muito
            if (comparativo.gastos.variacao > 20) {
                acoes.push({
                    prioridade: 'alta',
                    icone: '💡',
                    titulo: 'Revisar Gastos',
                    descricao: 'Identifique onde os gastos aumentaram mais este mês',
                    acao: 'Analise a aba de gráficos por categoria'
                });
            }

            // Ação 2: Se economia está negativa
            if (resumoAtual.economia < 0) {
                acoes.push({
                    prioridade: 'critica',
                    icone: '💰',
                    titulo: 'Controlar Gastos',
                    descricao: 'Você gastou mais do que ganhou este mês',
                    acao: 'Defina metas de orçamento mais restritivas'
                });
            }

            // Ação 3: Se não tem metas definidas
            if (smartGoals.filter(m => m.status === 'ativa').length === 0) {
                acoes.push({
                    prioridade: 'media',
                    icone: '🎯',
                    titulo: 'Definir Metas',
                    descricao: 'Estabeleça metas para melhor controle financeiro',
                    acao: 'Use as sugestões automáticas na aba Metas'
                });
            }

            // Ação 4: Se economia melhorou
            if (comparativo.economia.variacao > 10 && resumoAtual.economia > 0) {
                acoes.push({
                    prioridade: 'positiva',
                    icone: '🎉',
                    titulo: 'Parabéns!',
                    descricao: 'Sua economia melhorou comparado ao mês passado',
                    acao: 'Considere aumentar suas metas de poupança'
                });
            }

            return acoes;
        }

        function renderDashboardExecutivo() {
            const dashboard = gerarDashboardExecutivo();

            return `
                           <div class="dashboard-executivo">
                               <div class="row mb-4">
                                   <div class="col-12">
                                       <h5>📊 Resumo Executivo - ${dashboard.mesAtual}</h5>
                                       <small class="text-muted">Comparativo com ${dashboard.mesPassado}</small>
                                   </div>
                               </div>
                               
                               <div class="row mb-4">
                                   <div class="col-md-4">
                                       <div class="card h-100">
                                           <div class="card-body text-center">
                                               <h6 class="card-title">💰 Receitas</h6>
                                               <h4 class="text-success">${dashboard.resumoAtual.receitas.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</h4>
                                               <small class="${dashboard.comparativo.receitas.variacao >= 0 ? 'text-success' : 'text-danger'}">
                                                   ${dashboard.comparativo.receitas.variacao >= 0 ? '↗️' : '↘️'} 
                                                   ${Math.abs(dashboard.comparativo.receitas.variacao).toFixed(1)}% vs mês anterior
                                               </small>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="col-md-4">
                                       <div class="card h-100">
                                           <div class="card-body text-center">
                                               <h6 class="card-title">💸 Gastos</h6>
                                               <h4 class="text-danger">${dashboard.resumoAtual.gastos.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</h4>
                                               <small class="${dashboard.comparativo.gastos.variacao <= 0 ? 'text-success' : 'text-danger'}">
                                                   ${dashboard.comparativo.gastos.variacao >= 0 ? '↗️' : '↘️'} 
                                                   ${Math.abs(dashboard.comparativo.gastos.variacao).toFixed(1)}% vs mês anterior
                                               </small>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="col-md-4">
                                       <div class="card h-100">
                                           <div class="card-body text-center">
                                               <h6 class="card-title">💵 Economia</h6>
                                               <h4 class="${dashboard.resumoAtual.economia >= 0 ? 'text-success' : 'text-danger'}">
                                                   ${dashboard.resumoAtual.economia.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                               </h4>
                                               <small class="${dashboard.comparativo.economia.variacao >= 0 ? 'text-success' : 'text-danger'}">
                                                   ${dashboard.comparativo.economia.variacao >= 0 ? '↗️' : '↘️'} 
                                                   ${Math.abs(dashboard.comparativo.economia.variacao).toFixed(1)}% vs mês anterior
                                               </small>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                               
                               <div class="row mb-4">
                                   <div class="col-md-6">
                                       <div class="card h-100">
                                           <div class="card-body">
                                               <h6 class="card-title">📈 Insights do Mês</h6>
                                               <ul class="list-unstyled">
                                                   <li><strong>Categoria com mais gastos:</strong> ${dashboard.resumoAtual.categoriaTop.nome} 
                                                       (${dashboard.resumoAtual.categoriaTop.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})</li>
                                                   <li><strong>Total de transações:</strong> ${dashboard.resumoAtual.transacoes}</li>
                                                   <li><strong>Taxa de Poupança:</strong> ${dashboard.resumoAtual.receitas > 0 ? ((dashboard.resumoAtual.economia / dashboard.resumoAtual.receitas) * 100).toFixed(1) : 0}%</li>
                                               </ul>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="col-md-6">
                                       <div class="card h-100">
                                           <div class="card-body">
                                               <h6 class="card-title">🚨 Alertas Críticos</h6>
                                               ${dashboard.alertas.length > 0 ? 
                                                   dashboard.alertas.map(alerta => `
                                                       <div class="alert alert-${alerta.tipo === 'critico' ? 'danger' : 'warning'} py-2 mb-2">
                                                           <small>${alerta.icone} <strong>${alerta.titulo}:</strong> ${alerta.descricao}</small>
                                                       </div>
                                                   `).join('') 
                                                   : '<p class="text-muted">✅ Tudo sob controle!</p>'
                                               }
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       `;
        }


        function renderProximasAcoes() {
            // Esta função precisa dos mesmos dados que o dashboard para gerar as ações
            const resumoMesAtual = calcularResumoMensal(getTransactionsFromLastMonths(0));
            const resumoMesPassado = calcularResumoMensal(getTransactionsFromLastMonths(1));
            const comparativo = calcularComparativoMensal(resumoMesAtual, resumoMesPassado);
            const acoes = sugerirProximasAcoes(resumoMesAtual, comparativo);

            if (acoes.length === 0) return ''; // Retorna vazio se não houver ações a sugerir

            // Gera o HTML do componente
            return `
                           <div class="card mt-4 border-info">
                               <div class="card-body">
                                   <h6 class="card-title text-info-emphasis">🎯 Que tal começar por aqui?</h6>
                                   <p class="text-muted small">Sem metas ativas, aqui estão algumas sugestões baseadas na sua análise financeira.</p>
                                   <div class="row">
                                       ${acoes.map(acao => `
                                           <div class="col-md-6 mb-2">
                                               <div class="border rounded p-3 h-100">
                                                   <h6>${acao.icone} ${acao.titulo}</h6>
                                                   <p class="mb-1 small">${acao.descricao}</p>
                                                   <button class="btn btn-sm btn-link p-0" onclick="${acao.funcao_onclick}">${acao.acao}</button>
                                               </div>
                                           </div>
                                       `).join('')}
                                   </div>
                               </div>
                           </div>
                       `;
        }


        function gerarRelatorioComparativo() {
            const ultimosSeisMeses = [];
            const agora = new Date();

            // Gera dados dos últimos 6 meses
            for (let i = 5; i >= 0; i--) {
                const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
                const mesKey = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;

                const transacoesMes = transactions.filter(t => {
                    const [day, month, year] = t.data.split('/').map(Number);
                    const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                    return transactionMonth === mesKey;
                });

                const resumo = calcularResumoMensal(transacoesMes);

                ultimosSeisMeses.push({
                    mes: data.toLocaleDateString('pt-BR', {
                        month: 'short',
                        year: '2-digit'
                    }),
                    mesCompleto: data.toLocaleDateString('pt-BR', {
                        month: 'long',
                        year: 'numeric'
                    }),
                    data: data,
                    ...resumo
                });
            }

            // Calcula médias e tendências
            const medias = {
                receitas: ultimosSeisMeses.reduce((sum, m) => sum + m.receitas, 0) / ultimosSeisMeses.length,
                gastos: ultimosSeisMeses.reduce((sum, m) => sum + m.gastos, 0) / ultimosSeisMeses.length,
                economia: ultimosSeisMeses.reduce((sum, m) => sum + m.economia, 0) / ultimosSeisMeses.length
            };

            // Identifica tendências
            const tendencias = identificarTendenciasHistoricas(ultimosSeisMeses);

            return {
                meses: ultimosSeisMeses,
                medias: medias,
                tendencias: tendencias
            };
        }

        function identificarTendenciasHistoricas(meses) {
            const tendencias = [];

            // Tendência de gastos (últimos 3 vs primeiros 3 meses)
            const primeiros3 = meses.slice(0, 3);
            const ultimos3 = meses.slice(3, 6);

            const mediaInicial = primeiros3.reduce((sum, m) => sum + m.gastos, 0) / 3;
            const mediaRecente = ultimos3.reduce((sum, m) => sum + m.gastos, 0) / 3;
            const variacaoGastos = ((mediaRecente - mediaInicial) / mediaInicial) * 100;

            if (Math.abs(variacaoGastos) > 10) {
                tendencias.push({
                    tipo: variacaoGastos > 0 ? 'alta' : 'baixa',
                    categoria: 'gastos',
                    descricao: `Gastos ${variacaoGastos > 0 ? 'aumentaram' : 'diminuíram'} ${Math.abs(variacaoGastos).toFixed(1)}% nos últimos 3 meses`,
                    variacao: variacaoGastos
                });
            }

            // Tendência de poupança
            const economiaRecente = ultimos3.reduce((sum, m) => sum + m.economia, 0) / 3;
            const economiaInicial = primeiros3.reduce((sum, m) => sum + m.economia, 0) / 3;

            if (economiaInicial !== 0) {
                const variacaoEconomia = ((economiaRecente - economiaInicial) / Math.abs(economiaInicial)) * 100;

                if (Math.abs(variacaoEconomia) > 15) {
                    tendencias.push({
                        tipo: variacaoEconomia > 0 ? 'melhora' : 'piora',
                        categoria: 'economia',
                        descricao: `Capacidade de poupança ${variacaoEconomia > 0 ? 'melhorou' : 'piorou'} ${Math.abs(variacaoEconomia).toFixed(1)}%`,
                        variacao: variacaoEconomia
                    });
                }
            }

            // Volatilidade dos gastos
            const volatilidade = calcularVolatilidadeGastos(meses);
            if (volatilidade > 0.3) {
                tendencias.push({
                    tipo: 'volatil',
                    categoria: 'estabilidade',
                    descricao: `Gastos mensais apresentam alta variabilidade (${(volatilidade * 100).toFixed(1)}%)`,
                    variacao: volatilidade
                });
            }

            return tendencias;
        }

        function calcularVolatilidadeGastos(meses) {
            const gastos = meses.map(m => m.gastos);
            const media = gastos.reduce((sum, g) => sum + g, 0) / gastos.length;
            const variancia = gastos.reduce((sum, g) => sum + Math.pow(g - media, 2), 0) / gastos.length;
            const desvioPadrao = Math.sqrt(variancia);

            return media > 0 ? desvioPadrao / media : 0;
        }

        function renderRelatorioComparativo() {
            const relatorio = gerarRelatorioComparativo();

            return `
                   <div class="relatorio-comparativo">
                       <h5>📊 Relatório dos Últimos 6 Meses</h5>
                       
                       <!-- Tabela Comparativa -->
                       <div class="table-responsive mb-4">
                           <table class="table table-striped">
                               <thead>
                                   <tr>
                                       <th>Mês</th>
                                       <th>Receitas</th>
                                       <th>Gastos</th>
                                       <th>Economia</th>
                                       <th>Categoria Top</th>
                                   </tr>
                               </thead>
                               <tbody>
                                   ${relatorio.meses.map(mes => `
                                       <tr>
                                           <td><strong>${mes.mesCompleto}</strong></td>
                                           <td class="text-success">${mes.receitas.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                                           <td class="text-danger">${mes.gastos.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                                           <td class="${mes.economia >= 0 ? 'text-success' : 'text-danger'}">
                                               ${mes.economia.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                           </td>
                                           <td>${mes.categoriaTop.nome}</td>
                                       </tr>
                                   `).join('')}
                               </tbody>
                               <tfoot>
                                   <tr class="table-info">
                                       <td><strong>Média</strong></td>
                                       <td class="text-success"><strong>${relatorio.medias.receitas.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></td>
                                       <td class="text-danger"><strong>${relatorio.medias.gastos.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></td>
                                       <td class="${relatorio.medias.economia >= 0 ? 'text-success' : 'text-danger'}">
                                           <strong>${relatorio.medias.economia.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong>
                                       </td>
                                       <td>-</td>
                                   </tr>
                               </tfoot>
                           </table>
                       </div>
                       
                       <!-- Análise de Tendências -->
                       ${relatorio.tendencias.length > 0 ? `
                       <div class="card">
                           <div class="card-body">
                               <h6>📈 Análise de Tendências</h6>
                               ${relatorio.tendencias.map(tendencia => `
                                   <div class="alert alert-${
                                       tendencia.tipo === 'alta' || tendencia.tipo === 'piora' ? 'warning' : 
                                       tendencia.tipo === 'baixa' || tendencia.tipo === 'melhora' ? 'success' : 'info'
                                   } py-2 mb-2">
                                       <small>
                                           ${tendencia.categoria === 'gastos' ? '💸' : 
                                             tendencia.categoria === 'economia' ? '💰' : '📊'} 
                                           ${tendencia.descricao}
                                       </small>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                       ` : ''}
                   </div>
               `;
        }

        function showAnalysisTab(tabName) {
            // Esconde todas as abas
            document.querySelectorAll('.analysis-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove classe active de todas as nav-links
            document.querySelectorAll('#analysisTabsNav .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostra a aba selecionada
            const targetTab = document.getElementById(`analysisTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (targetTab) {
                targetTab.style.display = 'block';
            }

            // Adiciona classe active ao link clicado
            event.target.classList.add('active');

            // Carrega conteúdo específico da aba
            if (tabName === 'comparativa') {
                atualizarRelatorioComparativo();
            }
        }

        function atualizarDashboardExecutivo() {
            const container = document.getElementById('dashboardExecutivo');
            if (container) {
                container.innerHTML = renderDashboardExecutivo();
            }
        }

        function atualizarRelatorioComparativo() {
            const container = document.getElementById('comparativeReport');
            if (container) {
                container.innerHTML = renderRelatorioComparativo();
            }
        }

        // Atualizar a função showPage para incluir o dashboard
        function mostrarPaginaAnalise() {
            popularSeletorAnalise();
            renderCharts();
            atualizarDashboardExecutivo();
            atualizarRelatorioComparativo();
        }

        function getCorProgresso(meta) {
            if (meta.tipo === TIPOS_META.ORCAMENTO_CATEGORIA) {
                // Para orçamento, vermelho = ruim (passou do limite)
                if (meta.progresso >= 100) return 'danger';
                if (meta.progresso >= 80) return 'warning';
                return 'success';
            } else {
                // Para outras metas, verde = bom (perto do objetivo)
                if (meta.progresso >= 80) return 'success';
                if (meta.progresso >= 50) return 'warning';
                return 'danger';
            }
        }

        function getIconeStatus(meta) {
            switch (meta.status) {
                case STATUS_META.ATIVA:
                    return '🎯';
                case STATUS_META.CUMPRIDA:
                    return '✅';
                case STATUS_META.FALHADA:
                    return '❌';
                case STATUS_META.PAUSADA:
                    return '⏸️';
                default:
                    return '🎯';
            }
        }

        function getCorStatus(status) {
            switch (status) {
                case STATUS_META.ATIVA:
                    return 'primary';
                case STATUS_META.CUMPRIDA:
                    return 'success';
                case STATUS_META.FALHADA:
                    return 'danger';
                case STATUS_META.PAUSADA:
                    return 'warning';
                default:
                    return 'secondary';
            }
        }

        function getTextStatus(status) {
            switch (status) {
                case STATUS_META.ATIVA:
                    return 'Ativa';
                case STATUS_META.CUMPRIDA:
                    return 'Cumprida';
                case STATUS_META.FALHADA:
                    return 'Falhada';
                case STATUS_META.PAUSADA:
                    return 'Pausada';
                default:
                    return 'Desconhecido';
            }
        }

        function getDetalhesMeta(meta) {
            let detalhes = '';

            switch (meta.tipo) {
                case TIPOS_META.ORCAMENTO_CATEGORIA:
                    detalhes = `<small>Gastou: R$ ${(meta.valorAtual || 0).toFixed(2)} de R$ ${meta.valor.toFixed(2)}</small>`;
                    break;
                case TIPOS_META.ECONOMIA_MENSAL:
                    detalhes = `<small>Economizado: R$ ${(meta.valorAtual || 0).toFixed(2)} de R$ ${meta.valor.toFixed(2)}</small>`;
                    break;
                case TIPOS_META.REDUCAO_GASTO:
                    detalhes = `<small>Meta: -${meta.percentualReducao}% | Atual: R$ ${(meta.valorAtual || 0).toFixed(2)}</small>`;
                    break;
                case TIPOS_META.OBJETIVO_COMPRA:
                    detalhes = `<small>Juntado: R$ ${(meta.valorJuntado || 0).toFixed(2)} de R$ ${meta.valor.toFixed(2)}</small>`;
                    if (meta.dataFim) {
                        const diasRestantes = calcularMesesRestantes(meta.dataFim) * 30;
                        detalhes += ` | ${diasRestantes} dias restantes`;
                    }
                    break;
                case TIPOS_META.RESERVA_EMERGENCIA:
                    detalhes = `<small>Reserva atual: R$ ${(meta.valorAtual || 0).toFixed(2)} | Meta: R$ ${(meta.valorNecessario || 0).toFixed(2)}</small>`;
                    break;
            }

            return detalhes;
        }

// ===================================================================
        // FUNÇÕES CORRIGIDAS PARA EDITAR E EXCLUIR METAS MENSAIS
        // ===================================================================

function abrirModalEditarMeta(metaId) {
            const meta = metasMensais.find(m => m.id === metaId);
            if (!meta) {
                alert('Erro: meta não encontrada.');
                return;
            }

            // Preenche os campos do modal, que já existe estaticamente no HTML
            document.getElementById('editMetaId').value = meta.id;
            document.getElementById('editMetaNome').value = meta.nome;

            const container = document.getElementById('camposEspecificosEditMeta');
            let html = '';

            if (meta.tipo === 'orcamento_categoria') {
                html = `
                    <div class="mb-3">
                        <label class="form-label">Categoria</label>
                        <input type="text" class="form-control" value="${meta.categoria}" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editMetaValor" class="form-label">Valor Máximo (R$)</label>
                        <input type="number" inputmode="decimal" id="editMetaValor" class="form-control" value="${meta.valor}">
                    </div>
                `;
            } else if (meta.tipo === 'reducao_gasto') {
                html = `
                    <div class="mb-3">
                        <label class="form-label">Categoria</label>
                        <input type="text" class="form-control" value="${meta.categoria}" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editMetaPercentual" class="form-label">Percentual de Redução (%)</label>
                        <input type="number" inputmode="decimal" id="editMetaPercentual" class="form-control" value="${meta.percentualReducao}">
                    </div>
                `;
            }
            container.innerHTML = html;
            
            openModal('editarMetaMensalModal');
        }


        function salvarEdicaoMeta() {
            const metaId = document.getElementById('editMetaId').value;
            const meta = metasMensais.find(m => m.id === metaId);
            if (!meta) return;

            meta.nome = document.getElementById('editMetaNome').value.trim();

            if (meta.tipo === 'orcamento_categoria') {
                meta.valor = parseFloat(document.getElementById('editMetaValor').value);
            } else if (meta.tipo === 'reducao_gasto') {
                meta.percentualReducao = parseFloat(document.getElementById('editMetaPercentual').value);
            }

            salvarTodosSistemas();
            atualizarProgressoTodasMetas(); // Recalcula a meta
            renderizarMetasMensais(); // Atualiza a UI
            closeCurrentModal();
            alert('Meta atualizada com sucesso!');
        }

        function excluirMeta(metaId) {
            const meta = metasMensais.find(m => m.id === metaId);
            if (!meta) {
                alert('Erro: Meta não encontrada para exclusão.');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir a meta "${meta.nome}"?`)) {
                metasMensais = metasMensais.filter(m => m.id !== metaId);
                salvarTodosSistemas();
                atualizarVisualizacaoMetas(); // Atualiza resumo e renderiza a lista
                alert(`Meta "${meta.nome}" excluída com sucesso!`);
            }
        }


        function exibirAlertas() {
            const alertas = window.alertasMetas || [];
            const container = document.getElementById('secaoAlertas');
            const alertasContainer = document.getElementById('alertasRecentes');

            // --- INÍCIO DA CORREÇÃO ---
            // Verifica se os elementos necessários existem na página antes de continuar.
            if (!container || !alertasContainer) {
                return; // Aborta a função silenciosamente se os elementos não forem encontrados.
            }
            // --- FIM DA CORREÇÃO ---

            if (alertas.length > 0) {
                container.style.display = 'block';
                alertasContainer.innerHTML = alertas
                    .slice(-5) // Últimos 5 alertas
                    .map(alerta => `<div class="mb-1">${alerta.mensagem}</div>`)
                    .join('');
            } else {
                container.style.display = 'none';
            }
        }



        function updateCategories() {
            const baseCategories = ["Comida", "Transporte", "Outros"];
            const dynamicCategories = new Set(transactions.map(t => t.categoria));
            categories = [...new Set([...baseCategories, ...dynamicCategories])].filter(Boolean);
        }

        function classify(index, cat) {
            if (transactions[index]) {
                transactions[index].categoria = cat;
                saveTransactions();
                applyFilters(true);
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        }

        function cleanDescription(originalDesc) {
            const desc = originalDesc.trim();
            const pixKeywords = [
                'Transferência recebida pelo Pix',
                'Transferência enviada pelo Pix',
                'Transferência Recebida',
                'Reembolso recebido pelo Pix'
            ];
            const isLongTransaction = pixKeywords.some(keyword => desc.startsWith(keyword));
            if (isLongTransaction) {
                const parts = desc.split(' - ');
                if (parts.length >= 2) {
                    const nome = parts[0].replace('Transferência Recebida:', '').trim();
                    const documento = parts[1].trim();
                    return `${nome} - ${documento}`;
                }
            }
            return desc;
        }

        function toggleTheme() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                toggle.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                toggle.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        function applyFilters(keepPage = false) {

            // --- 1. LER VALORES DE TODOS OS FILTROS ---
            const search = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value; // Novo filtro de status
            const startDateValue = document.getElementById('startDateFilter').value;
            const endDateValue = document.getElementById('endDateFilter').value;
            const valueOperator = document.getElementById('valueOperator').value;
            const value1 = parseFloat(document.getElementById('valueFilter1').value);
            const value2 = parseFloat(document.getElementById('valueFilter2').value);

            // Salva as datas no localStorage para persistência
            localStorage.setItem('savedStartDate', startDateValue);
            localStorage.setItem('savedEndDate', endDateValue);

            // Converte as datas para UTC para uma comparação segura
            const startDate = startDateValue ? new Date(Date.UTC(...startDateValue.split('-').map((n, i) => i === 1 ? n - 1 : n))) : null;
            const endDate = endDateValue ? new Date(Date.UTC(...endDateValue.split('-').map((n, i) => i === 1 ? n - 1 : n), 23, 59, 59)) : null;

            // --- 2. FILTRAR O ARRAY PRINCIPAL DE TRANSAÇÕES ---
            filteredTransactions = transactions.filter(t => {

                // Se a transação for manual E já estiver conciliada, ignore-a sempre.
                if (t.isManual && t.conciliado) {
                    return false;
                }

                // Se for Pagamento de Fatura o filtro ignora a transação
                if (t.tipo === 'Pagamento de Fatura' ||
                    (t.descricaoOriginal && t.descricaoOriginal.toLowerCase().includes('pagamento de fatura'))) {
                    return false;
                }

                // Validação de segurança para a transação
                if (!t.data || !t.nome) return false;

                // Filtro por STATUS (lógica corrigida)
                if (statusFilter) {
                    // Se o filtro for 'pago', queremos incluir também 'reconciled'.
                    if (statusFilter === 'pago') {
                        if (t.status !== 'pago' && t.status !== 'reconciled') {
                            return false;
                        }
                    }
                    // Para outros status, a comparação direta funciona.
                    else {
                        if (t.status !== statusFilter) {
                            return false;
                        }
                    }
                }

                // Filtro por BUSCA DE TEXTO
                if (search && !t.nome.toLowerCase().includes(search) && !t.tipo.toLowerCase().includes(search)) {
                    return false;
                }

                // Filtro por CATEGORIA
                if (categoryFilter && t.categoria !== categoryFilter) {
                    return false;
                }

                // Filtro por PERÍODO DE DATA
                const dateParts = t.data.split('/');
                if (dateParts.length !== 3) return false;
                const [day, month, year] = dateParts.map(Number);
                if (isNaN(day) || isNaN(month) || isNaN(year)) return false;
                const transactionDate = new Date(Date.UTC(year, month - 1, day));
                if (startDate && transactionDate < startDate) return false;
                if (endDate && transactionDate > endDate) return false;

                // Filtro por VALOR
                if (valueOperator && !isNaN(value1)) {
                    switch (valueOperator) {
                        case 'equals':
                            if (t.valor !== value1) return false;
                            break;
                        case 'greater_than':
                            if (t.valor <= value1) return false;
                            break;
                        case 'less_than':
                            if (t.valor >= value1) return false;
                            break;
                        case 'between':
                            if (isNaN(value2) || t.valor < value1 || t.valor > value2) return false;
                            break;
                    }
                }

                // Se passou por todos os filtros, a transação é incluída
                return true;
            });



            // --- 3. ORDENAR E RENDERIZAR O RESULTADO ---
            filteredTransactions.sort((a, b) => {
                const dateA = new Date(a.data.split('/').reverse().join('-'));
                const dateB = new Date(b.data.split('/').reverse().join('-'));
                return dateB - dateA;
            });

            if (!keepPage) {
                currentPage = 1;
            }

            renderTransactions();
            updateSummaryCards();
            renderCharts();
            if (filteredTransactions.length > 0) {
                exibirAlertasInteligentes();
            }

            saveFiltersState(); // <-- ADICIONE ESTA LINHA

        }


function saveFiltersState() {
            const filters = {
                search: document.getElementById('searchInput').value,
                status: document.getElementById('statusFilter').value,
                dateFilterType: tipoFiltroAtivo,
                monthYear: document.getElementById('monthYearFilter').value,
                startDate: document.getElementById('startDateFilter').value,
                endDate: document.getElementById('endDateFilter').value,
                category: document.getElementById('categoryFilter').value,
                valueOperator: document.getElementById('valueOperator').value,
                value1: document.getElementById('valueFilter1').value,
                value2: document.getElementById('valueFilter2').value,
            };
            localStorage.setItem('filtersState', JSON.stringify(filters));
        }

        function loadFiltersState() {
            const savedFilters = JSON.parse(localStorage.getItem('filtersState'));
            if (!savedFilters) return;

            document.getElementById('searchInput').value = savedFilters.search || '';
            document.getElementById('statusFilter').value = savedFilters.status || '';
            document.getElementById('categoryFilter').value = savedFilters.category || '';
            document.getElementById('valueOperator').value = savedFilters.valueOperator || '';
            document.getElementById('valueFilter1').value = savedFilters.value1 || '';
            document.getElementById('valueFilter2').value = savedFilters.value2 || '';
            
            // Lógica para restaurar o tipo de filtro de data
            if (savedFilters.dateFilterType) {
                alternarTipoFiltroData(savedFilters.dateFilterType);
                if (savedFilters.dateFilterType === 'mes') {
                    document.getElementById('monthYearFilter').value = savedFilters.monthYear || '';
                } else {
                    document.getElementById('startDateFilter').value = savedFilters.startDate || '';
                    document.getElementById('endDateFilter').value = savedFilters.endDate || '';
                }
            }
            
            // Atualiza a UI dos inputs de valor (maior que, menor que, etc.)
            toggleValueInputs();
        }


        let tipoFiltroAtivo = 'mes'; // ou 'periodo'

        function alternarTipoFiltroData(tipo) {
            tipoFiltroAtivo = tipo;

            const seletorMes = document.getElementById('seletorMes');
            const filtroPeriodo = document.getElementById('filtroPeriodoPersonalizado');

            if (tipo === 'mes') {
                seletorMes.style.display = 'block';
                filtroPeriodo.style.display = 'none';
                // Limpa filtros de período
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
            } else {
                seletorMes.style.display = 'none';
                filtroPeriodo.style.display = 'block';
                // Limpa filtro de mês
                document.getElementById('monthYearFilter').value = '';
            }

            applyFilters();
            saveFiltersState(); // <-- ADICIONE ESTA LINHA
        }

        function popularSeletorMeses() {
            const select = document.getElementById('monthYearFilter');
            if (!select) return;

            const meses = new Set();

            transactions.forEach(t => {
                if (!t.data) return;
                const [day, month, year] = t.data.split('/').map(Number);
                const mesKey = `${year}-${String(month).padStart(2, '0')}`;
                meses.add(mesKey);
            });

            const mesesOrdenados = Array.from(meses).sort().reverse();

            select.innerHTML = '<option value="">Todos os meses</option>';
            mesesOrdenados.forEach(mesKey => {
                const [year, month] = mesKey.split('-');
                const data = new Date(year, month - 1);
                const option = document.createElement('option');
                option.value = mesKey;
                option.textContent = data.toLocaleDateString('pt-BR', {
                    month: 'long',
                    year: 'numeric'
                });
                select.appendChild(option);
            });
        }

        function popularSeletorAnalise() {
            const select = document.getElementById('periodoAnalise');
            if (!select) return;

            const meses = new Set();
            transactions.forEach(t => {
                if (!t.data) return;
                const [day, month, year] = t.data.split('/').map(Number);
                const mesKey = `${year}-${String(month).padStart(2, '0')}`;
                meses.add(mesKey);
            });

            const mesesOrdenados = Array.from(meses).sort().reverse();

            // Define mês atual como padrão
            const agora = new Date();
            // A lógica para pegar o mês atual.
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            select.innerHTML = '';
            mesesOrdenados.forEach(mesKey => {
                const [year, month] = mesKey.split('-');
                const data = new Date(year, month - 1);
                const option = document.createElement('option');
                option.value = mesKey;
                option.textContent = data.toLocaleDateString('pt-BR', {
                    month: 'long',
                    year: 'numeric'
                });
                if (mesKey === mesAtual) option.selected = true;
                select.appendChild(option);
            });
        }

        function atualizarAnalises() {
            atualizarDashboardExecutivo();
            renderCategoryChart();
        }


        function aplicarFiltroMes() {
            if (tipoFiltroAtivo !== 'mes') return;

            const mesKey = document.getElementById('monthYearFilter').value;

            if (!mesKey) {
                // Limpa filtros
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
            } else {
                const [year, month] = mesKey.split('-');
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);

                document.getElementById('startDateFilter').value = firstDay.toISOString().split('T')[0];
                document.getElementById('endDateFilter').value = lastDay.toISOString().split('T')[0];
            }

            applyFilters();
        }



        // SUBSTITUA ESTA FUNÇÃO COMPLETAMENTE
        function updateSummaryCards() {
            const container = document.getElementById('summaryCards');
            if (!container) return;

            // 1. Card de Receitas
            // Soma todas as transações com valor positivo dentro do período/filtros aplicados.
            const totalReceitas = filteredTransactions
                .filter(t => t.valor > 0)
                .reduce((sum, t) => sum + t.valor, 0);

            // 2. Card de Despesas
            // Soma todas as transações com valor negativo (caixa, pendente, pago),
            // EXCETO os pagamentos de fatura, para evitar duplicação.
            const totalDespesas = filteredTransactions
                .filter(t => t.valor < 0 && !(t.descricaoOriginal && t.descricaoOriginal.toLowerCase().includes('pagamento de fatura')))
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            // 3. Card de Saldo
            // Simplesmente a diferença entre as receitas e despesas filtradas.
            const saldo = totalReceitas - totalDespesas;

            // 4. Card de Faturas Abertas
            // Soma apenas as despesas de cartão com status 'pendente' dentro dos filtros.
            const faturasAbertas = filteredTransactions
                .filter(t => t.status === 'pendente')
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            // Atualiza o HTML dos cards com os novos valores e títulos
            container.innerHTML = `
                           <div class="summary-card income">
                               <h3>${totalReceitas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                               <p>Receitas (no filtro)</p>
                           </div>
                           <div class="summary-card expense">
                               <h3>${totalDespesas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                               <p>Despesas (no filtro)</p>
                           </div>
                           <div class="summary-card balance">
                               <h3>${saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                               <p>Saldo (no filtro)</p>
                           </div>
                           <div class="summary-card budget">
                               <h3>${faturasAbertas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                               <p>Faturas Abertas (no filtro)</p>
                           </div>
                       `;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (direction === 1 && currentPage < totalPages) {
                currentPage++;
            } else if (direction === -1 && currentPage > 1) {
                currentPage--;
            }
            renderTransactions();
        }

        // Função para mostrar a aba selecionada

        function showPage(pageId, clickedButton) {

            // Salva o ID da página atual no localStorage
            localStorage.setItem('activePageId', pageId);
            // Esconde todas as "páginas"
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });

            // Mostra a página selecionada
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) {
                pageToShow.style.display = 'block';
            }

            // Atualiza o estado "ativo" dos botões da barra de navegação
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            // ADICIONA: Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Redesenha o conteúdo específico de cada aba APÓS mostrar a página
            setTimeout(() => {
                if (pageId === 'page-analysis') {
                    mostrarPaginaAnalise();
                }
                if (pageId === 'page-goals') {
                    updateGoalsView(); // Garante que as metas sejam atualizadas
                    atualizarVisualizacaoFerramentas();
                }
            }, 50); // Pequeno delay para garantir que a página esteja visível
        }

        function createTransactionElement(t, originalIndex) {
            const item = document.createElement('li');
            item.classList.add('list-group-item');

            const statusDot = createStatusDot(t);
            const checkbox = createTransactionCheckbox(t.identificador);
            const dataSpan = createDataSpan(t.data);
            const detailsDiv = createDetailsDiv(t);
            const idBtn = createIdButton(t.identificador);
            const valueSpan = createValueSpan(t.valor);
            const categorySelector = createCategorySelector(t.categoria, originalIndex);
            const editButton = createEditButton(t);

            item.append(statusDot, checkbox, dataSpan, detailsDiv, idBtn, valueSpan, categorySelector, editButton);
            return item;
        }

        function createStatusDot(t) {
            const statusDot = document.createElement('span');
            let statusText = 'Lançamento em Conta';
            if (t.status === 'pendente') statusText = 'Pendente (Cartão)';
            if (t.status === 'pago' || t.status === 'reconciled') statusText = 'Fatura Paga (Cartão)';

            statusDot.className = `status-dot status-${t.status || 'caixa'}`;
            statusDot.title = `Status: ${statusText}`;
            return statusDot;
        }

        function createTransactionCheckbox(identificador) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input transaction-checkbox';
            checkbox.dataset.id = identificador;
            checkbox.onchange = () => updateBulkActionContainer();
            return checkbox;
        }

        function createDataSpan(data) {
            const dataSpan = document.createElement('span');
            dataSpan.className = 'transaction-data';
            dataSpan.textContent = data;
            return dataSpan;
        }

        function createDetailsDiv(t) {
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'transaction-details';
            detailsDiv.innerHTML = `
                   <div class="transaction-name" title="${t.nome}">${t.nome}</div>
                   <div class="transaction-type-sub" title="${t.tipo}">${t.tipo}</div>
               `;
            return detailsDiv;
        }

        function createIdButton(identificador) {
            const idBtn = document.createElement('span');
            idBtn.className = 'id-btn';
            idBtn.title = `ID: ${identificador}`;
            idBtn.textContent = '📋';
            idBtn.onclick = () => copyToClipboard(identificador);
            return idBtn;
        }

        function createValueSpan(valor) {
            const valueSpan = document.createElement('span');
            const valueClass = valor >= 0 ? 'transaction-value-positive' : 'transaction-value-negative';
            const valueSign = valor >= 0 ? 'R$ ' : '- R$ ';
            const absValue = Math.abs(valor).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            valueSpan.className = valueClass;
            valueSpan.textContent = `${valueSign}${absValue}`;
            return valueSpan;
        }

        function createEditButton(t) {
            const editButton = document.createElement('button');
            editButton.className = 'btn btn-sm btn-outline-secondary';
            editButton.title = 'Editar esta transação';
            editButton.innerHTML = '✏️';

            if (t.identificador && t.identificador.startsWith('manual-')) {
                editButton.onclick = () => openEditModal(t.identificador);
            } else {
                editButton.disabled = true;
                editButton.title = 'Apenas transações manuais podem ser editadas.';
            }
            return editButton;
        }

        // Função de Renderizar as transações

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            const pageInfoElements = document.querySelectorAll('.page-info');

            if (!list) return;
            list.innerHTML = '';

            if (filteredTransactions.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                pageInfoElements.forEach(el => el.textContent = 'Página 0 de 0');
                updatePaginationButtonsState();
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            pageInfoElements.forEach(el => el.textContent = `Página ${currentPage} de ${totalPages}`);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            pageTransactions.forEach((t) => {
                const originalIndex = transactions.findIndex(orig => orig.identificador === t.identificador);
                const item = createTransactionElement(t, originalIndex);
                list.appendChild(item);
            });

            clearSelection();
            updatePaginationButtonsState();
        }

        function renderCharts() {
            renderCategoryChart();
            renderMonthlyChart();
            renderTrendsChart(); // Nova função
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (Chart.getChart('categoryChart')) {
                Chart.getChart('categoryChart').destroy();
            }

            // --- INÍCIO DA NOVA LÓGICA ---

            // 1. Pega o período selecionado no dashboard (ex: "2023-10")
            const periodoSelecionado = document.getElementById('periodoAnalise')?.value;

            // Se nenhum período for selecionado, não faz nada.
            if (!periodoSelecionado) {
                return;
            }

            // 2. Filtra as transações GERAIS para incluir apenas as do mês selecionado.
            const transacoesDoPeriodo = transactions.filter(t => {

                if (!t.data || t.valor >= 0 || t.tipo === 'Pagamento de Fatura') return false;

                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;

                return transactionMonth === periodoSelecionado;
            });

            // --- FIM DA NOVA LÓGICA ---

            const categoriesData = {};

            // 3. Usa o novo array 'transacoesDoPeriodo' em vez de 'filteredTransactions'
            transacoesDoPeriodo.forEach(t => {
                if (typeof t.valor === 'number' && !isNaN(t.valor) && t.valor < 0) {
                    categoriesData[t.categoria] = (categoriesData[t.categoria] || 0) + Math.abs(t.valor);
                }
            });

            if (Object.keys(categoriesData).length === 0) return;

            const borderColor = document.body.classList.contains('dark-mode') ? '#2d2d2d' : '#fff';
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoriesData),
                    datasets: [{
                        data: Object.values(categoriesData),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#ff6b6b', '#4ecdc4', '#f7786b', '#a4de6c', '#5b5f97', '#b8b5ff'],
                        borderWidth: 1,
                        borderColor: borderColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.chart.getDatasetMeta(0).total;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    const formattedValue = value.toLocaleString('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL'
                                    });
                                    return `${label}: ${formattedValue} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

function renderMonthlyChart() {
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    if (Chart.getChart('monthlyChart')) {
        Chart.getChart('monthlyChart').destroy();
    }
    
    // MUDANÇA: Usa todas as transações, não apenas as filtradas
    const agora = new Date();
    const ultimosMeses = 12;
    
    const monthlyData = {};
    
    // Gera últimos 12 meses
    for (let i = ultimosMeses - 1; i >= 0; i--) {
        const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
        const monthKey = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
        monthlyData[monthKey] = { income: 0, expense: 0 };
    }
    
    // Popula com dados reais
    transactions.forEach(t => {
        if (!t.data) return;
        const dateParts = t.data.split('/');
        if (dateParts.length !== 3) return;

        const monthKey = `${dateParts[2]}-${dateParts[1]}`;
        
        if (monthlyData[monthKey]) {
            if (t.valor > 0) {
                monthlyData[monthKey].income += t.valor;
            } else if (t.valor < 0 && t.tipo !== 'Pagamento de Fatura') {
                monthlyData[monthKey].expense += Math.abs(t.valor);
            }
        }
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    const incomeData = sortedMonths.map(month => monthlyData[month].income);
    const expenseData = sortedMonths.map(month => monthlyData[month].expense);
    
    // Formata labels
    const labels = sortedMonths.map(monthKey => {
        const [year, month] = monthKey.split('-');
        const data = new Date(year, month - 1);
        return data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Receitas',
                data: incomeData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.3,
                fill: true
            }, {
                label: 'Gastos',
                data: expenseData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Últimos 12 Meses'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                context.parsed.y.toLocaleString('pt-BR', {
                                    style: 'currency', 
                                    currency: 'BRL'
                                });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('pt-BR', {
                                style: 'currency',
                                currency: 'BRL',
                                minimumFractionDigits: 0
                            });
                        }
                    }
                }
            }
        }
    });
}

        function renderTrendsChart() {
            const canvas = document.getElementById('trendsChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (Chart.getChart('trendsChart')) {
                Chart.getChart('trendsChart').destroy();
            }

            const last6Months = getTransactionsFromLastMonths(6);
            const monthlyData = getTransactionsByMonth(last6Months);

            const sortedMonths = Object.keys(monthlyData).sort();
            const savingsData = sortedMonths.map(month => {
                const data = monthlyData[month];
                return data.income - data.expenses;
            });

            const burnRateData = sortedMonths.map(month => monthlyData[month].expenses);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        const date = new Date(year, monthNum - 1);
                        return date.toLocaleDateString('pt-BR', {
                            month: 'short',
                            year: '2-digit'
                        });
                    }),
                    datasets: [{
                        label: 'Economia Mensal',
                        data: savingsData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'Gastos Mensais',
                        data: burnRateData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL',
                                        minimumFractionDigits: 0
                                    });
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' +
                                        context.parsed.y.toLocaleString('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        });
                                }
                            }
                        }
                    }
                }
            });
        }

        function setGoal() {
            const category = document.getElementById('goalCategory').value;
            const amount = parseFloat(document.getElementById('goalAmount').value);
            if (!category || isNaN(amount) || amount <= 0) {
                alert('Selecione uma categoria e um valor válido.');
                return;
            }
            goals[category] = amount;
            saveGoals();
            updateGoalsView();
        }

        function updateGoalsView() {
            // Manter compatibilidade com metas antigas
            const container = document.getElementById('goalsView');
            if (container) {
                Object.entries(goals).forEach(([category, goal]) => {
                    const totalSpent = filteredTransactions
                        .filter(t => t.categoria === category && t.valor < 0)
                        .reduce((sum, t) => sum + Math.abs(t.valor), 0);
                    const percentage = goal > 0 ? Math.min((totalSpent / goal) * 100, 100) : 0;
                    const color = percentage > 90 ? '#dc3545' : (percentage > 70 ? '#ffc107' : '#28a745');
                    const goalHtml = `
                           <div class="goal-progress">
                               <div class="d-flex justify-content-between">
                                   <strong>${category}</strong>
                                   <span>R$ ${totalSpent.toFixed(2)} / R$ ${goal.toFixed(2)}</span>
                               </div>
                               <div class="progress-bar mt-2">
                                   <div class="progress-fill" style="width: ${percentage}%; background-color: ${color};"></div>
                               </div>
                           </div>`;
                    container.innerHTML += goalHtml;
                });
            }

            // Atualizar sistema novo
            atualizarVisualizacaoMetas();
        }

        function removeGoal(category) {
            delete goals[category];
            saveGoals();
            updateGoalsView();
        }


        function updateBudgetProgress() {
            monthlyBudget = parseFloat(document.getElementById('budget').value) || 0;
            localStorage.setItem('monthlyBudget', monthlyBudget);
            updateSummaryCards();
        }


        async function processSelectedFiles() {
            const files = document.getElementById('csvFile').files;
            if (files.length === 0) return alert('Nenhum arquivo selecionado.');

            let totalImported = 0;
            let totalSkipped = 0;
            let pagamentosDeFatura = []; // A variável correta, com 's'
            const DIA_FECHAMENTO_FATURA = 4;

            for (const file of files) {
                try {
                    // Tenta parsear com cabeçalho (padrão de fatura de cartão)
                    let result = await new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            transformHeader: h => h.trim().toLowerCase(),
                            complete: resolve,
                            error: reject
                        });
                    });
                    const headers = result.meta.fields;

                    // Lógica para FATURA DE CARTÃO
                    if (headers.includes('date') && headers.includes('title')) {
                        result.data.forEach((row, index) => {
                            if (row.title && row.title.toLowerCase().includes('pagamento recebido')) {
                                totalSkipped++;
                                return;
                            }
                            const amountValue = row.amount || row.amout;
                            if (row.date && row.title && amountValue) {
                                // IDENTFICADOR CONSIDERANDO A LINHA
                                const identificador = `cc-${row.date}-${row.title}-${amountValue}-linha-${index}`;
                                if (!transactions.find(t => t.identificador === identificador)) {
                                    const dateParts = row.date.split('-');
                                    const dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                                    const dataCompra = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                    let dataPagamentoFatura = new Date(dataCompra);
                                    if (dataCompra.getDate() > DIA_FECHAMENTO_FATURA) {
                                        dataPagamentoFatura.setMonth(dataPagamentoFatura.getMonth() + 1);
                                    }
                                    const idFatura = `${dataPagamentoFatura.getFullYear()}-${String(dataPagamentoFatura.getMonth() + 1).padStart(2, '0')}`;
                                    transactions.push({
                                        data: dataFormatada,
                                        valor: -parseFloat(amountValue),
                                        identificador,
                                        tipo: "Compra no Crédito",
                                        nome: cleanDescription(row.title),
                                        categoria: "Não classificada",
                                        tipoLancamento: 'cartao',
                                        status: 'pendente',
                                        idFatura
                                    });
                                    aplicarRegrasAutomaticas(transactions[transactions.length - 1]);
                                    totalImported++;
                                }
                            }
                        });
                        // Lógica para CONTA CORRENTE
                    } else {
                        // Se não for fatura, parseia de novo sem cabeçalho
                        let accountResult = await new Promise((resolve, reject) => {
                            Papa.parse(file, {
                                header: false,
                                skipEmptyLines: true,
                                complete: resolve,
                                error: reject
                            });
                        });
                        accountResult.data.forEach(row => {
                            const [dataStr, valorStr, identificador, descricao] = row;
                            if (dataStr === 'Data' || !identificador) return;
                            if (!transactions.find(t => t.identificador === identificador)) {

                                const isPagamentoFatura = descricao.toLowerCase().includes('pagamento de fatura');

                                const transacaoConta = {
                                    data: dataStr,
                                    valor: parseFloat(valorStr.replace(',', '.')),
                                    identificador: identificador,
                                    // >>> MUDANÇA AQUI: Define o 'tipo' específico se for pagamento de fatura <<<
                                    tipo: isPagamentoFatura ? "Pagamento de Fatura" : "Desconhecido",
                                    nome: cleanDescription(descricao),
                                    categoria: "Não classificada",
                                    tipoLancamento: 'conta',
                                    status: 'caixa',
                                    idFatura: null,
                                    descricaoOriginal: descricao
                                };

                                if (!isPagamentoFatura && transacaoConta.nome.includes(' - ')) {
                                    const partes = transacaoConta.nome.split(' - ');
                                    transacaoConta.tipo = partes[0].trim();
                                    transacaoConta.nome = partes.slice(1).join(' - ').trim();
                                }

                                transactions.push(transacaoConta);
                                totalImported++;

                                if (isPagamentoFatura) {
                                    pagamentosDeFatura.push(transacaoConta);
                                }
                            }
                        });
                    }
                } catch (error) {
                    alert(`Erro ao processar o arquivo "${file.name}": ${error.message}`);
                }
            }

            // Após CADA importação, o sistema agora reavalia TUDO.
            let despesasPagasCount = 0;
            if (pagamentosDeFatura.length > 0) {
                pagamentosDeFatura.forEach(pagamento => {
                    despesasPagasCount += vincularPagamentoFatura(pagamento);
                });
            }
            // 1. Pega TODOS os pagamentos de fatura já existentes no sistema
            const todosOsPagamentos = transactions.filter(t => t.descricaoOriginal && t.descricaoOriginal.toLowerCase().includes('pagamento de fatura'));

            // 2. Tenta vincular cada um deles
            if (todosOsPagamentos.length > 0) {
                todosOsPagamentos.forEach(pagamento => {
                    despesasPagasCount += vincularPagamentoFatura(pagamento);
                });
            }

            if (totalImported > 0 || despesasPagasCount > 0 || totalSkipped > 0) {
                saveTransactions();
                applyFilters();
                let alertMessage = `Processamento concluído!\n- ${totalImported} novas transações importadas.`;
                if (despesasPagasCount > 0) {
                    alertMessage += `\n- ${despesasPagasCount} despesas de cartão foram conciliadas com sucesso.`
                }
                alert(alertMessage);
            } else {
                alert('Nenhuma nova transação encontrada nos arquivos.');
            }

            updateCategories();
            updateFilterCategories();
            updateGoalsView();
            popularSeletorMeses(); // Para garantir que novos meses apareçam

        }

        async function processFileType(file) {
            const result = await new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: h => h.trim().toLowerCase(),
                    complete: resolve,
                    error: reject
                });
            });

            if (result.meta.fields.includes('date') && result.meta.fields.includes('title')) {
                return processCreditCardFile(result.data);
            } else {
                return processAccountFile(file);
            }
        }

        function processCreditCardFile(data) {
            let imported = 0,
                skipped = 0;

            data.forEach(row => {
                if (row.title && row.title.toLowerCase().includes('pagamento recebido')) {
                    skipped++;
                    return;
                }

                const amountValue = row.amount || row.amout;
                if (row.date && row.title && amountValue) {
                    const identificador = `cc-${row.date}-${row.title}-${amountValue}`;
                    if (!transactions.find(t => t.identificador === identificador)) {
                        const dateParts = row.date.split('-');
                        const dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                        const faturaDate = new Date(dateParts.join('-'));
                        const idFatura = `${faturaDate.getFullYear()}-${String(faturaDate.getMonth() + 1).padStart(2, '0')}`;

                        transactions.push({
                            data: dataFormatada,
                            valor: -parseFloat(amountValue),
                            identificador,
                            tipo: "Compra no Crédito",
                            nome: cleanDescription(row.title),
                            categoria: "Não classificada",
                            tipoLancamento: 'cartao',
                            status: 'pendente',
                            idFatura
                        });
                        imported++;
                    }
                }
            });

            return {
                imported,
                skipped,
                pagamentos: []
            };
        }

        async function processAccountFile(file) {
            const result = await new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: false,
                    skipEmptyLines: true,
                    complete: resolve,
                    error: reject
                });
            });

            let imported = 0;
            const pagamentos = [];

            result.data.forEach(row => {
                const [dataStr, valorStr, identificador, descricao] = row;
                if (dataStr === 'Data' || !identificador) return;

                if (!transactions.find(t => t.identificador === identificador)) {
                    const transacaoConta = {
                        data: dataStr,
                        valor: parseFloat(valorStr.replace(',', '.')),
                        identificador,
                        tipo: "Desconhecido",
                        nome: cleanDescription(descricao),
                        categoria: "Não classificada",
                        tipoLancamento: 'conta',
                        status: 'caixa',
                        idFatura: null
                    };

                    if (transacaoConta.nome.includes(' - ')) {
                        const partes = transacaoConta.nome.split(' - ');
                        transacaoConta.tipo = partes[0].trim();
                        transacaoConta.nome = partes.slice(1).join(' - ').trim();
                    }

                    transactions.push(transacaoConta);
                    imported++;

                    if (descricao.toLowerCase().includes('pagamento de fatura')) {
                        pagamentos.push(transacaoConta);
                    }
                }
            });

            return {
                imported,
                skipped: 0,
                pagamentos
            };
        }

        function processarPagamentosFatura(pagamentosDeFatura) {
            let despesasPagasCount = 0;
            pagamentosDeFatura.forEach(pagamento => {
                despesasPagasCount += vincularPagamentoFatura(pagamento);
            });
            return despesasPagasCount;
        }

        function conciliarLancamentosManuais() {
            const manuais = transactions.filter(t => t.isManual && !t.conciliado);
            const importados = transactions.filter(t => !t.isManual && t.tipoLancamento === 'cartao');
            let conciliacoesRealizadas = 0;

            manuais.forEach(manual => {
                // Procura transação importada similar
                const candidatos = importados.filter(imp => {
                    if (imp.conciliadoCom) return false; // Já está conciliado

                    // Mesma data exata
                    const [diaM, mesM, anoM] = manual.data.split('/');
                    const [diaI, mesI, anoI] = imp.data.split('/');
                    if (diaM !== diaI || mesM !== mesI || anoM !== anoI) return false;

                    // Valor idêntico ou muito próximo (diferença de até 1%)
                    const diferenca = Math.abs(Math.abs(manual.valor) - Math.abs(imp.valor));
                    const percentualDiferenca = diferenca / Math.abs(manual.valor);
                    if (percentualDiferenca > 0.01) return false;

                    // LÓGICA CONDICIONAL DE SIMILARIDADE
                    const isExactMatch = (diferenca === 0); // Valor 100% exato
                    const similNome = calcularSimilaridadeInteligente(manual.nome, imp.nome);

                    // Se data e valor são exatos, aceita similaridade menor
                    const thresholdSimilaridade = isExactMatch ? 0.25 : 0.6;

                    return similNome >= thresholdSimilaridade;
                });

                if (candidatos.length === 1) {
                    // Conciliação automática (match único)
                    const importado = candidatos[0];
                    manual.conciliado = true;
                    manual.conciliadoCom = importado.identificador;
                    importado.conciliadoCom = manual.identificador;

                    // Transfere categoria do manual para o importado
                    if (manual.categoria && manual.categoria !== 'Não classificada') {
                        importado.categoria = manual.categoria;
                    }

                    conciliacoesRealizadas++;
                }
            });

            return conciliacoesRealizadas;
        }

        // Função auxiliar de similaridade:

        function calcularSimilaridadeInteligente(manual, importado) {
            const m = manual.toLowerCase().trim();
            const i = importado.toLowerCase().trim();

            // 1. Busca por palavras-chave comuns (mínimo 3 caracteres)
            const palavrasManual = m.split(/\s+/).filter(p => p.length > 2);
            const palavrasImportado = i.split(/\s+/).filter(p => p.length > 2);

            let palavrasComuns = 0;
            palavrasManual.forEach(pm => {
                if (palavrasImportado.some(pi =>
                        pi.includes(pm) || pm.includes(pi) ||
                        calcularLevenshtein(pm, pi) > 0.7
                    )) {
                    palavrasComuns++;
                }
            });

            const similaridadePalavras = palavrasComuns / Math.max(palavrasManual.length, 1);

            // 2. Similaridade geral (Levenshtein)
            const similaridadeGeral = calcularLevenshtein(m, i);

            // 3. Score final híbrido
            return Math.max(similaridadePalavras * 0.7 + similaridadeGeral * 0.3, similaridadeGeral);
        }

        function calcularLevenshtein(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len2 + 1).fill().map(() => Array(len1 + 1).fill(0));

            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;

            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j - 1][i] + 1,
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i - 1] + cost
                    );
                }
            }

            const distance = matrix[len2][len1];
            const maxLen = Math.max(len1, len2);
            return maxLen === 0 ? 1 : (maxLen - distance) / maxLen;
        }

        function calcularLevenshtein(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = Array(len2 + 1).fill().map(() => Array(len1 + 1).fill(0));

            for (let i = 0; i <= len1; i++) matrix[0][i] = i;
            for (let j = 0; j <= len2; j++) matrix[j][0] = j;

            for (let j = 1; j <= len2; j++) {
                for (let i = 1; i <= len1; i++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j - 1][i] + 1,
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i - 1] + cost
                    );
                }
            }

            const distance = matrix[len2][len1];
            const maxLen = Math.max(len1, len2);
            return maxLen === 0 ? 1 : (maxLen - distance) / maxLen;
        }

        // SUBSTITUA ESTA FUNÇÃO COMPLETAMENTE

        function updateFilterCategories() {
            // Encontra todos os seletores de categoria na página
            const select = document.getElementById('categoryFilter');
            const goalSelect = document.getElementById('goalCategory');
            const bulkSelect = document.getElementById('bulkCategorySelect'); // Pode não existir no momento da chamada
            const modalSelect = document.getElementById('modalCategory');

            const sortedCategories = [...new Set(categories)].sort();
            const createOption = (cat) => `<option value="${cat}">${cat}</option>`;

            // Opção para adicionar nova categoria
            const addNewOption = '<option value="nova_categoria">+ Adicionar nova...</option>';

            // Popula o seletor principal de FILTROS (não precisa da opção de adicionar)
            if (select) {
                const currentFilter = select.value;
                select.innerHTML = `<option value="">Todas as categorias</option><option value="Não classificada">Apenas não classificadas</option>`;
                select.innerHTML += sortedCategories.filter(cat => cat !== "Não classificada").map(createOption).join('');
                select.value = currentFilter;
            }

            // Popula o seletor de METAS
            if (goalSelect) {
                const currentGoal = goalSelect.value;
                goalSelect.innerHTML = '<option value="">Selecione categoria</option>';
                goalSelect.innerHTML += sortedCategories.filter(cat => cat !== "Não classificada").map(createOption).join('');
                goalSelect.innerHTML += addNewOption;
                goalSelect.value = currentGoal;
            }

            // Popula o seletor de AÇÃO EM LOTE
            if (bulkSelect) {
                const currentValue = bulkSelect.value;
                bulkSelect.innerHTML = '<option value="" disabled selected>Selecione para aplicar</option>';
                bulkSelect.innerHTML += sortedCategories.map(createOption).join('');
                bulkSelect.innerHTML += addNewOption;

                // *** INÍCIO DA CORREÇÃO ***
                // Só tenta restaurar o valor se não for a ação de criar uma nova categoria
                if (currentValue !== 'nova_categoria') {
                    bulkSelect.value = currentValue;
                }
                // *** FIM DA CORREÇÃO ***
            }

            // Popula o seletor do MODAL de Lançamento
            if (modalSelect) {
                const currentValue = modalSelect.value;
                modalSelect.innerHTML = sortedCategories.map(createOption).join('');
                modalSelect.innerHTML += addNewOption;

                // *** INÍCIO DA CORREÇÃO ***
                // Só executa a lógica de restauração/reset se o valor não for "nova_categoria"
                if (currentValue !== 'nova_categoria') {
                    if ([...modalSelect.options].some(o => o.value === currentValue)) {
                        modalSelect.value = currentValue;
                    } else {
                        modalSelect.value = 'Não classificada';
                    }
                }
                // *** FIM DA CORREÇÃO ***
            }
        }


        function updateGoalCategories() {
            updateFilterCategories();
        }


        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
        }


        function createCategorySelector(currentCategory, transactionIndex) {
            const select = document.createElement('select');
            select.className = 'category-select';

            [...new Set(categories)].sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === currentCategory) option.selected = true;
                select.appendChild(option);
            });

            const newOption = document.createElement('option');
            newOption.value = 'nova_categoria';
            newOption.textContent = '+ Adicionar nova...';
            select.appendChild(newOption);

            select.onchange = function() {
                if (this.value === 'nova_categoria') {
                    // CORREÇÃO AQUI: Passamos 'this' (o próprio select) como segundo argumento
                    openAddCategoryModal((novaCategoria) => {
                        this.value = novaCategoria;
                        classify(transactionIndex, novaCategoria);
                    }, this);
                } else {
                    classify(transactionIndex, this.value);
                }
            };
            return select;
        }

        function adicionarNovaCategoria() {
            const nomeCategoria = prompt('Nome da nova categoria:');
            if (nomeCategoria && nomeCategoria.trim()) {
                const categoria = nomeCategoria.trim();
                if (!orcamentoBaseZero.alocacoes[categoria]) {
                    orcamentoBaseZero.alocacoes[categoria] = 0;
                    renderizarEditorOrcamento();
                }
            }
        }

        function removerCategoria(categoria) {
            if (confirm(`Remover categoria "${categoria}" do orçamento?`)) {
                delete orcamentoBaseZero.alocacoes[categoria];
                renderizarEditorOrcamento();
            }
        }


        function calculateFuture() {
            const container = document.getElementById('futureView');
            if (!container) return;

            // Dados básicos atuais
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            // Cálculos básicos existentes
            const faturaAberta = transactions
                .filter(t => t.status === 'pendente')
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            const saldoAtual = transactions
                .filter(t => t.tipoLancamento === 'conta')
                .reduce((sum, t) => sum + t.valor, 0);

            // NOVAS MÉTRICAS AVANÇADAS
            const last3Months = getTransactionsFromLastMonths(3);
            const last6Months = getTransactionsFromLastMonths(6);

            const burnRate = calculateMonthlyBurnRate(last3Months);
            const savingsRate = calculateSavingsRate(last3Months);
            const volatility = calculateVolatility(last6Months);
            const categoryTrends = analyzeCategoryTrends(3);

            // Projeção mais sofisticada
            const projecaoProximoMes = saldoAtual - faturaAberta - burnRate;
            const projecao3Meses = saldoAtual - faturaAberta - (burnRate * 3);

            // Identificar tendências críticas
            const trendingUp = Object.entries(categoryTrends)
                .filter(([cat, data]) => data.change > 20)
                .sort((a, b) => b[1].change - a[1].change);

            const trendingDown = Object.entries(categoryTrends)
                .filter(([cat, data]) => data.change < -20)
                .sort((a, b) => a[1].change - b[1].change);

            // Gerar insights automáticos
            let insights = [];

            if (savingsRate > 20) {
                insights.push("✅ Excelente taxa de poupança! Você está no caminho certo.");
            } else if (savingsRate < 0) {
                insights.push("⚠️ Atenção: Você está gastando mais do que ganha nos últimos meses.");
            } else if (savingsRate < 10) {
                insights.push("💡 Sua taxa de poupança pode melhorar. Considere revisar seus gastos.");
            }

            if (volatility > burnRate * 0.5) {
                insights.push("📊 Seus gastos mensais variam bastante. Tente criar mais consistência.");
            }

            if (trendingUp.length > 0) {
                const [categoria, dados] = trendingUp[0];
                insights.push(`📈 Atenção: Gastos com "${categoria}" aumentaram ${dados.change.toFixed(1)}% recentemente.`);
            }

            if (trendingDown.length > 0) {
                const [categoria, dados] = trendingDown[0];
                insights.push(`📉 Parabéns: Você reduziu gastos com "${categoria}" em ${Math.abs(dados.change).toFixed(1)}%.`);
            }

            container.innerHTML = `
                   <div class="analysis-details-content">
                       <h6>📈 Análise Financeira Detalhada</h6>
                       
                       <div class="row mb-4">
                           <div class="col-md-6">
                               <h6>💰 Situação Atual</h6>
                               <p><strong>Saldo em Conta:</strong> ${saldoAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                               <p><strong>Faturas a Pagar:</strong> ${faturaAberta.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                               <p><strong>Saldo Líquido:</strong> 
                                  <span style="color: ${(saldoAtual - faturaAberta) >= 0 ? '#28a745' : '#dc3545'}">
                                      ${(saldoAtual - faturaAberta).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                  </span>
                               </p>
                           </div>
                           
                           <div class="col-md-6">
                               <h6>📊 Métricas dos Últimos 3 Meses</h6>
                               <p><strong>Gasto Médio Mensal:</strong> ${burnRate.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                               <p><strong>Taxa de Poupança:</strong> 
                                  <span style="color: ${savingsRate > 10 ? '#28a745' : savingsRate > 0 ? '#ffc107' : '#dc3545'}">
                                      ${savingsRate.toFixed(1)}%
                                  </span>
                               </p>
                               <p><strong>Volatilidade dos Gastos:</strong> ${volatility.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                           </div>
                       </div>
                       
                       <div class="row mb-4">
                           <div class="col-12">
                               <h6>🔮 Projeções</h6>
                               <p><strong>Projeção Próximo Mês:</strong> 
                                  <span style="color: ${projecaoProximoMes >= 0 ? '#28a745' : '#dc3545'}">
                                      ${projecaoProximoMes.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                  </span>
                               </p>
                               <p><strong>Projeção 3 Meses:</strong> 
                                  <span style="color: ${projecao3Meses >= 0 ? '#28a745' : '#dc3545'}">
                                      ${projecao3Meses.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                  </span>
                               </p>
                           </div>
                       </div>
                       
                       ${insights.length > 0 ? `
                       <div class="mb-4">
                           <h6>💡 Insights Automáticos</h6>
                           ${insights.map(insight => `<p class="mb-2">${insight}</p>`).join('')}
                       </div>
                       ` : ''}
                       
                       ${Object.keys(categoryTrends).length > 0 ? `
                       <div>
                           <h6>📈 Tendências por Categoria</h6>
                           <div class="row">
                               ${Object.entries(categoryTrends).slice(0, 6).map(([categoria, dados]) => `
                                   <div class="col-md-4 mb-2">
                                       <small><strong>${categoria}:</strong> 
                                       <span style="color: ${dados.change > 0 ? '#dc3545' : '#28a745'}">
                                           ${dados.change > 0 ? '+' : ''}${dados.change.toFixed(1)}%
                                       </span>
                                       </small>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                       ` : ''}
                   </div>
               `;
        }

        function toggleValueInputs() {
            const operator = document.getElementById('valueOperator').value;
            const input1 = document.getElementById('valueFilter1');
            const input2 = document.getElementById('valueFilter2');
            const separator = document.getElementById('valueSeparator');

            // Reset visibility
            input1.style.display = 'none';
            input2.style.display = 'none';
            separator.style.display = 'none';

            input1.setAttribute('inputmode', 'decimal');
            input2.setAttribute('inputmode', 'decimal');

            switch (operator) {
                case 'equals':
                case 'greater_than':
                case 'less_than':
                    input1.style.display = 'block';
                    input1.placeholder = operator === 'equals' ? 'Valor exato' :
                        operator === 'greater_than' ? 'Valor mínimo' : 'Valor máximo';
                    break;
                case 'between':
                    input1.style.display = 'block';
                    input2.style.display = 'block';
                    separator.style.display = 'block';
                    input1.placeholder = 'Valor mínimo';
                    input2.placeholder = 'Valor máximo';
                    break;
            }
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.transaction-checkbox:checked')).map(cb => cb.dataset.id);
        }

        function updateBulkActionContainer() {
            const selectedIds = getSelectedIds();
            const container = document.getElementById('bulkActionContainer');
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            checkboxes.forEach(cb => {
                const item = cb.closest('.list-group-item');
                if (item) {
                    if (cb.checked) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                }
            });
            if (selectedIds.length === 0) {
                container.style.display = 'none';
                const selectAll = document.getElementById('selectAllCheckbox');
                if (selectAll) selectAll.checked = false;
                return;
            }
            container.style.display = 'flex';
            const selectionText = `<span class="fw-bold">${selectedIds.length}</span> selecionado(s)`;
            const deleteButton = `<button class="btn btn-sm btn-danger ms-auto" onclick="deleteSelected()">Deletar</button>`;
            if (isReconciliationMode) {
                container.innerHTML = `${selectionText}<button class="btn btn-sm btn-success" onclick="reconcileSelected()">Marcar como Conciliado</button><button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Cancelar</button>${deleteButton}`;
            } else {
                container.innerHTML = `${selectionText}<select id="bulkCategorySelect" class="form-select form-select-sm" style="width: auto;" onchange="handleGenericCategoryChange(this)"></select><button class="btn btn-sm btn-success" onclick="applyBulkCategory()">Aplicar Categoria</button><button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Cancelar</button>${deleteButton}`;
                updateFilterCategories();
            }
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                selectAll.checked = selectedIds.length === checkboxes.length && checkboxes.length > 0;
            }
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = isChecked);
            updateBulkActionContainer();
        }

        function clearSelection() {
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) selectAll.checked = false;
            document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = false);
            updateBulkActionContainer();
        }

        function applyBulkCategory() {
            const selectedIds = getSelectedIds();
            const select = document.getElementById('bulkCategorySelect');
            if (!select) return;
            let newCategory = select.value;
            if (!newCategory) return alert('Selecione uma categoria.');
            if (selectedIds.length === 0) return alert('Nenhuma transação selecionada.');
            if (newCategory === 'nova_categoria_lote') {
                const typedCategory = prompt('Digite a nova categoria:');
                if (typedCategory && typedCategory.trim()) {
                    newCategory = typedCategory.trim();
                    if (!categories.includes(newCategory)) categories.push(newCategory);
                } else {
                    return;
                }
            }
            let updatedCount = 0;
            transactions.forEach(t => {
                if (selectedIds.includes(t.identificador)) {
                    t.categoria = newCategory;
                    updatedCount++;
                }
            });
            saveTransactions();
            updateCategories();
            applyFilters(true);
            clearSelection();
            alert(`${updatedCount} transações atualizadas para "${newCategory}".`);
        }

        function deleteSelected() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return alert('Nenhuma transação selecionada.');
            if (confirm(`Tem certeza que deseja excluir ${selectedIds.length} transação(ões)? Esta ação não pode ser desfeita.`)) {
                const originalCount = transactions.length;
                transactions = transactions.filter(t => !selectedIds.includes(t.identificador));
                const deletedCount = originalCount - transactions.length;
                saveTransactions();
                applyFilters();
                alert(`${deletedCount} transações foram excluídas.`);
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page === 'last') {
                currentPage = totalPages > 0 ? totalPages : 1;
            } else {
                currentPage = parseInt(page, 10);
            }
            renderTransactions();
        }

        function updatePaginationButtonsState() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const isFirstPage = currentPage === 1;
            const isLastPage = currentPage === totalPages || totalPages === 0;
            document.querySelectorAll('.btn-first, .btn-prev').forEach(btn => btn.disabled = isFirstPage);
            document.querySelectorAll('.btn-last, .btn-next').forEach(btn => btn.disabled = isLastPage);
        }


        // ===================================================================
        // GERENCIADOR GERAL DE MODAIS
        // ===================================================================

        let activeModalStack = []; // Usa uma pilha (array) para gerenciar múltiplos modais
        let categorySelectTriggerEl = null; // Guarda o <select> que abriu o modal de categoria



        /**
         * Abre um modal e adiciona um listener para fechar ao clicar no fundo.
         */

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        // Adiciona o novo modal ao topo da pilha
        activeModalStack.push(modalId);
        
        // ADICIONA: Previne scroll do body no mobile
        if (window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden';
        }
        
        modal.style.display = 'flex'; // IMPORTANTE: display flex
        setTimeout(() => {
            modal.classList.add('visible');
        }, 10);

        modal.onclick = function(event) {
            if (event.target === modal && activeModalStack[activeModalStack.length - 1] === modalId) {
                closeCurrentModal();
            }
        };
    } else {
        console.error('Modal não encontrado:', modalId); // Debug
    }
}

        /**
         * Fecha o modal que está no topo da pilha.
         */

        function closeCurrentModal() {
    if (activeModalStack.length === 0) return;

    const modalId = activeModalStack.pop();
    const modal = document.getElementById(modalId);

    if (modal) {
        modal.classList.remove('visible');
        setTimeout(() => {
            modal.style.display = 'none';
            modal.onclick = null;
            
            // ADICIONA: Remove o modal do DOM se for dinâmico
            if (modalId === 'novaMetaModal' || 
                modalId === 'novoObjetivoModal' || 
                modalId === 'editarObjetivoModal') {
                modal.remove();
            }
            
            // Restaura scroll do body
            if (activeModalStack.length === 0 && window.innerWidth <= 768) {
                document.body.style.overflow = '';
            }
        }, 200);
    }

    if (modalId === 'addCategoryModal' && categorySelectTriggerEl) {
        if (document.body.contains(categorySelectTriggerEl)) {
            categorySelectTriggerEl.selectedIndex = 0;
        }
    }

    categoryAddCallback = null;
    categorySelectTriggerEl = null;
}


        /**
         * Abre o modal para adicionar categoria, guardando qual <select> o chamou.
         */

        function openAddCategoryModal(callback, triggerElement) {
            categoryAddCallback = callback;
            categorySelectTriggerEl = triggerElement;

            const input = document.getElementById('newCategoryName');
            if (input) input.value = '';

            openModal('addCategoryModal');

            setTimeout(() => input.focus(), 200);
        }

        /**
         * Salva a nova categoria criada através do modal.
         */
        function saveNewCategory() {
    const input = document.getElementById('newCategoryName');
    const newCategoryName = input.value.trim();
    const classificacao = document.getElementById('newCategoryClassificacao')?.value || 'necessidades';

    if (!newCategoryName) {
        alert('O nome da categoria não pode ser vazio.');
        return;
    }
    if (categories.map(c => c.toLowerCase()).includes(newCategoryName.toLowerCase())) {
        alert('Esta categoria já existe.');
        input.value = '';
        return;
    }

    categories.push(newCategoryName);
    
    // Adiciona à classificação selecionada
    if (!classificacaoCategorias[classificacao].includes(newCategoryName)) {
        classificacaoCategorias[classificacao].push(newCategoryName);
    }
    
    updateFilterCategories();
    salvarClassificacaoCategorias();

    if (categoryAddCallback) {
        categoryAddCallback(newCategoryName);
    }

    categorySelectTriggerEl = null;
    closeCurrentModal();
}


        /**
         * Função genérica para tratar a mudança em qualquer <select> de categoria.
         */
        function handleGenericCategoryChange(selectElement) {
            if (selectElement.value === 'nova_categoria') {
                openAddCategoryModal((novaCategoria) => {
                    selectElement.value = novaCategoria;
                }, selectElement);
            }
        }

        /**
         * Abre o modal de conciliação manual e popula as listas.
         */
        function openManualReconciliationModal() {
            // Reseta as seleções anteriores
            selectedManualId = null;
            selectedImportedId = null;
            document.getElementById('executeReconciliationBtn').disabled = true;

            populateReconciliationLists();
            openModal('manualReconciliationModal');
        }

        /**
         * Filtra e exibe as transações manuais e importadas nas listas do modal.
         */
function populateReconciliationLists() {
    const manualList = document.getElementById('manualPendingList');
    const importedList = document.getElementById('importedUnreconciledList');
    
    // Filtra transações manuais pendentes
    const manualPending = transactions.filter(t => t.isManual && !t.conciliado);

    // CORREÇÃO: Só mostra transações importadas se houver manuais pendentes
    // E apenas transações que são candidatas à conciliação
    let importedUnreconciled = [];
    
    if (manualPending.length > 0) {
        // Busca transações importadas de cartão não conciliadas
        // E filtra apenas as que têm data próxima às manuais (±7 dias)
        const datasManual = manualPending.map(t => {
            const [day, month, year] = t.data.split('/').map(Number);
            return new Date(year, month - 1, day);
        });
        
        const dataMin = new Date(Math.min(...datasManual));
        dataMin.setDate(dataMin.getDate() - 7); // 7 dias antes
        
        const dataMax = new Date(Math.max(...datasManual));
        dataMax.setDate(dataMax.getDate() + 7); // 7 dias depois
        
        importedUnreconciled = transactions.filter(t => {
            if (t.isManual || t.tipoLancamento !== 'cartao' || t.conciliadoCom) return false;
            
            const [day, month, year] = t.data.split('/').map(Number);
            const dataTransacao = new Date(year, month - 1, day);
            
            return dataTransacao >= dataMin && dataTransacao <= dataMax;
        });
    }

    const renderItem = (t) => `
        <a href="#" class="list-group-item list-group-item-action" data-id="${t.identificador}" onclick="handleReconciliationSelection(this, event)">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${t.nome}</h6>
                <small>${t.data}</small>
            </div>
            <p class="mb-1">R$ ${Math.abs(t.valor).toFixed(2)}</p>
            <small>Categoria: ${t.categoria}</small>
        </a>`;

    manualList.innerHTML = manualPending.length > 0 ? 
        manualPending.map(renderItem).join('') : 
        '<p class="p-3 text-muted">Nenhum lançamento manual pendente.</p>';
        
    importedList.innerHTML = importedUnreconciled.length > 0 ? 
        importedUnreconciled.map(renderItem).join('') : 
        '<p class="p-3 text-muted">Nenhuma transação compatível encontrada.</p>';
}


        /**
         * Gerencia a seleção dos itens nas listas de conciliação.
         */
        function handleReconciliationSelection(element, event) {
            event.preventDefault();
            const listId = element.parentElement.id;
            const transactionId = element.dataset.id;
            const otherListId = listId === 'manualPendingList' ? 'importedUnreconciledList' : 'manualPendingList';

            // Limpa seleções e destaques anteriores
            document.querySelectorAll('.reconciliation-list .list-group-item').forEach(item => {
                item.style.backgroundColor = ''; // Limpa destaques de similaridade
            });

            const siblings = element.parentElement.querySelectorAll('.list-group-item');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');

            if (listId === 'manualPendingList') {
                selectedManualId = transactionId;
            } else if (listId === 'importedUnreconciledList') {
                selectedImportedId = transactionId;
            }

            // Lógica de destaque inteligente
            const selectedTransaction = transactions.find(t => t.identificador === transactionId);
            if (selectedTransaction) {
                const otherListItems = document.querySelectorAll(`#${otherListId} .list-group-item`);
                otherListItems.forEach(item => {
                    const otherTransaction = transactions.find(t => t.identificador === item.dataset.id);
                    if (otherTransaction) {
                        const diff = Math.abs(Math.abs(selectedTransaction.valor) - Math.abs(otherTransaction.valor));
                        if (diff <= 1.00) { // Destaca se a diferença for de até R$ 1,00
                            item.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                        }
                    }
                });
            }

            document.getElementById('executeReconciliationBtn').disabled = !(selectedManualId && selectedImportedId);
        }

        /**
         * Executa a conciliação entre os dois itens selecionados.
         */
        function executeManualReconciliation() {
            if (!selectedManualId || !selectedImportedId) return;

            const manualTransaction = transactions.find(t => t.identificador === selectedManualId);
            const importedTransaction = transactions.find(t => t.identificador === selectedImportedId);

            if (!manualTransaction || !importedTransaction) {
                alert('Erro: Transação não encontrada.');
                return;
            }

            const confirmation = confirm(
                `Deseja conciliar o seguinte lançamento manual?\n\n` +
                `MANUAL: ${manualTransaction.nome} (R$ ${Math.abs(manualTransaction.valor).toFixed(2)})\n` +
                `CATEGORIA: ${manualTransaction.categoria}\n\n` +
                `Com o lançamento importado:\n\n` +
                `IMPORTADO: ${importedTransaction.nome} (R$ ${Math.abs(importedTransaction.valor).toFixed(2)})\n\n` +
                `A categoria "${manualTransaction.categoria}" será transferida para o lançamento importado.`
            );

            if (confirmation) {
                // 1. Transfere a categoria
                importedTransaction.categoria = manualTransaction.categoria;

                // 2. Atualiza o status da transação importada para 'reconciled'
                importedTransaction.status = 'reconciled';

                // 3. Marca ambos como conciliados e os vincula
                manualTransaction.conciliado = true;
                manualTransaction.conciliadoCom = importedTransaction.identificador;
                importedTransaction.conciliadoCom = manualTransaction.identificador;

                // 4. Salva os dados
                saveTransactions();

                // 5. Atualiza as listas dentro do modal (os itens sumirão)
                populateReconciliationLists();

                // 6. Reseta o estado para a próxima conciliação
                selectedManualId = null;
                selectedImportedId = null;
                document.getElementById('executeReconciliationBtn').disabled = true;

                // 7. Atualiza a lista principal de transações em segundo plano
                applyFilters(true);
            }
        }

function abrirModalNovaMeta() {
    // Remove modal anterior se existir
    const modalExistente = document.getElementById('novaMetaModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    const modal = criarModalNovaMeta();
    document.body.appendChild(modal);
    
    // Pequeno delay para garantir que o DOM foi atualizado
    setTimeout(() => {
        openModal('novaMetaModal');
    }, 50);
}

        function editarMetaReserva(tipo) {
            const reserva = reservasFinanceiras[tipo];
            if (!reserva || !reserva.ativa) return;

            const modalTitle = document.getElementById('editReserveModalTitle');
            const modalLabel = document.getElementById('editReserveModalLabel');
            const modalValue = document.getElementById('editReserveModalValue');
            const modalHelp = document.getElementById('editReserveModalHelp');
            const modalType = document.getElementById('editReserveModalType');

            modalType.value = tipo; // Armazena qual reserva estamos editando

            if (tipo === 'emergencia') {
                modalTitle.textContent = 'Editar Reserva de Emergência';
                modalLabel.textContent = 'Meta em Meses de Gastos';
                modalValue.value = reserva.metaMeses || 6;
                modalHelp.textContent = 'O valor total em R$ será calculado com base no seu gasto médio mensal.';
            } else {
                modalTitle.textContent = `Editar Meta da ${reserva.nome}`;
                modalLabel.textContent = 'Valor Total da Meta (R$)';
                modalValue.value = reserva.valorMeta || '';
                modalHelp.textContent = 'Defina o montante total que você deseja acumular nesta reserva.';
            }

            openModal('editReserveModal');
        }

        function salvarMetaReserva() {
            const tipo = document.getElementById('editReserveModalType').value;
            const novoValor = parseFloat(document.getElementById('editReserveModalValue').value);
            const reserva = reservasFinanceiras[tipo];

            if (!reserva) {
                alert('Erro: Reserva não encontrada.');
                return;
            }

            if (isNaN(novoValor) || novoValor <= 0) {
                alert('Por favor, informe um valor válido e positivo.');
                return;
            }

            if (tipo === 'emergencia') {
                if (novoValor > 24) {
                    alert('A meta de meses para a reserva de emergência não deve exceder 24.');
                    return;
                }
                reserva.metaMeses = novoValor;
                const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
                reserva.valorMeta = burnRate * novoValor;
                reserva.descricao = `Para situações imprevistas (${novoValor} meses de gastos)`;
                alert(`Meta atualizada: ${novoValor} meses (${reserva.valorMeta.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})`);
            } else {
                reserva.valorMeta = novoValor;
                alert(`Meta definida: ${novoValor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`);
            }

            salvarTodosSistemas();
            renderizarReservasFinanceiras();
            closeCurrentModal();
        }

        function criarModalNovaMeta() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'novaMetaModal';
            modal.style.display = 'none';

            modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Meta Mensal</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="novaMetaTipo" class="form-label">Tipo de Meta</label>
                        <select id="novaMetaTipo" class="form-control" onchange="atualizarCamposNovaMeta()">
                            <option value="">Selecione...</option>
                            <option value="orcamento_categoria">Orçamento por Categoria</option>
                            <option value="reducao_gasto">Redução de Gastos</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="novaMetaNome" class="form-label">Nome da Meta</label>
                        <input type="text" id="novaMetaNome" class="form-control" placeholder="Ex: Orçamento Alimentação">
                    </div>
                    
                    <div id="camposEspecificosNovaMeta"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaMeta()">Criar Meta</button>
                </div>
            </div>
        </div>
    `;

            return modal;
        }

        function atualizarCamposNovaMeta() {
            const tipo = document.getElementById('novaMetaTipo').value;
            const container = document.getElementById('camposEspecificosNovaMeta');

            if (!tipo) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            if (tipo === 'orcamento_categoria') {
                html = `
            <div class="mb-3">
                <label for="novaMetaCategoria" class="form-label">Categoria</label>
                <select id="novaMetaCategoria" class="form-control">
                    <option value="">Selecione...</option>
                    ${categories.filter(c => c !== 'Não classificada').map(cat => 
                        `<option value="${cat}">${cat}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="mb-3">
                <label for="novaMetaValor" class="form-label">Valor Máximo (R$)</label>
                <input type="number" inputmode="decimal" id="novaMetaValor" class="form-control" step="0.01" min="0" placeholder="Ex: 500.00">
            </div>
        `;
            } else if (tipo === 'reducao_gasto') {
                html = `
            <div class="mb-3">
                <label for="novaMetaCategoria" class="form-label">Categoria</label>
                <select id="novaMetaCategoria" class="form-control">
                    <option value="">Selecione...</option>
                    ${categories.filter(c => c !== 'Não classificada').map(cat => 
                        `<option value="${cat}">${cat}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="mb-3">
                <label for="novaMetaPercentual" class="form-label">Percentual de Redução (%)</label>
                <input type="number" inputmode="decimal" id="novaMetaPercentual" class="form-control" value="10" min="1" max="100">
                <small class="text-muted">A meta será calculada com base nos gastos do mês anterior nesta categoria</small>
            </div>
        `;
            }

            container.innerHTML = html;
        }

        function salvarNovaMeta() {
            const tipo = document.getElementById('novaMetaTipo').value;
            const nome = document.getElementById('novaMetaNome').value.trim();

            if (!tipo || !nome) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }

            const dados = {
                nome
            };

            if (tipo === 'orcamento_categoria') {
                const categoria = document.getElementById('novaMetaCategoria').value;
                const valor = parseFloat(document.getElementById('novaMetaValor').value);

                if (!categoria || isNaN(valor) || valor <= 0) {
                    alert('Preencha todos os campos corretamente.');
                    return;
                }

                dados.categoria = categoria;
                dados.valor = valor;
            } else if (tipo === 'reducao_gasto') {
                const categoria = document.getElementById('novaMetaCategoria').value;
                const percentual = parseFloat(document.getElementById('novaMetaPercentual').value);

                if (!categoria || isNaN(percentual) || percentual <= 0) {
                    alert('Preencha todos os campos corretamente.');
                    return;
                }

                dados.categoria = categoria;
                dados.percentualReducao = percentual;

                // Calcula valor base do mês anterior
                const mesPassado = new Date();
                mesPassado.setMonth(mesPassado.getMonth() - 1);
                const mesPassadoKey = `${mesPassado.getFullYear()}-${String(mesPassado.getMonth() + 1).padStart(2, '0')}`;

                const gastosPassado = transactions
                    .filter(t => {
                        if (!t.categoria || t.categoria !== categoria || t.valor >= 0) return false;
                        const [day, month, year] = t.data.split('/').map(Number);
                        const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                        return transactionMonth === mesPassadoKey;
                    })
                    .reduce((sum, t) => sum + Math.abs(t.valor), 0);

                dados.valor = gastosPassado;
            }

            const novaMeta = criarNovaMeta(tipo, dados);
            metasMensais.push(novaMeta);

            salvarTodosSistemas();
            atualizarProgressoTodasMetas();

            closeCurrentModal();
            showMetasTab('mensais');

            alert(`Meta "${nome}" criada com sucesso!`);
        }

function abrirModalNovoObjetivo() {
    // Remove modal anterior se existir
    const modalExistente = document.getElementById('novoObjetivoModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    const modal = criarModalNovoObjetivo();
    document.body.appendChild(modal);
    
    setTimeout(() => {
        openModal('novoObjetivoModal');
    }, 50);
}

        function criarModalNovoObjetivo() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'novoObjetivoModal';
            modal.style.display = 'none';

            modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Objetivo de Poupança</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="novoObjetivoNome" class="form-label">Nome do Objetivo</label>
                        <input type="text" id="novoObjetivoNome" class="form-control" placeholder="Ex: Casa própria, Carro, Viagem">
                    </div>
                    
                    <div class="mb-3">
                        <label for="novoObjetivoValor" class="form-label">Valor Total (R$)</label>
                        <input type="number" inputmode="decimal" id="novoObjetivoValor" class="form-control" step="0.01" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="novoObjetivoData" class="form-label">Data Desejada</label>
                        <input type="date" id="novoObjetivoData" class="form-control">
                    </div>
                    
                    <div class="mb-3">
                        <label for="novoObjetivoPrioridade" class="form-label">Prioridade</label>
                        <select id="novoObjetivoPrioridade" class="form-control">
                            <option value="alta">Alta - Foco principal</option>
                            <option value="media" selected>Média - Importante</option>
                            <option value="baixa">Baixa - Quando possível</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="novoObjetivoDescricao" class="form-label">Descrição (opcional)</label>
                        <textarea id="novoObjetivoDescricao" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="alert alert-info small">
                        <strong>💡 Dica:</strong> Após criar, categorize suas transferências de poupança como "Poupança: [Nome do Objetivo]" para acompanhar automaticamente o progresso.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoObjetivo()">Criar Objetivo</button>
                </div>
            </div>
        </div>
    `;

            return modal;
        }

        function salvarNovoObjetivo() {
            const nome = document.getElementById('novoObjetivoNome').value.trim();
            const valor = parseFloat(document.getElementById('novoObjetivoValor').value);
            const data = document.getElementById('novoObjetivoData').value;
            const prioridade = document.getElementById('novoObjetivoPrioridade').value;
            const descricao = document.getElementById('novoObjetivoDescricao').value.trim();

            if (!nome || isNaN(valor) || valor <= 0 || !data) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }

            const dataObjetivo = new Date(data);
            const agora = new Date();

            if (dataObjetivo <= agora) {
                alert('A data do objetivo deve ser futura.');
                return;
            }

            const mesesRestantes = Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24 * 30));
            const valorMensal = valor / mesesRestantes;

            const novoObjetivo = {
                id: `objetivo-${Date.now()}`,
                nome: nome,
                valor: valor,
                dataDesejada: data,
                prioridade: prioridade,
                descricao: descricao,
                valorJuntado: 0,
                contribuicaoMensal: 0,
                dataCriacao: new Date().toISOString(),
                mesesRestantes: mesesRestantes,
                valorMensalNecessario: valorMensal,
                historicoMensal: []
            };

            objetivosPoupanca.push(novoObjetivo);

            // Cria categoria automática
            const nomeCategoria = `Poupança: ${nome}`;
            if (!categories.includes(nomeCategoria)) {
                categories.push(nomeCategoria);
                updateFilterCategories();
            }

            salvarTodosSistemas();

            closeCurrentModal();
            showMetasTab('objetivos');

            alert(`Objetivo "${nome}" criado! Categorize suas poupanças como "${nomeCategoria}" para acompanhar o progresso.`);
        }

function excluirObjetivo(objetivoId) {
    const objetivo = objetivosPoupanca.find(obj => obj.id === objetivoId);
    if (!objetivo) return;
    
    const confirmacao = confirm(
        `Tem certeza que deseja excluir o objetivo "${objetivo.nome}"?\n\n` +
        `⚠️ Atenção:\n` +
        `- O objetivo será removido permanentemente\n` +
        `- A categoria "Poupança: ${objetivo.nome}" será mantida\n` +
        `- As transações categorizadas não serão afetadas\n` +
        `- O histórico mensal será preservado`
    );
    
    if (confirmacao) {
        // Remove o objetivo
        objetivosPoupanca = objetivosPoupanca.filter(obj => obj.id !== objetivoId);
        
        salvarTodosSistemas();
        renderizarObjetivosPoupanca();
        atualizarResumoMetas();
        
        alert(`Objetivo "${objetivo.nome}" excluído com sucesso!`);
    }
}

function editarObjetivo(objetivoId) {
    const objetivo = objetivosPoupanca.find(obj => obj.id === objetivoId);
    if (!objetivo) return;
    
    // Remove modal anterior se existir
    const modalExistente = document.getElementById('editarObjetivoModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    const modal = criarModalEditarObjetivo(objetivo);
    document.body.appendChild(modal);
    
    setTimeout(() => {
        openModal('editarObjetivoModal');
    }, 50);
}

function criarModalEditarObjetivo(objetivo) {
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop';
    modal.id = 'editarObjetivoModal';
    modal.style.display = 'none';
    
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Objetivo de Poupança</h5>
                    <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editObjetivoId" value="${objetivo.id}">
                    
                    <div class="mb-3">
                        <label for="editObjetivoNome" class="form-label">Nome do Objetivo</label>
                        <input type="text" id="editObjetivoNome" class="form-control" value="${objetivo.nome}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editObjetivoValor" class="form-label">Valor Total (R$)</label>
                        <input type="number" inputmode="decimal" id="editObjetivoValor" class="form-control" 
                               step="0.01" min="0" value="${objetivo.valor}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editObjetivoData" class="form-label">Data Desejada</label>
                        <input type="date" id="editObjetivoData" class="form-control" value="${objetivo.dataDesejada}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editObjetivoPrioridade" class="form-label">Prioridade</label>
                        <select id="editObjetivoPrioridade" class="form-control">
                            <option value="alta" ${objetivo.prioridade === 'alta' ? 'selected' : ''}>Alta - Foco principal</option>
                            <option value="media" ${objetivo.prioridade === 'media' ? 'selected' : ''}>Média - Importante</option>
                            <option value="baixa" ${objetivo.prioridade === 'baixa' ? 'selected' : ''}>Baixa - Quando possível</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editObjetivoDescricao" class="form-label">Descrição (opcional)</label>
                        <textarea id="editObjetivoDescricao" class="form-control" rows="2">${objetivo.descricao || ''}</textarea>
                    </div>
                    
                    <div class="alert alert-warning small">
                        <strong>⚠️ Atenção:</strong> O valor já acumulado (${objetivo.valorJuntado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}) não será alterado.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoObjetivo()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    `;
    
    return modal;
}

function salvarEdicaoObjetivo() {
    const objetivoId = document.getElementById('editObjetivoId').value;
    const objetivo = objetivosPoupanca.find(obj => obj.id === objetivoId);
    
    if (!objetivo) {
        alert('Erro: Objetivo não encontrado.');
        return;
    }
    
    const nome = document.getElementById('editObjetivoNome').value.trim();
    const valor = parseFloat(document.getElementById('editObjetivoValor').value);
    const data = document.getElementById('editObjetivoData').value;
    const prioridade = document.getElementById('editObjetivoPrioridade').value;
    const descricao = document.getElementById('editObjetivoDescricao').value.trim();
    
    if (!nome || isNaN(valor) || valor <= 0 || !data) {
        alert('Preencha todos os campos obrigatórios.');
        return;
    }
    
    const dataObjetivo = new Date(data);
    const agora = new Date();
    
    if (dataObjetivo <= agora) {
        alert('A data do objetivo deve ser futura.');
        return;
    }
    
    // Atualiza categoria se o nome mudou
    const nomeAnterior = objetivo.nome;
    if (nomeAnterior !== nome) {
        const categoriaAntiga = `Poupança: ${nomeAnterior}`;
        const categoriaNova = `Poupança: ${nome}`;
        
        // Atualiza transações existentes
        transactions.forEach(t => {
            if (t.categoria === categoriaAntiga) {
                t.categoria = categoriaNova;
            }
        });
        
        // Atualiza lista de categorias
        const indexCategoria = categories.indexOf(categoriaAntiga);
        if (indexCategoria > -1) {
            categories[indexCategoria] = categoriaNova;
        }
        
        saveTransactions();
        updateFilterCategories();
    }
    
    // Recalcula valores
    const mesesRestantes = Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24 * 30));
    const valorRestante = valor - objetivo.valorJuntado;
    const valorMensal = mesesRestantes > 0 ? valorRestante / mesesRestantes : 0;
    
    // Atualiza objetivo
    objetivo.nome = nome;
    objetivo.valor = valor;
    objetivo.dataDesejada = data;
    objetivo.prioridade = prioridade;
    objetivo.descricao = descricao;
    objetivo.mesesRestantes = mesesRestantes;
    objetivo.valorMensalNecessario = valorMensal;
    
    salvarTodosSistemas();
    
    closeCurrentModal();
    renderizarObjetivosPoupanca();
    
    alert(`Objetivo "${nome}" atualizado com sucesso!`);
}


        // ===================================================================
        // MODAIS DE INPUT PERSONALIZADOS
        // ===================================================================


function mostrarModalInput(titulo, mensagem, placeholder, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop';
    modal.id = 'modalInputGenerico';
    modal.style.display = 'none';

    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${titulo}</h5>
                    <button type="button" class="btn-close" onclick="fecharModalInput()"></button>
                </div>
                <div class="modal-body">
                    <p>${mensagem}</p>
                    <input type="text" inputmode="decimal" id="inputGenerico" class="form-control" 
                           placeholder="${placeholder || ''}" value="${placeholder || ''}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalInput()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarModalInput()">Confirmar</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Armazena callback
    window.modalInputCallback = callback;

    openModal('modalInputGenerico');

    // Foca no input e seleciona texto
    setTimeout(() => {
        const input = document.getElementById('inputGenerico');
        input.focus();
        input.select();
    }, 300);
}


        function confirmarModalInput() {
            const valor = document.getElementById('inputGenerico').value;
            if (window.modalInputCallback) {
                window.modalInputCallback(valor);
            }
            fecharModalInput();
        }

        function fecharModalInput() {
            const modal = document.getElementById('modalInputGenerico');
            if (modal) {
                modal.remove();
            }
            window.modalInputCallback = null;
        }

        function mostrarModalSelecao(titulo, mensagem, opcoes, callback) {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'modalSelecaoGenerica';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">${titulo}</h5>
                               <button type="button" class="btn-close" onclick="fecharModalSelecao()"></button>
                           </div>
                           <div class="modal-body">
                               <p>${mensagem}</p>
                               <div class="list-group">
                                   ${opcoes.map((opcao, index) => `
                                       <button class="list-group-item list-group-item-action" onclick="selecionarOpcaoModal(${index})">
                                           ${opcao}
                                       </button>
                                   `).join('')}
                               </div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="fecharModalSelecao()">Cancelar</button>
                           </div>
                       </div>
                   </div>
               `;

            document.body.appendChild(modal);
            window.modalSelecaoCallback = callback;
            openModal('modalSelecaoGenerica');
        }

        function selecionarOpcaoModal(indice) {
            if (window.modalSelecaoCallback) {
                window.modalSelecaoCallback(indice);
            }
            fecharModalSelecao();
        }

        function fecharModalSelecao() {
            const modal = document.getElementById('modalSelecaoGenerica');
            if (modal) {
                modal.remove();
            }
            window.modalSelecaoCallback = null;
        }

        // --- Funções que USAM o gerenciador ---


        function openAddModal() {
            const modal = document.getElementById('manualEntryModal');
            if (!modal) return;

            document.getElementById('editTransactionId').value = '';
            document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalName').value = '';
            document.getElementById('modalValue').value = '';

            modal.querySelector('.modal-title').textContent = '⭐ Novo Lançamento (Cartão)';
            modal.querySelector('.btn-primary').innerHTML = '💾 Salvar Lançamento';

            updateFilterCategories();

            // LINHA ADICIONADA: Reseta a categoria para o padrão
            document.getElementById('modalCategory').value = 'Não classificada';

            openModal('manualEntryModal');
        }

        function openEditModal(transactionId) {
            const transactionToEdit = transactions.find(t => t.identificador === transactionId);
            if (!transactionToEdit) return alert('Erro: Transação não encontrada.');

            const modal = document.getElementById('manualEntryModal');
            document.getElementById('editTransactionId').value = transactionId;
            const dateParts = transactionToEdit.data.split('/');
            document.getElementById('modalDate').value = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
            document.getElementById('modalName').value = transactionToEdit.nome;
            document.getElementById('modalValue').value = Math.abs(transactionToEdit.valor);
            document.getElementById('modalCategory').value = transactionToEdit.categoria;

            modal.querySelector('.modal-title').textContent = '✏️ Editar Lançamento';
            // Adiciona o ícone ao botão
            modal.querySelector('.btn-primary').innerHTML = '💾 Salvar Alterações';

            updateFilterCategories();
            openModal('manualEntryModal');
        }


        function deleteCategory(categoryName) {
            if (confirm(`Tem certeza que deseja excluir a categoria "${categoryName}"?\n\nTodas as transações associadas a ela serão movidas para "Não classificada".`)) {
                transactions.forEach(t => {
                    if (t.categoria === categoryName) {
                        t.categoria = "Não classificada";
                    }
                });

                categories = categories.filter(cat => cat !== categoryName);

                if (goals[categoryName]) {
                    delete goals[categoryName];
                    saveGoals();
                }

                saveTransactions();
                applyFilters(true);
                updateFilterCategories();
                updateGoalsView();

                alert(`Categoria "${categoryName}" excluída com sucesso!`);
                openModal('categoryModal');
                renderCategoryManagerList();
            }
        }

        function saveTransaction() {
            const transactionId = document.getElementById('editTransactionId').value;
            const date = document.getElementById('modalDate').value;
            const name = document.getElementById('modalName').value.trim();
            const value = parseFloat(document.getElementById('modalValue').value);
            const category = document.getElementById('modalCategory').value;
            if (!date || !name || isNaN(value) || value <= 0) {
                alert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }
            if (transactionId) {
                const index = transactions.findIndex(t => t.identificador === transactionId);
                if (index > -1) {
                    transactions[index].data = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
                    transactions[index].nome = name;
                    transactions[index].valor = -Math.abs(value);
                    transactions[index].categoria = category;
                }
            } else {
                const faturaDate = new Date(date);
                const idFatura = `${faturaDate.getFullYear()}-${String(faturaDate.getMonth() + 1).padStart(2, '0')}`;
                // Constante de "nova transação"
                const newTransaction = {
                    data: new Date(date + 'T00:00:00').toLocaleDateString('pt-BR'),
                    valor: -Math.abs(value),
                    identificador: `manual-${Date.now()}`,
                    tipo: 'Compra Manual (Cartão)',
                    nome: name,
                    categoria: category,
                    tipoLancamento: 'cartao',
                    status: 'pendente',
                    idFatura: idFatura,
                    // NOVOS CAMPOS:
                    isManual: true,
                    conciliado: false,
                    conciliadoCom: null // ID da transação importada vinculada
                };
                aplicarRegrasAutomaticas(newTransaction);
                transactions.push(newTransaction);
            }
            saveTransactions();
            applyFilters();
            alert('Transação salva com sucesso!');
            closeCurrentModal();
        }

        function exportData() {
            if (transactions.length === 0) {
                alert('Nenhuma transação para exportar');
                return;
            }
            const csvContent = "data:text/csv;charset=utf-8," +
                "Data,Valor,Identificador,Tipo,Nome,Categoria,Status\n" +
                transactions.map(t =>
                    `${t.data},${t.valor},${t.identificador},"${t.tipo}","${t.nome}","${t.categoria}","${t.status}"`
                ).join('\n');

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `transacoes_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportBackup() {
            const backup = {
                transactions: transactions,
                categories: categories,
                goals: goals,
                monthlyBudget: monthlyBudget,
                exportDate: new Date().toISOString(),
                version: '3.0' // Versão atualizada com nova estrutura de dados
            };
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], {
                type: 'application/json'
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `controle-financeiro-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('Backup completo exportado com sucesso!');
        }

        function importBackup() {
            document.getElementById('backupFile').click();
        }

        function processBackupFile() {
            const file = document.getElementById('backupFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.transactions) {
                        transactions = backup.transactions || [];
                        categories = backup.categories || ["Comida", "Transporte", "Outros"];
                        goals = backup.goals || {};
                        monthlyBudget = backup.monthlyBudget || 0;

                        // >>> INÍCIO DA CORREÇÃO <<<
                        const budgetInput = document.getElementById('budget');
                        if (budgetInput) {
                            budgetInput.value = monthlyBudget;
                        }
                        // >>> FIM DA CORREÇÃO <<<

                        // Garante que dados de backup antigos sejam migrados se necessário
                        let needsMigration = transactions.some(t => !t.status);
                        if (needsMigration) {
                            // ... (lógica de migração) ...
                        }

                        saveTransactions();
                        updateCategories();
                        applyFilters();
                        updateFilterCategories();
                        updateGoalsView();
                        alert(`Backup restaurado com sucesso!`);
                    } else {
                        alert('Arquivo de backup inválido.');
                    }
                } catch (error) {
                    alert('Erro ao processar backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }


        function clearAllData() {
            if (confirm('Tem certeza que deseja apagar TODOS os dados? Esta ação não pode ser desfeita.')) {
                transactions = [];
                categories = ["Comida", "Transporte", "Outros"];
                goals = {};
                monthlyBudget = 0;
                localStorage.clear(); // Limpa todo o armazenamento local

                // Recarrega a página para um estado limpo
                window.location.reload();
            }
        }


        function toggleReconciliationMode() {
            isReconciliationMode = !isReconciliationMode;
            const btn = document.getElementById('reconcileBtn');

            if (isReconciliationMode) {
                btn.textContent = '❌ Cancelar Conciliação';
                btn.className = 'btn btn-warning';
            } else {
                btn.textContent = '🛡️ Iniciar Conciliação';
                btn.className = 'btn btn-outline-info';
                clearSelection();
            }

            updateBulkActionContainer();
        }

        // Função para gerenciar conciliação:
        function gerenciarConciliacao() {
            const manuaisNaoConciliados = transactions.filter(t => t.isManual && !t.conciliado);

            if (manuaisNaoConciliados.length === 0) {
                alert('Não há lançamentos manuais pendentes de conciliação.');
                return;
            }

            const opcoes = manuaisNaoConciliados.map((t, index) =>
                `${index + 1}. ${t.data} - ${t.nome} - R$ ${Math.abs(t.valor).toFixed(2)}`
            );

            opcoes.push('Conciliação Automática');
            opcoes.push('Limpar Conciliados');

            mostrarModalSelecao(
                'Gerenciar Conciliação',
                'Lançamentos manuais não conciliados:',
                opcoes,
                (indice) => {
                    if (indice === opcoes.length - 2) {
                        // Conciliação automática
                        const conciliacoes = conciliarLancamentosManuais();
                        saveTransactions();
                        applyFilters();
                        alert(`${conciliacoes} conciliações automáticas realizadas.`);
                    } else if (indice === opcoes.length - 1) {
                        // Limpar conciliados
                        const conciliados = transactions.filter(t => t.isManual && t.conciliado);
                        if (conciliados.length > 0 && confirm(`Remover ${conciliados.length} lançamentos manuais já conciliados?`)) {
                            transactions = transactions.filter(t => !(t.isManual && t.conciliado));
                            saveTransactions();
                            applyFilters();
                            alert('Lançamentos manuais conciliados foram removidos.');
                        }
                    }
                }
            );
        }


        function reconcileSelected() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) return alert('Nenhuma transação selecionada.');

            let reconciledCount = 0;
            transactions.forEach(t => {
                if (selectedIds.includes(t.identificador)) {
                    t.status = 'reconciled';
                    reconciledCount++;
                }
            });

            saveTransactions();
            applyFilters(true);
            clearSelection();
            alert(`${reconciledCount} transações foram marcadas como conciliadas.`);
        }

        // ===================================================================
        // NOVO BLOCO DE GERENCIAMENTO DE CATEGORIAS AQUI
        // ===================================================================

function renderCategoryManagerList() {
    const listContainer = document.getElementById('categoryManagerList');
    if (!listContainer) return;

    const editableCategories = categories.filter(cat => 
        !["Não classificada", "Comida", "Transporte", "Outros"].includes(cat)
    ).sort();

    if (editableCategories.length === 0) {
        listContainer.innerHTML = '<p class="text-muted p-2">Não há categorias personalizadas.</p>';
        setTimeout(() => {
            closeCurrentModal();
        }, 1000);
        return;
    }

    listContainer.innerHTML = '';
    editableCategories.forEach(cat => {
        const transactionCount = transactions.filter(t => t.categoria === cat).length;
        const classificacao = getClassificacaoCategoria(cat);
        
        const itemHTML = `
            <div class="category-manager-item">
                <div>
                    <strong>${cat}</strong> 
                    <small class="text-muted">(${transactionCount} transação${transactionCount !== 1 ? 'ões' : ''})</small>
                    <br>
                    <select class="form-select form-select-sm mt-1" style="max-width: 200px;" 
                            onchange="alterarClassificacaoCategoria('${cat.replace(/'/g, "\\'")}', this.value)">
                        <option value="necessidades" ${classificacao === 'necessidades' ? 'selected' : ''}>💡 Necessidades (50%)</option>
                        <option value="desejos" ${classificacao === 'desejos' ? 'selected' : ''}>🎉 Desejos (30%)</option>
                        <option value="poupanca" ${classificacao === 'poupanca' ? 'selected' : ''}>💰 Poupança (20%)</option>
                    </select>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${cat.replace(/'/g, "\\'")}')">Excluir</button>
            </div>
        `;
        listContainer.innerHTML += itemHTML;
    });
}

function alterarClassificacaoCategoria(categoria, novaClassificacao) {
    // Remove de todas as classificações
    Object.keys(classificacaoCategorias).forEach(tipo => {
        classificacaoCategorias[tipo] = classificacaoCategorias[tipo].filter(c => c !== categoria);
    });
    
    // Adiciona na nova classificação
    if (!classificacaoCategorias[novaClassificacao].includes(categoria)) {
        classificacaoCategorias[novaClassificacao].push(categoria);
    }
    
    salvarClassificacaoCategorias();
}
        /**
         * ATUALIZADO: Agora apenas abre o modal e chama a função para renderizar a lista.
         */
        function manageCategoriesModal() {
            const editableCategories = categories.filter(cat => !["Não classificada", "Comida", "Transporte", "Outros"].includes(cat));
            if (editableCategories.length === 0) {
                alert('Não há categorias personalizadas para gerenciar.');
                return;
            }
            // Chama a renderização da lista e depois abre o modal.
            renderCategoryManagerList();
            openModal('categoryModal');
        }

        /**
         * ATUALIZADO: Agora não fecha mais o modal, apenas atualiza a lista.
         */


        // Função para vincular o pagamento à fatura.

        function vincularPagamentoFatura(transacaoPagamento) {
            // 1. Determina o ID da fatura com base no MÊS DO PAGAMENTO.
            const dataPagamento = new Date(transacaoPagamento.data.split('/').reverse().join('-'));
            const idFaturaAlvo = `${dataPagamento.getFullYear()}-${String(dataPagamento.getMonth() + 1).padStart(2, '0')}`;

            // 2. Encontra todas as despesas de cartão pendentes que foram CORRETAMENTE associadas a esta fatura.
            const despesasParaPagar = transactions.filter(t => t.idFatura === idFaturaAlvo && t.status === 'pendente');

            if (despesasParaPagar.length === 0) {
                return 0;
            }

            // 3. Atualiza o status dessas despesas de 'pendente' para 'pago'.
            despesasParaPagar.forEach(despesa => {
                despesa.status = 'pago';
            });

            return despesasParaPagar.length;
        }


        // ===================================================================
        // SISTEMA DE ALERTAS INTELIGENTES
        // ===================================================================

        function verificarAlertasInteligentes() {
            const alertas = [];
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Alerta: Transação incomum (valor muito alto)
            const gastosUltimos30Dias = transactions.filter(t => {
                if (t.valor >= 0) return false;
                const transactionDate = new Date(t.data.split('/').reverse().join('-'));
                const diasAtras = (agora - transactionDate) / (1000 * 60 * 60 * 24);
                return diasAtras <= 30;
            }).map(t => Math.abs(t.valor));

            if (gastosUltimos30Dias.length > 0) {
                const mediaGastos = gastosUltimos30Dias.reduce((sum, v) => sum + v, 0) / gastosUltimos30Dias.length;
                const gastoMaximo = Math.max(...gastosUltimos30Dias);

                if (gastoMaximo > mediaGastos * 3) {
                    alertas.push({
                        tipo: 'anomalia',
                        prioridade: 'alta',
                        titulo: 'Transação Incomum Detectada',
                        descricao: `Gasto de ${gastoMaximo.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} muito acima da média`,
                        acao: 'Verifique se a transação está correta'
                    });
                }
            }

            // Alerta: Padrão de gastos mudou
            const ultimosMeses = getTransactionsByMonth(getTransactionsFromLastMonths(3));
            const mesesOrdenados = Object.keys(ultimosMeses).sort();

            if (mesesOrdenados.length >= 2) {
                const mesPassado = ultimosMeses[mesesOrdenados[mesesOrdenados.length - 2]];
                const mesAtualData = ultimosMeses[mesesOrdenados[mesesOrdenados.length - 1]];

                if (mesPassado && mesAtualData) {
                    const variacaoGastos = ((mesAtualData.expenses - mesPassado.expenses) / mesPassado.expenses) * 100;

                    if (variacaoGastos > 40) {
                        alertas.push({
                            tipo: 'tendencia',
                            prioridade: 'media',
                            titulo: 'Aumento Significativo nos Gastos',
                            descricao: `Gastos aumentaram ${variacaoGastos.toFixed(1)}% comparado ao mês anterior`,
                            acao: 'Revise suas categorias de gasto na aba Análise'
                        });
                    }
                }
            }

            // Alerta: Meta próxima de estourar
            const metasRisco = smartGoals.filter(m =>
                m.status === 'ativa' &&
                m.tipo === 'orcamento_categoria' &&
                m.progresso >= 90
            );

            metasRisco.forEach(meta => {
                alertas.push({
                    tipo: 'meta',
                    prioridade: 'critica',
                    titulo: 'Meta Quase Estourada',
                    descricao: `Meta "${meta.nome}" está em ${meta.progresso.toFixed(1)}%`,
                    acao: 'Controle os gastos nesta categoria'
                });
            });

            // Alerta: Boa performance financeira
            const last3MonthsData = getTransactionsFromLastMonths(3);
            const savingsRate = calculateSavingsRate(last3MonthsData);

            if (savingsRate > 25) {
                alertas.push({
                    tipo: 'positivo',
                    prioridade: 'baixa',
                    titulo: 'Ótima Performance!',
                    descricao: `Taxa de poupança de ${savingsRate.toFixed(1)}% nos últimos 3 meses`,
                    acao: 'Considere aumentar seus objetivos de investimento'
                });
            }

            return alertas;
        }

        function exibirAlertasInteligentes() {
            const alertas = verificarAlertasInteligentes();

            if (alertas.length === 0) return;

            const alertasRecentes = alertas.filter(a => a.prioridade === 'critica' || a.prioridade === 'alta');

            if (alertasRecentes.length > 0) {
                // Salva alertas para exibir no dashboard
                if (!window.alertasFinanceiros) window.alertasFinanceiros = [];

                alertasRecentes.forEach(alerta => {
                    const jaExiste = window.alertasFinanceiros.some(a =>
                        a.titulo === alerta.titulo && a.descricao === alerta.descricao
                    );

                    if (!jaExiste) {
                        window.alertasFinanceiros.push({
                            ...alerta,
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                // Mantém apenas os últimos 10 alertas
                if (window.alertasFinanceiros.length > 10) {
                    window.alertasFinanceiros = window.alertasFinanceiros.slice(-10);
                }
            }
        }

        // Sistema de notificações discretas
        function mostrarNotificacaoDiscreta(titulo, mensagem, tipo = 'info') {
            // Cria elemento de notificação
            const notification = document.createElement('div');
            notification.className = `alert alert-${tipo === 'critica' ? 'danger' : 
                                                   tipo === 'alta' ? 'warning' : 
                                                   tipo === 'positivo' ? 'success' : 'info'} 
                                                   position-fixed`;
            notification.style.cssText = `
                   top: 80px;
                   right: 20px;
                   z-index: 1060;
                   max-width: 300px;
                   box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                   opacity: 0;
                   transform: translateX(100%);
                   transition: all 0.3s ease;
               `;

            notification.innerHTML = `
                   <div class="d-flex justify-content-between align-items-start">
                       <div>
                           <strong>${titulo}</strong><br>
                           <small>${mensagem}</small>
                       </div>
                       <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                   </div>
               `;

            document.body.appendChild(notification);

            // Animação de entrada
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove automaticamente após 8 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 8000);
        }

        // ===================================================================
        // SISTEMA DE PLANEJAMENTO FINANCEIRO
        // ===================================================================

        const TIPOS_RESERVA = {
            EMERGENCIA: 'emergencia',
            OPORTUNIDADE: 'oportunidade',
            APOSENTADORIA: 'aposentadoria'
        };

        let orcamentoBaseZero = {
            rendaMensal: 0,
            alocacoes: {},
            dataUltimaAtualizacao: null,
            ativo: false
        };

        let objetivosLongoPrazo = [];
        let sistemaReservas = {};

        // Nova estrutura unificada de metas
        let metasMensais = []; // Apenas orçamento por categoria e redução
        let objetivosPoupanca = []; // Substitui objetivosLongoPrazo
        let reservasFinanceiras = {}; // Substitui sistemaReservas

        // Estrutura de histórico mensal
        let historicoMetas = {}; // Armazena desempenho das metas mês a mês

        function criarOrcamentoBaseZero() {
            mostrarModalInput(
                'Criar Orçamento Base Zero',
                'Qual sua renda mensal líquida (após impostos)?',
                'Ex: 5000',
                (valor) => {
                    const rendaAtual = parseFloat(valor);

                    if (isNaN(rendaAtual) || rendaAtual <= 0) {
                        alert('Por favor, informe uma renda válida.');
                        return;
                    }

                    // Pergunta o formato
                    mostrarModalSelecao(
                        'Formato do Orçamento',
                        'Escolha o formato inicial do seu orçamento:',
                        ['Por Categoria (baseado no histórico)', 'Regra 50/30/20'],
                        (indice) => {
                            if (indice === 0) {
                                criarOrcamentoPorCategoria(rendaAtual);
                            } else {
                                criarOrcamento503020(rendaAtual);
                            }
                        }
                    );
                }
            );
        }

        function criarOrcamentoPorCategoria(rendaAtual) {
            const last3Months = getTransactionsFromLastMonths(3);
            const gastosPorCategoria = {};

            last3Months.forEach(t => {
                if (t.valor < 0) {
                    gastosPorCategoria[t.categoria] = (gastosPorCategoria[t.categoria] || 0) + Math.abs(t.valor);
                }
            });

            Object.keys(gastosPorCategoria).forEach(cat => {
                gastosPorCategoria[cat] = gastosPorCategoria[cat] / 3;
            });

            const categoriasEssenciais = ['Habitação', 'Alimentação', 'Transporte', 'Saúde', 'Reserva Emergência'];
            categoriasEssenciais.forEach(cat => {
                if (!gastosPorCategoria[cat]) {
                    gastosPorCategoria[cat] = 0;
                }
            });

            orcamentoBaseZero = {
                rendaMensal: rendaAtual,
                alocacoes: {
                    ...gastosPorCategoria
                },
                formato: 'categorias',
                dataUltimaAtualizacao: new Date().toISOString(),
                ativo: true
            };

            salvarOrcamentoBaseZero();
            abrirEditorOrcamento();
        }

        function criarOrcamento503020(rendaAtual) {
            orcamentoBaseZero = {
                rendaMensal: rendaAtual,
                alocacoes: {
                    'Necessidades (50%)': rendaAtual * 0.5,
                    'Desejos (30%)': rendaAtual * 0.3,
                    'Poupança/Investimentos (20%)': rendaAtual * 0.2
                },
                formato: '503020',
                dataUltimaAtualizacao: new Date().toISOString(),
                ativo: true
            };

            salvarOrcamentoBaseZero();
            abrirEditorOrcamento();
        }

        function abrirEditorOrcamento() {
            const modal = criarModalOrcamento();
            document.body.appendChild(modal);
            openModal('orcamentoBaseZeroModal');

            renderizarEditorOrcamento();

            // Adiciona botão de alternar formato
            const footer = modal.querySelector('.modal-footer');
            const btnAlternar = document.createElement('button');
            btnAlternar.className = 'btn btn-outline-info me-auto';
            btnAlternar.textContent = orcamentoBaseZero.formato === '503020' ? 'Mudar para Categorias' : 'Mudar para 50/30/20';
            btnAlternar.onclick = alternarFormatoOrcamento;
            footer.prepend(btnAlternar);
        }

        function alternarFormatoOrcamento() {
            const rendaAtual = orcamentoBaseZero.rendaMensal;

            if (orcamentoBaseZero.formato === '503020') {
                criarOrcamentoPorCategoria(rendaAtual);
            } else {
                criarOrcamento503020(rendaAtual);
            }

            renderizarEditorOrcamento();
        }

        function criarModalOrcamento() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'orcamentoBaseZeroModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-lg modal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Orçamento Base Zero</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <div class="mb-3">
                                   <p class="text-muted">
                                       No orçamento base zero, cada real da sua renda deve ter um destino específico. 
                                       Aloque 100% da sua renda entre categorias de gastos, metas e reservas.
                                   </p>
                               </div>
                               
                               <div class="row mb-3">
                                   <div class="col-md-6">
                                       <strong>Renda Mensal: </strong>
                                       <span id="rendaMensalDisplay">${orcamentoBaseZero.rendaMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</span>
                                   </div>
                                   <div class="col-md-6">
                                       <strong>Total Alocado: </strong>
                                       <span id="totalAlocadoDisplay">R$ 0,00</span>
                                       <span id="statusAlocacao" class="badge ms-2">0%</span>
                                   </div>
                               </div>
                               
                               <div id="orcamentoEditor"></div>
                               
                               <div class="mt-3">
                                   <button class="btn btn-success btn-sm" onclick="adicionarNovaCategoria()">+ Adicionar Categoria</button>
                                   <button class="btn btn-outline-info btn-sm" onclick="aplicarRecomendacoes()">Aplicar Recomendações 50/30/20</button>
                               </div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                               <button type="button" class="btn btn-success" onclick="salvarOrcamentoCompleto()">Salvar Orçamento</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }

        function renderizarEditorOrcamento() {
            const container = document.getElementById('orcamentoEditor');
            if (!container) return;

            let html = '<div class="row">';
            let totalAlocado = 0;

            Object.entries(orcamentoBaseZero.alocacoes).forEach(([categoria, valor]) => {
                totalAlocado += valor;

                html += `
                       <div class="col-md-6 mb-3">
                           <div class="card">
                               <div class="card-body p-3">
                                   <div class="d-flex justify-content-between align-items-center mb-2">
                                       <strong>${categoria}</strong>
                                       <button class="btn btn-sm btn-outline-danger" onclick="removerCategoria('${categoria}')">×</button>
                                   </div>
                                   <div class="input-group input-group-sm">
                                       <span class="input-group-text">R$</span>
                                       <input type="number" inputmode="decimal" inputmode="decimal" class="form-control" value="${valor.toFixed(2)}" 
                                              step="0.01" min="0" onchange="atualizarAlocacao('${categoria}', this.value)">
                                       <span class="input-group-text">${orcamentoBaseZero.rendaMensal > 0 ? ((valor / orcamentoBaseZero.rendaMensal) * 100).toFixed(1) : 0}%</span>
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
            });

            html += '</div>';
            container.innerHTML = html;

            // Atualiza totais
            atualizarTotaisOrcamento(totalAlocado);
        }

        function atualizarAlocacao(categoria, novoValor) {
            const valor = parseFloat(novoValor) || 0;
            orcamentoBaseZero.alocacoes[categoria] = valor;

            const totalAlocado = Object.values(orcamentoBaseZero.alocacoes).reduce((sum, v) => sum + v, 0);
            atualizarTotaisOrcamento(totalAlocado);
        }

        function atualizarTotaisOrcamento(totalAlocado) {
            const totalDisplay = document.getElementById('totalAlocadoDisplay');
            const statusDisplay = document.getElementById('statusAlocacao');

            if (totalDisplay && statusDisplay) {
                const percentual = orcamentoBaseZero.rendaMensal > 0 ? (totalAlocado / orcamentoBaseZero.rendaMensal) * 100 : 0;

                totalDisplay.textContent = totalAlocado.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });
                statusDisplay.textContent = `${percentual.toFixed(1)}%`;

                if (Math.abs(percentual - 100) < 0.1) {
                    statusDisplay.className = 'badge bg-success ms-2';
                    statusDisplay.textContent += ' - Perfeito!';
                } else if (percentual > 100) {
                    statusDisplay.className = 'badge bg-danger ms-2';
                    statusDisplay.textContent += ' - Acima da renda';
                } else {
                    statusDisplay.className = 'badge bg-warning ms-2';
                    statusDisplay.textContent += ' - Falta alocar';
                }
            }
        }


        function aplicarRecomendacoes() {
            if (!confirm('Aplicar a regra 50/30/20? Isso sobrescreverá as alocações atuais.')) return;

            const renda = orcamentoBaseZero.rendaMensal;

            orcamentoBaseZero.alocacoes = {
                'Necessidades (50%)': renda * 0.5,
                'Desejos (30%)': renda * 0.3,
                'Poupança/Investimentos (20%)': renda * 0.2
            };

            renderizarEditorOrcamento();
        }

        function salvarOrcamentoCompleto() {
            const totalAlocado = Object.values(orcamentoBaseZero.alocacoes).reduce((sum, v) => sum + v, 0);
            const percentual = (totalAlocado / orcamentoBaseZero.rendaMensal) * 100;

            if (Math.abs(percentual - 100) > 5) {
                if (!confirm(`Orçamento está ${percentual > 100 ? 'acima' : 'abaixo'} de 100% (${percentual.toFixed(1)}%). Deseja salvar mesmo assim?`)) {
                    return;
                }
            }

            orcamentoBaseZero.dataUltimaAtualizacao = new Date().toISOString();
            salvarOrcamentoBaseZero();

            closeCurrentModal();
            alert('Orçamento Base Zero salvo com sucesso!');

            atualizarVisualizacaoFerramentas();
        }

        function salvarOrcamentoBaseZero() {
            localStorage.setItem('orcamentoBaseZero', JSON.stringify(orcamentoBaseZero));
        }

        function carregarOrcamentoBaseZero() {
            const saved = localStorage.getItem('orcamentoBaseZero');
            if (saved) {
                orcamentoBaseZero = JSON.parse(saved);
            }
        }



        // ===================================================================
        // SISTEMA DE CATEGORIZAÇÃO INTELIGENTE
        // ===================================================================

        let regrasCategorização = [];
        let historicoAprendizado = {};

        function carregarRegrasCategorização() {
            const saved = localStorage.getItem('regrasCategorização');
            if (saved) {
                regrasCategorização = JSON.parse(saved);
            }

            const savedHistorico = localStorage.getItem('historicoAprendizado');
            if (savedHistorico) {
                historicoAprendizado = JSON.parse(savedHistorico);
            }
        }

        function salvarRegrasCategorização() {
            localStorage.setItem('regrasCategorização', JSON.stringify(regrasCategorização));
            localStorage.setItem('historicoAprendizado', JSON.stringify(historicoAprendizado));
        }

        function criarRegraCategorizacao() {
            const modal = criarModalRegra();
            document.body.appendChild(modal);
            openModal('regraCategorizacaoModal');
        }

        function criarModalRegra() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'regraCategorizacaoModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Nova Regra de Categorização</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <div class="mb-3">
                                   <label class="form-label">Condição</label>
                                   <select id="regraCondicao" class="form-control" onchange="atualizarCamposRegra()">
                                       <option value="contem">Nome contém</option>
                                       <option value="comeca">Nome começa com</option>
                                       <option value="termina">Nome termina com</option>
                                       <option value="exato">Nome é exatamente</option>
                                       <option value="valor_maior">Valor maior que</option>
                                       <option value="valor_menor">Valor menor que</option>
                                   </select>
                               </div>
                               
                               <div class="mb-3" id="regraValorTexto">
                                   <label for="regraTexto" class="form-label">Texto</label>
                                   <input type="text" id="regraTexto" class="form-control" placeholder="Ex: iFood, Uber, Netflix">
                               </div>
                               
                               <div class="mb-3" id="regraValorNumero" style="display: none;">
                                   <label for="regraNumero" class="form-label">Valor (R$)</label>
                                   <input type="number" inputmode="decimal" inputmode="decimal" id="regraNumero" class="form-control" step="0.01">
                               </div>
                               
                               <div class="mb-3">
                                   <label for="regraCategoria" class="form-label">Aplicar Categoria</label>
                                   <select id="regraCategoria" class="form-control">
                                       ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                   </select>
                               </div>
                               
                               <div class="form-check">
                                   <input class="form-check-input" type="checkbox" id="regraAplicarExistentes">
                                   <label class="form-check-label" for="regraAplicarExistentes">
                                       Aplicar também às transações existentes
                                   </label>
                               </div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                               <button type="button" class="btn btn-primary" onclick="salvarRegra()">Criar Regra</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }

        function atualizarCamposRegra() {
            const condicao = document.getElementById('regraCondicao').value;
            const campoTexto = document.getElementById('regraValorTexto');
            const campoNumero = document.getElementById('regraValorNumero');

            if (condicao.startsWith('valor_')) {
                campoTexto.style.display = 'none';
                campoNumero.style.display = 'block';
            } else {
                campoTexto.style.display = 'block';
                campoNumero.style.display = 'none';
            }
        }

        function salvarRegra() {
            const condicao = document.getElementById('regraCondicao').value;
            const texto = document.getElementById('regraTexto').value.trim().toLowerCase();
            const numero = parseFloat(document.getElementById('regraNumero').value);
            const categoria = document.getElementById('regraCategoria').value;
            const aplicarExistentes = document.getElementById('regraAplicarExistentes').checked;

            if (condicao.startsWith('valor_')) {
                if (isNaN(numero)) {
                    alert('Informe um valor válido.');
                    return;
                }
            } else {
                if (!texto) {
                    alert('Informe o texto da regra.');
                    return;
                }
            }

            const novaRegra = {
                id: `regra-${Date.now()}`,
                condicao: condicao,
                valor: condicao.startsWith('valor_') ? numero : texto,
                categoria: categoria,
                ativa: true,
                criadaEm: new Date().toISOString(),
                vezesAplicada: 0
            };

            regrasCategorização.push(novaRegra);
            salvarRegrasCategorização();

            if (aplicarExistentes) {
                const aplicadas = aplicarRegraEmTransacoes(novaRegra);
                alert(`Regra criada e aplicada em ${aplicadas} transação(ões) existente(s).`);
                saveTransactions();
                applyFilters(true);
            } else {
                alert('Regra criada com sucesso!');
            }

            closeCurrentModal();
        }

        function aplicarRegraEmTransacoes(regra) {
            let contador = 0;

            transactions.forEach(t => {
                if (verificarRegra(t, regra)) {
                    t.categoria = regra.categoria;
                    contador++;
                }
            });

            regra.vezesAplicada += contador;
            return contador;
        }

        function verificarRegra(transacao, regra) {
            const nome = transacao.nome.toLowerCase();
            const valor = Math.abs(transacao.valor);

            switch (regra.condicao) {
                case 'contem':
                    return nome.includes(regra.valor);
                case 'comeca':
                    return nome.startsWith(regra.valor);
                case 'termina':
                    return nome.endsWith(regra.valor);
                case 'exato':
                    return nome === regra.valor;
                case 'valor_maior':
                    return valor > regra.valor;
                case 'valor_menor':
                    return valor < regra.valor;
                default:
                    return false;
            }
        }

        function aplicarRegrasAutomaticas(transacao) {
            for (const regra of regrasCategorização) {
                if (regra.ativa && verificarRegra(transacao, regra)) {
                    transacao.categoria = regra.categoria;
                    regra.vezesAplicada++;
                    salvarRegrasCategorização();
                    return true;
                }
            }
            return false;
        }

        function sugerirCategoriaPorHistorico(nomeTransacao) {
            const nome = nomeTransacao.toLowerCase();
            const palavrasChave = nome.split(/\s+/).filter(p => p.length > 3);

            const sugestoes = {};

            transactions.forEach(t => {
                if (t.categoria === 'Não classificada') return;

                const nomeExistente = t.nome.toLowerCase();

                palavrasChave.forEach(palavra => {
                    if (nomeExistente.includes(palavra)) {
                        sugestoes[t.categoria] = (sugestoes[t.categoria] || 0) + 1;
                    }
                });
            });

            if (Object.keys(sugestoes).length === 0) return null;

            const categoriaSugerida = Object.entries(sugestoes)
                .sort((a, b) => b[1] - a[1])[0][0];

            return categoriaSugerida;
        }

        function aprenderComUsuario(transacao, categoriaSelecionada) {
            const palavrasChave = transacao.nome.toLowerCase().split(/\s+/).filter(p => p.length > 3);

            palavrasChave.forEach(palavra => {
                if (!historicoAprendizado[palavra]) {
                    historicoAprendizado[palavra] = {};
                }

                historicoAprendizado[palavra][categoriaSelecionada] =
                    (historicoAprendizado[palavra][categoriaSelecionada] || 0) + 1;
            });

            salvarRegrasCategorização();
        }

        function gerenciarRegras() {
            const modal = criarModalGerenciarRegras();
            document.body.appendChild(modal);
            openModal('gerenciarRegrasModal');
        }

        function criarModalGerenciarRegras() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'gerenciarRegrasModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-lg modal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Gerenciar Regras de Categorização</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <div id="listaRegras"></div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Fechar</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }

        function renderizarListaRegras() {
            const container = document.getElementById('listaRegras');
            if (!container) return;

            if (regrasCategorização.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhuma regra criada ainda.</p>';
                return;
            }

            let html = '<div class="list-group">';

            regrasCategorização.forEach(regra => {
                const descricaoCondicao = {
                    'contem': 'contém',
                    'comeca': 'começa com',
                    'termina': 'termina com',
                    'exato': 'é exatamente',
                    'valor_maior': 'valor maior que',
                    'valor_menor': 'valor menor que'
                };

                const valorFormatado = regra.condicao.startsWith('valor_') ?
                    regra.valor.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }) :
                    `"${regra.valor}"`;

                html += `
                       <div class="list-group-item">
                           <div class="d-flex justify-content-between align-items-start">
                               <div>
                                   <h6 class="mb-1">
                                       Se nome ${descricaoCondicao[regra.condicao]} ${valorFormatado}
                                   </h6>
                                   <p class="mb-1">
                                       <strong>Então:</strong> Aplicar categoria "<span class="badge bg-info">${regra.categoria}</span>"
                                   </p>
                                   <small class="text-muted">Aplicada ${regra.vezesAplicada} vez(es)</small>
                               </div>
                               <div class="btn-group">
                                   <button class="btn btn-sm ${regra.ativa ? 'btn-success' : 'btn-secondary'}" 
                                           onclick="toggleRegra('${regra.id}')">
                                       ${regra.ativa ? 'Ativa' : 'Inativa'}
                                   </button>
                                   <button class="btn btn-sm btn-outline-danger" onclick="excluirRegra('${regra.id}')">
                                       Excluir
                                   </button>
                               </div>
                           </div>
                       </div>
                   `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function toggleRegra(regraId) {
            const regra = regrasCategorização.find(r => r.id === regraId);
            if (regra) {
                regra.ativa = !regra.ativa;
                salvarRegrasCategorização();
                renderizarListaRegras();
            }
        }

        function excluirRegra(regraId) {
            if (confirm('Tem certeza que deseja excluir esta regra?')) {
                regrasCategorização = regrasCategorização.filter(r => r.id !== regraId);
                salvarRegrasCategorização();
                renderizarListaRegras();
            }
        }

        // ===================================================================
        // ANÁLISE COMPORTAMENTAL DE PADRÕES
        // ===================================================================

        function analisarPadroesComportamentais() {
            const analise = {
                padroesDiaSemana: analisarPorDiaSemana(),
                padroesPeriodoMes: analisarPorPeriodoMes(),
                gatilhosGastos: identificarGatilhosGastos(),
                habitos: identificarHabitos(),
                anomalias: detectarAnomalias()
            };

            return analise;
        }

        function analisarPorDiaSemana() {
            const gastosPorDia = {
                0: {
                    nome: 'Domingo',
                    total: 0,
                    count: 0
                },
                1: {
                    nome: 'Segunda',
                    total: 0,
                    count: 0
                },
                2: {
                    nome: 'Terça',
                    total: 0,
                    count: 0
                },
                3: {
                    nome: 'Quarta',
                    total: 0,
                    count: 0
                },
                4: {
                    nome: 'Quinta',
                    total: 0,
                    count: 0
                },
                5: {
                    nome: 'Sexta',
                    total: 0,
                    count: 0
                },
                6: {
                    nome: 'Sábado',
                    total: 0,
                    count: 0
                }
            };

            transactions.forEach(t => {
                if (t.valor >= 0) return;

                const [day, month, year] = t.data.split('/').map(Number);
                const data = new Date(year, month - 1, day);
                const diaSemana = data.getDay();

                gastosPorDia[diaSemana].total += Math.abs(t.valor);
                gastosPorDia[diaSemana].count++;
            });

            const diaMaisGastos = Object.entries(gastosPorDia)
                .sort((a, b) => b[1].total - a[1].total)[0];

            return {
                distribuicao: gastosPorDia,
                diaMaisGastos: {
                    dia: diaMaisGastos[1].nome,
                    total: diaMaisGastos[1].total,
                    media: diaMaisGastos[1].count > 0 ? diaMaisGastos[1].total / diaMaisGastos[1].count : 0
                }
            };
        }

        function analisarPorPeriodoMes() {
            const periodos = {
                inicio: {
                    nome: 'Início do mês (1-10)',
                    total: 0,
                    count: 0
                },
                meio: {
                    nome: 'Meio do mês (11-20)',
                    total: 0,
                    count: 0
                },
                fim: {
                    nome: 'Fim do mês (21-31)',
                    total: 0,
                    count: 0
                }
            };

            transactions.forEach(t => {
                if (t.valor >= 0) return;

                const [day] = t.data.split('/').map(Number);

                if (day <= 10) {
                    periodos.inicio.total += Math.abs(t.valor);
                    periodos.inicio.count++;
                } else if (day <= 20) {
                    periodos.meio.total += Math.abs(t.valor);
                    periodos.meio.count++;
                } else {
                    periodos.fim.total += Math.abs(t.valor);
                    periodos.fim.count++;
                }
            });

            const periodoMaisGastos = Object.entries(periodos)
                .sort((a, b) => b[1].total - a[1].total)[0];

            return {
                distribuicao: periodos,
                periodoMaisGastos: {
                    periodo: periodoMaisGastos[1].nome,
                    total: periodoMaisGastos[1].total
                }
            };
        }

        function identificarGatilhosGastos() {
            const gatilhos = [];

            // Gatilho: Fins de semana
            const padroesDia = analisarPorDiaSemana();
            const gastosSemana = Object.entries(padroesDia.distribuicao)
                .filter(([dia]) => dia >= 1 && dia <= 5)
                .reduce((sum, [, dados]) => sum + dados.total, 0);
            const gastosFimSemana = padroesDia.distribuicao[0].total + padroesDia.distribuicao[6].total;

            if (gastosFimSemana > gastosSemana * 0.4) {
                gatilhos.push({
                    tipo: 'temporal',
                    descricao: 'Você tende a gastar mais nos fins de semana',
                    impacto: 'alto',
                    sugestao: 'Planeje atividades de baixo custo para sábado e domingo'
                });
            }

            // Gatilho: Delivery/Aplicativos
            const gastosDelivery = transactions.filter(t =>
                t.valor < 0 && (
                    t.nome.toLowerCase().includes('ifood') ||
                    t.nome.toLowerCase().includes('uber eats') ||
                    t.nome.toLowerCase().includes('rappi')
                )
            ).reduce((sum, t) => sum + Math.abs(t.valor), 0);

            const totalGastos = transactions
                .filter(t => t.valor < 0)
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            if (gastosDelivery > totalGastos * 0.15) {
                gatilhos.push({
                    tipo: 'categoria',
                    descricao: 'Gastos com delivery representam mais de 15% do total',
                    impacto: 'medio',
                    sugestao: 'Considere cozinhar mais em casa ou estabelecer um limite mensal para delivery'
                });
            }

            return gatilhos;
        }

        function identificarHabitos() {
            const habitos = [];

            // Detecta gastos recorrentes
            const gastosPorNome = {};

            transactions.forEach(t => {
                if (t.valor >= 0) return;
                const nomeSimplificado = t.nome.substring(0, 20).toLowerCase();

                if (!gastosPorNome[nomeSimplificado]) {
                    gastosPorNome[nomeSimplificado] = {
                        count: 0,
                        total: 0,
                        datas: []
                    };
                }

                gastosPorNome[nomeSimplificado].count++;
                gastosPorNome[nomeSimplificado].total += Math.abs(t.valor);
                gastosPorNome[nomeSimplificado].datas.push(t.data);
            });

            Object.entries(gastosPorNome)
                .filter(([, dados]) => dados.count >= 3)
                .forEach(([nome, dados]) => {
                    habitos.push({
                        tipo: 'recorrente',
                        descricao: `Gasto frequente: "${nome}" (${dados.count}x)`,
                        total: dados.total,
                        frequencia: dados.count
                    });
                });

            return habitos.sort((a, b) => b.total - a.total).slice(0, 5);
        }

        function detectarAnomalias() {
            const anomalias = [];
            const last3Months = getTransactionsFromLastMonths(3);
            const valores = last3Months.filter(t => t.valor < 0).map(t => Math.abs(t.valor));

            if (valores.length < 10) return anomalias;

            const media = valores.reduce((sum, v) => sum + v, 0) / valores.length;
            const desvioPadrao = Math.sqrt(
                valores.reduce((sum, v) => sum + Math.pow(v - media, 2), 0) / valores.length
            );

            const limite = media + (desvioPadrao * 2);

            last3Months.forEach(t => {
                if (t.valor < 0 && Math.abs(t.valor) > limite) {
                    anomalias.push({
                        data: t.data,
                        nome: t.nome,
                        valor: Math.abs(t.valor),
                        desvio: ((Math.abs(t.valor) - media) / media * 100).toFixed(1)
                    });
                }
            });

            return anomalias;
        }

        function renderizarAnaliseComportamental() {
            const analise = analisarPadroesComportamentais();

            return `
                   <div class="analise-comportamental">
                       <h5>Análise de Padrões de Comportamento</h5>
                       
            
                       <div class="card mb-3">
                           <div class="card-body">
                               <h6>Quando você mais gasta?</h6>
                               <p><strong>Dia da semana:</strong> ${analise.padroesDiaSemana.diaMaisGastos.dia} 
                                  (${analise.padroesDiaSemana.diaMaisGastos.total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})</p>
                               <p><strong>Período do mês:</strong> ${analise.padroesPeriodoMes.periodoMaisGastos.periodo} 
                                  (${analise.padroesPeriodoMes.periodoMaisGastos.total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})</p>
                           </div>
                       </div>
                       
            
                       ${analise.gatilhosGastos.length > 0 ? `
                       <div class="card mb-3">
                           <div class="card-body">
                               <h6>Gatilhos de Gastos Identificados</h6>
                               ${analise.gatilhosGastos.map(gatilho => `
                                   <div class="alert alert-${gatilho.impacto === 'alto' ? 'warning' : 'info'} py-2 mb-2">
                                       <strong>${gatilho.descricao}</strong><br>
                                       <small>${gatilho.sugestao}</small>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                       ` : ''}
                       
              
                       ${analise.habitos.length > 0 ? `
                       <div class="card mb-3">
                           <div class="card-body">
                               <h6>Hábitos Financeiros</h6>
                               <ul class="list-unstyled">
                                   ${analise.habitos.map(habito => `
                                       <li class="mb-2">
                                           ${habito.descricao}<br>
                                           <small class="text-muted">Total: ${habito.total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</small>
                                       </li>
                                   `).join('')}
                               </ul>
                           </div>
                       </div>
                       ` : ''}
                       
             
                       ${analise.anomalias.length > 0 ? `
                       <div class="card">
                           <div class="card-body">
                               <h6>Transações Atípicas Detectadas</h6>
                               <small class="text-muted">Gastos muito acima da sua média</small>
                               <ul class="list-unstyled mt-2">
                                   ${analise.anomalias.map(anomalia => `
                                       <li class="mb-1">
                                           ${anomalia.data} - ${anomalia.nome}: ${anomalia.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                           <span class="badge bg-warning">${anomalia.desvio}% acima da média</span>
                                       </li>
                                   `).join('')}
                               </ul>
                           </div>
                       </div>
                       ` : ''}
                   </div>
               `;
        }

        // ===================================================================
        // SIMULADOR "E SE" (WHAT-IF SCENARIOS)
        // ===================================================================

        function abrirSimuladorEse() {
            const modal = criarModalSimulador();
            document.body.appendChild(modal);
            openModal('simuladorEseModal');
        }

        function criarModalSimulador() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'simuladorEseModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-lgmodal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Simulador "E Se?"</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <p class="text-muted">Simule mudanças nos seus gastos e veja o impacto no seu orçamento</p>
                               
                               <div class="mb-3">
                                   <label class="form-label">Tipo de Simulação</label>
                                   <select id="tipoSimulacao" class="form-control" onchange="atualizarCamposSimulacao()">
                                       <option value="">Selecione...</option>
                                       <option value="reduzir_categoria">Reduzir gastos em uma categoria</option>
                                       <option value="aumentar_categoria">Aumentar gastos em uma categoria</option>
                                       <option value="eliminar_categoria">Eliminar completamente uma categoria</option>
                                       <option value="nova_despesa">Adicionar nova despesa recorrente</option>
                                       <option value="aumento_renda">Simular aumento de renda</option>
                                   </select>
                               </div>
                               
                               <div id="camposSimulacao"></div>
                               
                               <div id="resultadoSimulacao" class="mt-4"></div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Fechar</button>
                               <button type="button" class="btn btn-primary" onclick="executarSimulacao()">Simular</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }

        function atualizarCamposSimulacao() {
            const tipo = document.getElementById('tipoSimulacao').value;
            const container = document.getElementById('camposSimulacao');

            if (!tipo) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            switch (tipo) {
                case 'reduzir_categoria':
                case 'aumentar_categoria':
                case 'eliminar_categoria':
                    html = `
                           <div class="mb-3">
                               <label class="form-label">Categoria</label>
                               <select id="simulacaoCategoria" class="form-control">
                                   ${categories.filter(c => c !== 'Não classificada').map(cat => 
                                       `<option value="${cat}">${cat}</option>`
                                   ).join('')}
                               </select>
                           </div>
                       `;

                    if (tipo !== 'eliminar_categoria') {
                        html += `
                               <div class="mb-3">
                                   <label class="form-label">${tipo === 'reduzir_categoria' ? 'Reduzir' : 'Aumentar'} em (%)</label>
                                   <input type="number" inputmode="decimal" inputmode="decimal" id="simulacaoPercentual" class="form-control" value="10" min="1" max="100">
                               </div>
                           `;
                    }
                    break;

                case 'nova_despesa':
                    html = `
                           <div class="mb-3">
                               <label class="form-label">Nome da Despesa</label>
                               <input type="text" id="simulacaoNome" class="form-control" placeholder="Ex: Academia, Streaming">
                           </div>
                           <div class="mb-3">
                               <label class="form-label">Valor Mensal (R$)</label>
                               <input type="number" inputmode="decimal" inputmode="decimal" id="simulacaoValor" class="form-control" step="0.01" min="0">
                           </div>
                           <div class="mb-3">
                               <label class="form-label">Categoria</label>
                               <select id="simulacaoCategoria" class="form-control">
                                   ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                               </select>
                           </div>
                       `;
                    break;

                case 'aumento_renda':
                    html = `
                           <div class="mb-3">
                               <label class="form-label">Aumento de Renda (%)</label>
                               <input type="number" inputmode="decimal" inputmode="decimal" id="simulacaoPercentual" class="form-control" value="10" min="1" max="200">
                           </div>
                       `;
                    break;
            }

            container.innerHTML = html;
        }

        function executarSimulacao() {
            const tipo = document.getElementById('tipoSimulacao').value;
            if (!tipo) {
                alert('Selecione um tipo de simulação');
                return;
            }

            let resultado;

            switch (tipo) {
                case 'reduzir_categoria':
                    resultado = simularReducaoCategoria();
                    break;
                case 'aumentar_categoria':
                    resultado = simularAumentoCategoria();
                    break;
                case 'eliminar_categoria':
                    resultado = simularEliminacaoCategoria();
                    break;
                case 'nova_despesa':
                    resultado = simularNovaDespesa();
                    break;
                case 'aumento_renda':
                    resultado = simularAumentoRenda();
                    break;
            }

            exibirResultadoSimulacao(resultado);
        }

        function simularReducaoCategoria() {
            const categoria = document.getElementById('simulacaoCategoria').value;
            const percentual = parseFloat(document.getElementById('simulacaoPercentual').value) / 100;

            const gastoAtual = calcularGastoMensalCategoria(categoria);
            const novoGasto = gastoAtual * (1 - percentual);
            const economia = gastoAtual - novoGasto;

            const situacaoAtual = calcularSituacaoFinanceira();
            const novaSituacao = {
                ...situacaoAtual,
                gastosMensais: situacaoAtual.gastosMensais - economia,
                economiaMensal: situacaoAtual.economiaMensal + economia
            };

            return {
                tipo: 'reduzir_categoria',
                categoria: categoria,
                percentual: percentual * 100,
                gastoAtual: gastoAtual,
                novoGasto: novoGasto,
                economiaAnual: economia * 12,
                situacaoAtual: situacaoAtual,
                novaSituacao: novaSituacao
            };
        }

        function simularAumentoCategoria() {
            const categoria = document.getElementById('simulacaoCategoria').value;
            const percentual = parseFloat(document.getElementById('simulacaoPercentual').value) / 100;

            const gastoAtual = calcularGastoMensalCategoria(categoria);
            const novoGasto = gastoAtual * (1 + percentual);
            const aumento = novoGasto - gastoAtual;

            const situacaoAtual = calcularSituacaoFinanceira();
            const novaSituacao = {
                ...situacaoAtual,
                gastosMensais: situacaoAtual.gastosMensais + aumento,
                economiaMensal: situacaoAtual.economiaMensal - aumento
            };

            return {
                tipo: 'aumentar_categoria',
                categoria: categoria,
                percentual: percentual * 100,
                gastoAtual: gastoAtual,
                novoGasto: novoGasto,
                impactoAnual: aumento * 12,
                situacaoAtual: situacaoAtual,
                novaSituacao: novaSituacao
            };
        }

        function simularEliminacaoCategoria() {
            const categoria = document.getElementById('simulacaoCategoria').value;
            const gastoAtual = calcularGastoMensalCategoria(categoria);

            const situacaoAtual = calcularSituacaoFinanceira();
            const novaSituacao = {
                ...situacaoAtual,
                gastosMensais: situacaoAtual.gastosMensais - gastoAtual,
                economiaMensal: situacaoAtual.economiaMensal + gastoAtual
            };

            return {
                tipo: 'eliminar_categoria',
                categoria: categoria,
                gastoAtual: gastoAtual,
                economiaAnual: gastoAtual * 12,
                situacaoAtual: situacaoAtual,
                novaSituacao: novaSituacao
            };
        }

        function simularNovaDespesa() {
            const nome = document.getElementById('simulacaoNome').value;
            const valor = parseFloat(document.getElementById('simulacaoValor').value);
            const categoria = document.getElementById('simulacaoCategoria').value;

            if (!nome || isNaN(valor)) {
                alert('Preencha todos os campos');
                return null;
            }

            const situacaoAtual = calcularSituacaoFinanceira();
            const novaSituacao = {
                ...situacaoAtual,
                gastosMensais: situacaoAtual.gastosMensais + valor,
                economiaMensal: situacaoAtual.economiaMensal - valor
            };

            return {
                tipo: 'nova_despesa',
                nome: nome,
                valor: valor,
                categoria: categoria,
                impactoAnual: valor * 12,
                situacaoAtual: situacaoAtual,
                novaSituacao: novaSituacao
            };
        }

        function simularAumentoRenda() {
            const percentual = parseFloat(document.getElementById('simulacaoPercentual').value) / 100;

            const situacaoAtual = calcularSituacaoFinanceira();
            const aumentoRenda = situacaoAtual.rendaMensal * percentual;

            const novaSituacao = {
                ...situacaoAtual,
                rendaMensal: situacaoAtual.rendaMensal + aumentoRenda,
                economiaMensal: situacaoAtual.economiaMensal + aumentoRenda
            };

            return {
                tipo: 'aumento_renda',
                percentual: percentual * 100,
                rendaAtual: situacaoAtual.rendaMensal,
                novaRenda: novaSituacao.rendaMensal,
                aumentoAnual: aumentoRenda * 12,
                situacaoAtual: situacaoAtual,
                novaSituacao: novaSituacao
            };
        }

        function calcularGastoMensalCategoria(categoria) {
            const last3Months = getTransactionsFromLastMonths(3);
            const total = last3Months
                .filter(t => t.categoria === categoria && t.valor < 0)
                .reduce((sum, t) => sum + Math.abs(t.valor), 0);

            return total / 3; // Média mensal
        }

        function calcularSituacaoFinanceira() {
            const last3Months = getTransactionsFromLastMonths(3);
            const monthlyData = getTransactionsByMonth(last3Months);
            const months = Object.values(monthlyData);

            const rendaMensal = orcamentoBaseZero.rendaMensal ||
                (months.reduce((sum, m) => sum + m.income, 0) / months.length);

            const gastosMensais = months.reduce((sum, m) => sum + m.expenses, 0) / months.length;
            const economiaMensal = rendaMensal - gastosMensais;
            const taxaPoupanca = rendaMensal > 0 ? (economiaMensal / rendaMensal) * 100 : 0;

            return {
                rendaMensal,
                gastosMensais,
                economiaMensal,
                taxaPoupanca
            };
        }

        function exibirResultadoSimulacao(resultado) {
            if (!resultado) return;

            const container = document.getElementById('resultadoSimulacao');

            let html = '<div class="card bg-light">';
            html += '<div class="card-body">';
            html += '<h6>Resultado da Simulação</h6>';

            switch (resultado.tipo) {
                case 'reduzir_categoria':
                    html += `
                           <p><strong>Reduzindo ${resultado.percentual}% em "${resultado.categoria}"</strong></p>
                           <p>Gasto atual: ${resultado.gastoAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês</p>
                           <p>Novo gasto: ${resultado.novoGasto.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês</p>
                           <p class="text-success"><strong>Economia anual: ${resultado.economiaAnual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></p>
                       `;
                    break;

                case 'eliminar_categoria':
                    html += `
                           <p><strong>Eliminando completamente "${resultado.categoria}"</strong></p>
                           <p>Gasto atual: ${resultado.gastoAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês</p>
                           <p class="text-success"><strong>Economia anual: ${resultado.economiaAnual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></p>
                       `;
                    break;

                case 'nova_despesa':
                    html += `
                           <p><strong>Adicionando: ${resultado.nome}</strong></p>
                           <p>Valor mensal: ${resultado.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</p>
                           <p class="text-danger"><strong>Impacto anual: ${resultado.impactoAnual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></p>
                       `;
                    break;

                case 'aumento_renda':
                    html += `
                           <p><strong>Aumentando renda em ${resultado.percentual}%</strong></p>
                           <p>Renda atual: ${resultado.rendaAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês</p>
                           <p>Nova renda: ${resultado.novaRenda.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês</p>
                           <p class="text-success"><strong>Ganho anual: ${resultado.aumentoAnual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></p>
                       `;
                    break;
            }

            html += '<hr>';
            html += '<h6>Comparação Financeira</h6>';
            html += '<div class="row">';
            html += '<div class="col-6">';
            html += '<strong>Situação Atual</strong><br>';
            html += `Economia: ${resultado.situacaoAtual.economiaMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês<br>`;
            html += `Taxa: ${resultado.situacaoAtual.taxaPoupanca.toFixed(1)}%`;
            html += '</div>';
            html += '<div class="col-6">';
            html += '<strong>Nova Situação</strong><br>';
            html += `<span class="${resultado.novaSituacao.economiaMensal >= resultado.situacaoAtual.economiaMensal ? 'text-success' : 'text-danger'}">`;
            html += `Economia: ${resultado.novaSituacao.economiaMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}/mês<br>`;
            html += `Taxa: ${resultado.novaSituacao.taxaPoupanca.toFixed(1)}%`;
            html += '</span>';
            html += '</div>';
            html += '</div>';

            html += '</div></div>';

            container.innerHTML = html;
        }

        function abrirAnaliseComportamental() {
            const modal = criarModalAnaliseComportamental();
            document.body.appendChild(modal);
            openModal('analiseComportamentalModal');

            const container = document.getElementById('analiseComportamentalContent');
            if (container) {
                container.innerHTML = renderizarAnaliseComportamental();
            }
        }

        function criarModalAnaliseComportamental() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'analiseComportamentalModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-xl modal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Análise Comportamental de Gastos</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <div id="analiseComportamentalContent"></div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Fechar</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }


        // ===================================================================
        // SISTEMA DE OBJETIVOS DE LONGO PRAZO
        // ===================================================================

        function criarObjetivoLongoPrazo() {
            const modal = criarModalObjetivo();
            document.body.appendChild(modal);
            openModal('objetivoLongoPrazoModal');
        }

        function criarModalObjetivo() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'objetivoLongoPrazoModal';
            modal.style.display = 'none';

            modal.innerHTML = `
                   <div class="modal-dialog modal-scrollable">
                       <div class="modal-content">
                           <div class="modal-header">
                               <h5 class="modal-title">Novo Objetivo de Longo Prazo</h5>
                               <button type="button" class="btn-close" onclick="closeCurrentModal()"></button>
                           </div>
                           <div class="modal-body">
                               <div class="mb-3">
                                   <label for="objetivoNome" class="form-label">Nome do Objetivo</label>
                                   <input type="text" id="objetivoNome" class="form-control" placeholder="Ex: Casa própria, Carro, Viagem">
                               </div>
                               
                               <div class="mb-3">
                                   <label for="objetivoValor" class="form-label">Valor Total</label>
                                   <div class="input-group">
                                       <span class="input-group-text">R$</span>
                                       <input type="number" inputmode="decimal" inputmode="decimal" id="objetivoValor" class="form-control" step="0.01" min="0">
                                   </div>
                               </div>
                               
                               <div class="mb-3">
                                   <label for="objetivoData" class="form-label">Data Desejada</label>
                                   <input type="date" id="objetivoData" class="form-control">
                               </div>
                               
                               <div class="mb-3">
                                   <label for="objetivoPrioridade" class="form-label">Prioridade</label>
                                   <select id="objetivoPrioridade" class="form-control">
                                       <option value="alta">Alta - Foco principal</option>
                                       <option value="media" selected>Média - Importante</option>
                                       <option value="baixa">Baixa - Quando possível</option>
                                   </select>
                               </div>
                               
                               <div class="mb-3">
                                   <label for="objetivoDescricao" class="form-label">Descrição (opcional)</label>
                                   <textarea id="objetivoDescricao" class="form-control" rows="3" placeholder="Detalhes sobre este objetivo..."></textarea>
                               </div>
                               
                               <div id="calculadoraObjetivo" class="alert alert-info" style="display: none;"></div>
                           </div>
                           <div class="modal-footer">
                               <button type="button" class="btn btn-secondary" onclick="closeCurrentModal()">Cancelar</button>
                               <button type="button" class="btn btn-primary" onclick="salvarObjetivo()">Criar Objetivo</button>
                           </div>
                       </div>
                   </div>
               `;

            return modal;
        }

        function salvarObjetivo() {
            const nome = document.getElementById('objetivoNome').value.trim();
            const valor = parseFloat(document.getElementById('objetivoValor').value);
            const data = document.getElementById('objetivoData').value;
            const prioridade = document.getElementById('objetivoPrioridade').value;
            const descricao = document.getElementById('objetivoDescricao').value.trim();

            if (!nome || isNaN(valor) || valor <= 0 || !data) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const dataObjetivo = new Date(data);
            const agora = new Date();

            if (dataObjetivo <= agora) {
                alert('A data do objetivo deve ser futura.');
                return;
            }

            const mesesRestantes = Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24 * 30));
            const valorMensal = valor / mesesRestantes;

            const novoObjetivo = {
                id: `objetivo-${Date.now()}`,
                nome: nome,
                valor: valor,
                dataDesejada: data,
                prioridade: prioridade,
                descricao: descricao,
                valorJuntado: 0,
                dataCriacao: new Date().toISOString(),
                mesesRestantes: mesesRestantes,
                valorMensalNecessario: valorMensal,
                historicoPoupanca: []
            };

            objetivosLongoPrazo.push(novoObjetivo);
            if (!categories.includes(nome)) {
                categories.push(nome);
            }

            salvarObjetivosLongoPrazo();

            closeCurrentModal();
            alert(`Objetivo "${nome}" criado! Você precisa poupar ${valorMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} por mês.`);

            atualizarVisualizacaoFerramentas();
        }

        function atualizarObjetivo(objetivoId, valorPoupado) {
            const objetivo = objetivosLongoPrazo.find(obj => obj.id === objetivoId);
            if (!objetivo) return;

            objetivo.valorJuntado += valorPoupado;
            objetivo.historicoPoupanca.push({
                data: new Date().toISOString(),
                valor: valorPoupado
            });

            // Recalcula tempo restante
            const dataObjetivo = new Date(objetivo.dataDesejada);
            const agora = new Date();
            objetivo.mesesRestantes = Math.max(0, Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24 * 30)));

            const valorRestante = objetivo.valor - objetivo.valorJuntado;
            objetivo.valorMensalNecessario = objetivo.mesesRestantes > 0 ? valorRestante / objetivo.mesesRestantes : 0;

            salvarObjetivosLongoPrazo();
        }

        function excluirObjetivo(objetivoId) {
            const objetivo = objetivosLongoPrazo.find(obj => obj.id === objetivoId);
            if (!objetivo) return;

            if (confirm(`Tem certeza que deseja excluir o objetivo "${objetivo.nome}"?`)) {
                objetivosLongoPrazo = objetivosLongoPrazo.filter(obj => obj.id !== objetivoId);
                salvarObjetivosLongoPrazo();
                atualizarVisualizacaoFerramentas();
            }
        }

        function salvarObjetivosLongoPrazo() {
            localStorage.setItem('objetivosLongoPrazo', JSON.stringify(objetivosLongoPrazo));
        }

        function carregarObjetivosLongoPrazo() {
            const saved = localStorage.getItem('objetivosLongoPrazo');
            if (saved) {
                objetivosLongoPrazo = JSON.parse(saved);
            }
        }

        // ===================================================================
        // SISTEMA DE RESERVAS ESTRUTURADO
        // ===================================================================

        function inicializarSistemaReservas() {
            if (Object.keys(sistemaReservas).length === 0) {
                sistemaReservas = {
                    [TIPOS_RESERVA.EMERGENCIA]: {
                        nome: 'Reserva de Emergência',
                        descricao: 'Para situações imprevistas (perda de emprego, emergências médicas)',
                        metaMeses: 6,
                        valorAtual: 0,
                        prioridade: 'critica',
                        percentualRenda: 0.10 // 10% da renda por mês
                    },
                    [TIPOS_RESERVA.OPORTUNIDADE]: {
                        nome: 'Reserva de Oportunidade',
                        descricao: 'Para aproveitar boas oportunidades de investimento',
                        metaValor: 10000,
                        valorAtual: 0,
                        prioridade: 'media',
                        percentualRenda: 0.05 // 5% da renda por mês
                    },
                    [TIPOS_RESERVA.APOSENTADORIA]: {
                        nome: 'Previdência Privada',
                        descricao: 'Para complementar aposentadoria do INSS',
                        metaIdade: 60,
                        valorAtual: 0,
                        prioridade: 'alta',
                        percentualRenda: 0.15 // 15% da renda por mês
                    }
                };
                Object.values(sistemaReservas).forEach(reserva => {
                    if (!categories.includes(reserva.nome)) {
                        categories.push(reserva.nome);
                    }
                });

                salvarSistemaReservas();
            }
        }

        function calcularMetasReservas() {
            const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
            const rendaEstimada = orcamentoBaseZero.rendaMensal || (burnRate * 1.3); // Estima renda como 30% acima dos gastos

            // Atualiza meta da reserva de emergência
            sistemaReservas[TIPOS_RESERVA.EMERGENCIA].metaValor = burnRate * sistemaReservas[TIPOS_RESERVA.EMERGENCIA].metaMeses;

            // Calcula quanto contribuir mensalmente para cada reserva
            Object.keys(sistemaReservas).forEach(tipo => {
                const reserva = sistemaReservas[tipo];
                reserva.contribuicaoMensalSugerida = rendaEstimada * reserva.percentualRenda;
            });

            return sistemaReservas;
        }

        function atualizarReserva(tipo, novoValor) {
            if (sistemaReservas[tipo]) {
                sistemaReservas[tipo].valorAtual = novoValor;
                salvarSistemaReservas();
                atualizarVisualizacaoFerramentas();
            }
        }

        function renderizarSistemaReservas() {
            const reservasAtualizadas = calcularMetasReservas();

            let html = '<div class="row">';

            Object.entries(reservasAtualizadas).forEach(([tipo, reserva]) => {
                const metaValor = reserva.metaValor || 0;
                const progresso = metaValor > 0 ? (reserva.valorAtual / metaValor) * 100 : 0;
                const corProgresso = progresso >= 100 ? 'success' : progresso >= 50 ? 'warning' : 'danger';

                html += `
                       <div class="col-md-4 mb-3">
                           <div class="card h-100">
                               <div class="card-body">
                                   <div class="d-flex justify-content-between align-items-start mb-2">
                                       <h6 class="card-title">${reserva.nome}</h6>
                                       <span class="badge bg-${reserva.prioridade === 'critica' ? 'danger' : 
                                                              reserva.prioridade === 'alta' ? 'warning' : 'info'}">
                                           ${reserva.prioridade}
                                       </span>
                                   </div>
                                   
                                   <p class="card-text small text-muted">${reserva.descricao}</p>
                                   
                                   <div class="mb-3">
                                       <div class="d-flex justify-content-between mb-1">
                                           <small>Progresso</small>
                                           <small>${progresso.toFixed(1)}%</small>
                                       </div>
                                       <div class="progress" style="height: 8px;">
                                           <div class="progress-bar bg-${corProgresso}" style="width: ${Math.min(progresso, 100)}%"></div>
                                       </div>
                                   </div>
                                   
                                   <div class="small mb-2">
                                       <strong>Atual:</strong> ${reserva.valorAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}<br>
                                       <strong>Meta:</strong> ${metaValor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}<br>
                                       ${reserva.contribuicaoMensalSugerida ? 
                                           `<strong>Sugestão mensal:</strong> ${reserva.contribuicaoMensalSugerida.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}` 
                                           : ''}
                                   </div>
                                   
                                   <div class="input-group input-group-sm">
                                       <span class="input-group-text">R$</span>
                                       <input type="number" inputmode="decimal" inputmode="decimal" class="form-control" placeholder="Valor atual" 
                                              value="${reserva.valorAtual}" step="0.01" min="0"
                                              onchange="atualizarReserva('${tipo}', parseFloat(this.value) || 0)">
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
            });

            html += '</div>';

            return html;
        }

        function salvarSistemaReservas() {
            localStorage.setItem('sistemaReservas', JSON.stringify(sistemaReservas));
        }

        function carregarSistemaReservas() {
            const saved = localStorage.getItem('sistemaReservas');
            if (saved) {
                sistemaReservas = JSON.parse(saved);
            } else {
                inicializarSistemaReservas();
            }
        }

        // ===================================================================
        // SISTEMA UNIFICADO DE METAS, OBJETIVOS E RESERVAS
        // ===================================================================

function inicializarSistemaMetasUnificado() {
    carregarMetasMensais();
    carregarObjetivosPoupanca();
    carregarReservasFinanceiras();
    carregarHistoricoMetas();
    carregarClassificacaoCategorias();
    migrarDadosAntigos();
    
    // ADICIONA: Garante que categorias de objetivos e reservas estejam disponíveis
    objetivosPoupanca.forEach(obj => {
        const nomeCategoria = `Poupança: ${obj.nome}`;
        if (!categories.includes(nomeCategoria)) {
            categories.push(nomeCategoria);
        }
        if (!classificacaoCategorias.poupanca.includes(nomeCategoria)) {
            classificacaoCategorias.poupanca.push(nomeCategoria);
        }
    });
    
    Object.values(reservasFinanceiras).forEach(reserva => {
        if (!categories.includes(reserva.nome)) {
            categories.push(reserva.nome);
        }
        if (!classificacaoCategorias.poupanca.includes(reserva.nome)) {
            classificacaoCategorias.poupanca.push(reserva.nome);
        }
    });
    
    updateFilterCategories();
    salvarClassificacaoCategorias();
}

        function migrarDadosAntigos() {
            let precisaSalvar = false;

            // Migra metas antigas para o novo sistema
            if (smartGoals && smartGoals.length > 0) {
                smartGoals.forEach(meta => {
                    if (meta.tipo === TIPOS_META.ORCAMENTO_CATEGORIA ||
                        meta.tipo === TIPOS_META.REDUCAO_GASTO) {

                        // Verifica se já não foi migrada
                        if (!metasMensais.find(m => m.id === meta.id)) {
                            metasMensais.push(meta);
                            precisaSalvar = true;
                        }
                    }
                });
            }

            // Migra objetivos de longo prazo
            if (objetivosLongoPrazo && objetivosLongoPrazo.length > 0) {
                objetivosLongoPrazo.forEach(obj => {
                    if (!objetivosPoupanca.find(o => o.id === obj.id)) {
                        const novoObjetivo = {
                            ...obj,
                            contribuicaoMensal: 0,
                            historicoMensal: []
                        };
                        objetivosPoupanca.push(novoObjetivo);

                        // Cria categoria automática
                        const nomeCategoria = `Poupança: ${obj.nome}`;
                        if (!categories.includes(nomeCategoria)) {
                            categories.push(nomeCategoria);
                        }

                        precisaSalvar = true;
                    }
                });
            }

            // Migra sistema de reservas
            if (sistemaReservas && Object.keys(sistemaReservas).length > 0) {
                Object.entries(sistemaReservas).forEach(([tipo, reserva]) => {
                    if (!reservasFinanceiras[tipo]) {
                        reservasFinanceiras[tipo] = {
                            ...reserva,
                            contribuicaoMensal: 0,
                            historicoMensal: []
                        };

                        // Cria categoria automática
                        if (!categories.includes(reserva.nome)) {
                            categories.push(reserva.nome);
                        }

                        precisaSalvar = true;
                    }
                });
            } else {
                // Inicializa reservas padrão se não existir
                inicializarReservasPadrao();
                precisaSalvar = true;
            }

            if (precisaSalvar) {
                salvarTodosSistemas();
                updateFilterCategories();
            }
        }

        function inicializarReservasPadrao() {
            reservasFinanceiras = {
                [TIPOS_RESERVA.EMERGENCIA]: {
                    id: 'reserva-emergencia',
                    nome: 'Reserva de Emergência',
                    descricao: 'Para situações imprevistas (6 meses de gastos)',
                    metaMeses: 6,
                    valorAtual: 0,
                    valorMeta: 0,
                    prioridade: 'critica',
                    percentualRenda: 0.10,
                    contribuicaoMensal: 0,
                    historicoMensal: [],
                    ativa: false
                },
                [TIPOS_RESERVA.OPORTUNIDADE]: {
                    id: 'reserva-oportunidade',
                    nome: 'Reserva de Oportunidade',
                    descricao: 'Para aproveitar boas oportunidades',
                    metaValor: 0,
                    valorAtual: 0,
                    prioridade: 'media',
                    percentualRenda: 0.05,
                    contribuicaoMensal: 0,
                    historicoMensal: [],
                    ativa: false
                },
                [TIPOS_RESERVA.APOSENTADORIA]: {
                    id: 'reserva-aposentadoria',
                    nome: 'Previdência Privada',
                    descricao: 'Para complementar aposentadoria',
                    metaIdade: 60,
                    valorAtual: 0,
                    prioridade: 'alta',
                    percentualRenda: 0.15,
                    contribuicaoMensal: 0,
                    historicoMensal: [],
                    ativa: false
                }
            };
        }

// Verifique se esta função existe e está correta
function salvarTodosSistemas() {
    localStorage.setItem('metasMensais', JSON.stringify(metasMensais));
    localStorage.setItem('objetivosPoupanca', JSON.stringify(objetivosPoupanca));
    localStorage.setItem('reservasFinanceiras', JSON.stringify(reservasFinanceiras));
    localStorage.setItem('historicoMetas', JSON.stringify(historicoMetas));
    
    // Salva também no formato antigo para compatibilidade
    localStorage.setItem('smartGoals', JSON.stringify(metasMensais));
}

        function registrarProgressoMensal() {
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Verifica se já registrou este mês
            if (historicoMetas[mesAtual]) {
                return; // Já foi registrado
            }

            historicoMetas[mesAtual] = {
                metas: [],
                objetivos: [],
                reservas: {}
            };

            // Registra metas mensais
            metasMensais.forEach(meta => {
                historicoMetas[mesAtual].metas.push({
                    id: meta.id,
                    nome: meta.nome,
                    tipo: meta.tipo,
                    progresso: meta.progresso,
                    status: meta.status,
                    valorMeta: meta.valor,
                    valorAtual: meta.valorAtual
                });
            });

            // Registra objetivos
            objetivosPoupanca.forEach(obj => {
                const contribuicaoMes = calcularContribuicaoMesObjetivo(obj.id, mesAtual);

                historicoMetas[mesAtual].objetivos.push({
                    id: obj.id,
                    nome: obj.nome,
                    contribuicao: contribuicaoMes,
                    totalAcumulado: obj.valorJuntado
                });
            });

            // Registra reservas
            Object.entries(reservasFinanceiras).forEach(([tipo, reserva]) => {
                if (!reserva.ativa) return;

                const contribuicaoMes = calcularContribuicaoMesReserva(tipo, mesAtual);

                historicoMetas[mesAtual].reservas[tipo] = {
                    nome: reserva.nome,
                    contribuicao: contribuicaoMes,
                    totalAcumulado: reserva.valorAtual
                };
            });

            salvarTodosSistemas();
        }

function calcularContribuicaoMesObjetivo(objetivoId, mesKey) {
    const objetivo = objetivosPoupanca.find(o => o.id === objetivoId);
    if (!objetivo) return 0;
    
    const nomeCategoria = `Poupança: ${objetivo.nome}`;
    
    // Busca transações NEGATIVAS (saídas para poupança) com essa categoria
    return transactions
        .filter(t => {
            if (!t.categoria || t.categoria !== nomeCategoria) return false;
            // IMPORTANTE: Considera valores negativos como contribuição
            if (t.valor >= 0) return false;
            
            const [day, month, year] = t.data.split('/').map(Number);
            const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
            return transactionMonth === mesKey;
        })
        .reduce((sum, t) => sum + Math.abs(t.valor), 0);
}

function calcularContribuicaoMesReserva(tipoReserva, mesKey) {
    const reserva = reservasFinanceiras[tipoReserva];
    if (!reserva) return 0;
    
    // Busca transações NEGATIVAS (saídas para reserva) com essa categoria
    return transactions
        .filter(t => {
            if (!t.categoria || t.categoria !== reserva.nome) return false;
            // IMPORTANTE: Considera valores negativos como contribuição
            if (t.valor >= 0) return false;
            
            const [day, month, year] = t.data.split('/').map(Number);
            const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
            return transactionMonth === mesKey;
        })
        .reduce((sum, t) => sum + Math.abs(t.valor), 0);
}

        // Atualiza progresso dos objetivos e reservas
        function atualizarObjetivosEReservas() {
            const agora = new Date();
            const mesAtual = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;

            // Atualiza objetivos
            objetivosPoupanca.forEach(obj => {
                const contribuicaoMes = calcularContribuicaoMesObjetivo(obj.id, mesAtual);
                obj.contribuicaoMensal = contribuicaoMes;

                // Atualiza total acumulado
                const totalHistorico = Object.values(historicoMetas)
                    .reduce((sum, mes) => {
                        const objHistorico = mes.objetivos.find(o => o.id === obj.id);
                        return sum + (objHistorico ? objHistorico.contribuicao : 0);
                    }, 0);

                obj.valorJuntado = totalHistorico + contribuicaoMes;
            });

            // Atualiza reservas
            Object.entries(reservasFinanceiras).forEach(([tipo, reserva]) => {
                if (!reserva.ativa) return;

                const contribuicaoMes = calcularContribuicaoMesReserva(tipo, mesAtual);
                reserva.contribuicaoMensal = contribuicaoMes;

                // Atualiza total acumulado
                const totalHistorico = Object.values(historicoMetas)
                    .reduce((sum, mes) => {
                        const resHistorico = mes.reservas[tipo];
                        return sum + (resHistorico ? resHistorico.contribuicao : 0);
                    }, 0);

                reserva.valorAtual = totalHistorico + contribuicaoMes;

                // Atualiza meta da reserva de emergência
                if (tipo === TIPOS_RESERVA.EMERGENCIA) {
                    const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
                    reserva.valorMeta = burnRate * reserva.metaMeses;
                }
            });

            salvarTodosSistemas();
        }

        function showMetasTab(tabName) {
            // Esconde todas as abas
            document.querySelectorAll('.metas-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active de todos os links
            document.querySelectorAll('#metasTabsNav .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostra aba selecionada
            const targetTab = document.getElementById(`metasTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (targetTab) {
                targetTab.style.display = 'block';
            }

            // Ativa link clicado
            event.target.classList.add('active');

            // Renderiza conteúdo
            switch (tabName) {
                case 'mensais':
                    renderizarMetasMensais();
                    break;
                case 'objetivos':
                    renderizarObjetivosPoupanca();
                    break;
                case 'reservas':
                    renderizarReservasFinanceiras();
                    break;
                case 'historico':
                    popularSeletorHistorico();
                    break;
            }
        }

        function renderizarMetasMensais() {
            const container = document.getElementById('listaMetasMensais');
            if (!container) return;

            if (metasMensais.length === 0) {
                container.innerHTML = `
            <div class="text-center p-4 text-muted">
                <p>Nenhuma meta mensal criada ainda.</p>
                <p class="small">Crie metas de orçamento por categoria ou de redução de gastos.</p>
            </div>
        `;
                return;
            }

            let html = '';

            metasMensais.forEach(meta => {
                const corProgresso = getCorProgresso(meta);
                const iconeStatus = getIconeStatus(meta);

                html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6>${iconeStatus} ${meta.nome}</h6>
                            <small class="text-muted">${meta.descricao}</small>
                        </div>
                        <div class="btn-group">
                            <span class="badge bg-${getCorStatus(meta.status)}">${getTextStatus(meta.status)}</span>
                        </div>
                    </div>
                    
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar bg-${corProgresso}" 
                             style="width: ${Math.min(meta.progresso, 100)}%"
                             role="progressbar">
                            ${meta.progresso.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${getDetalhesMeta(meta)}
                        </div>
                        <div class="btn-group">
<button class="btn btn-sm btn-outline-secondary" onclick="abrirModalEditarMeta('${meta.id}')">Editar</button>                            <button class="btn btn-sm btn-outline-danger" onclick="excluirMeta('${meta.id}')">Excluir</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
            });

            container.innerHTML = html;
        }

        function renderizarObjetivosPoupanca() {
            const container = document.getElementById('listaObjetivosPoupanca');
            if (!container) return;

            if (objetivosPoupanca.length === 0) {
                container.innerHTML = `
            <div class="text-center p-4 text-muted">
                <p>Nenhum objetivo de poupança criado ainda.</p>
                <p class="small">Crie objetivos para casa própria, carro, viagem, etc.</p>
            </div>
        `;
                return;
            }

            let html = '<div class="row">';

            objetivosPoupanca.forEach(obj => {
                const progresso = (obj.valorJuntado / obj.valor) * 100;
                const dataObjetivo = new Date(obj.dataDesejada);
                const agora = new Date();
                const mesesRestantes = Math.max(0, Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24 * 30)));

                html += `
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6>${obj.nome}</h6>
                            <div class="btn-group">
    <button class="btn btn-sm btn-outline-secondary" onclick="editarObjetivo('${obj.id}')">✏️</button>
    <button class="btn btn-sm btn-outline-danger" onclick="excluirObjetivo('${obj.id}')">🗑️</button>
</div>
                        </div>
                        
                        ${obj.descricao ? `<p class="small text-muted">${obj.descricao}</p>` : ''}
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted">Este mês</small>
                                <div class="fw-bold text-success">
                                    ${obj.contribuicaoMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Total acumulado</small>
                                <div class="fw-bold">
                                    ${obj.valorJuntado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-${progresso >= 100 ? 'success' : progresso >= 50 ? 'info' : 'warning'}" 
                                 style="width: ${Math.min(progresso, 100)}%">
                            </div>
                        </div>
                        
                        <div class="small">
                            <strong>Meta:</strong> ${obj.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} 
                            (${progresso.toFixed(1)}%)<br>
                            <strong>Faltam:</strong> ${mesesRestantes} meses<br>
                            <strong>Necessário/mês:</strong> ${obj.valorMensalNecessario.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">💡 Categorize despesas como "Poupança: ${obj.nome}"</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderizarReservasFinanceiras() {
    const container = document.getElementById('listaReservasFinanceiras');
    if (!container) return;
    
    let html = '<div class="row">';
    
    Object.entries(reservasFinanceiras).forEach(([tipo, reserva]) => {
        const ativa = reserva.ativa;
        const progresso = reserva.valorMeta > 0 ? (reserva.valorAtual / reserva.valorMeta) * 100 : 0;
        
        html += `
            <div class="col-md-4 mb-3">
                <div class="card h-100 ${!ativa ? 'opacity-50' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6>${reserva.nome}</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="switch-${tipo}" ${ativa ? 'checked' : ''}
                                       onchange="toggleReserva('${tipo}', this.checked)">
                            </div>
                        </div>
                        
                        <p class="small text-muted">${reserva.descricao}</p>
                        
                        ${ativa ? `
                            <div class="row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Este mês</small>
                                    <div class="fw-bold text-success">
                                        ${reserva.contribuicaoMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Total acumulado</small>
                                    <div class="fw-bold">
                                        ${reserva.valorAtual.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-${progresso >= 100 ? 'success' : progresso >= 50 ? 'warning' : 'danger'}" 
                                     style="width: ${Math.min(progresso, 100)}%">
                                </div>
                            </div>
                            
                            <div class="small mb-2">
                                <strong>Meta:</strong> ${reserva.valorMeta > 0 ? reserva.valorMeta.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : 'Não definida'} 
                                ${progresso > 0 ? `(${progresso.toFixed(1)}%)` : ''}<br>
                                ${tipo === TIPOS_RESERVA.EMERGENCIA ? 
                                    `<strong>Equivalente a:</strong> ${reserva.metaMeses} meses de gastos<br>` : ''}
                                <strong>Sugestão/mês:</strong> ${(reserva.percentualRenda * (orcamentoBaseZero.rendaMensal || 0)).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                            </div>
                            
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="editarMetaReserva('${tipo}')">
                                    ⚙️ ${reserva.valorMeta > 0 ? 'Alterar Meta' : 'Definir Meta'}
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">💡 Categorize despesas como "${reserva.nome}"</small>
                            </div>
                        ` : `
                            <div class="alert alert-info py-2 px-2 small mb-0">
                                Ative esta reserva para começar a acompanhar seu progresso
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function toggleReserva(tipoReserva, ativar) {
    const reserva = reservasFinanceiras[tipoReserva];
    if (!reserva) return;
    
    reserva.ativa = ativar;
    
    if (ativar) {
        // Calcula meta automática se for emergência
        if (tipoReserva === TIPOS_RESERVA.EMERGENCIA) {
            const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
            reserva.valorMeta = burnRate * (reserva.metaMeses || 6);
        } else if (reserva.valorMeta === 0) {
            // Para outras reservas, pede para definir meta depois de ativar
            salvarTodosSistemas();
            renderizarReservasFinanceiras();
            
            setTimeout(() => {
                editarMetaReserva(tipoReserva);
            }, 300);
            return;
        }
        
        // Adiciona categoria se não existir
        if (!categories.includes(reserva.nome)) {
            categories.push(reserva.nome);
            updateFilterCategories();
        }
    }
    
    salvarTodosSistemas();
    renderizarReservasFinanceiras();
}


function editarMetaReserva(tipoReserva) {
    const reserva = reservasFinanceiras[tipoReserva];
    if (!reserva) return;
    
    let titulo, mensagem, valorAtual;
    
    if (tipoReserva === TIPOS_RESERVA.EMERGENCIA) {
        titulo = 'Configurar Reserva de Emergência';
        mensagem = 'Quantos meses de gastos você deseja como reserva?';
        valorAtual = reserva.metaMeses || 6;
        
        mostrarModalInput(titulo, mensagem, valorAtual.toString(), (valor) => {
            const meses = parseInt(valor);
            if (!isNaN(meses) && meses > 0 && meses <= 24) {
                reserva.metaMeses = meses;
                const burnRate = calculateMonthlyBurnRate(getTransactionsFromLastMonths(3));
                reserva.valorMeta = burnRate * meses;
                reserva.descricao = `Para situações imprevistas (${meses} meses de gastos)`;
                salvarTodosSistemas();
                renderizarReservasFinanceiras();
                alert(`Meta atualizada: ${meses} meses (${reserva.valorMeta.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})})`);
            } else {
                alert('Informe um valor entre 1 e 24 meses.');
            }
        });
        
    } else if (tipoReserva === TIPOS_RESERVA.OPORTUNIDADE) {
        titulo = 'Configurar Reserva de Oportunidade';
        mensagem = 'Qual o valor desejado para sua Reserva de Oportunidade?';
        valorAtual = reserva.valorMeta || 10000;
        
        mostrarModalInput(titulo, mensagem, valorAtual.toString(), (valor) => {
            const valorNum = parseFloat(valor);
            if (!isNaN(valorNum) && valorNum > 0) {
                reserva.valorMeta = valorNum;
                salvarTodosSistemas();
                renderizarReservasFinanceiras();
                alert(`Meta definida: ${valorNum.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`);
            } else {
                alert('Informe um valor válido.');
            }
        });
        
    } else if (tipoReserva === TIPOS_RESERVA.APOSENTADORIA) {
        titulo = 'Configurar Previdência Privada';
        mensagem = 'Qual o valor total desejado para aposentadoria?';
        valorAtual = reserva.valorMeta || 0;
        
        mostrarModalInput(titulo, mensagem, valorAtual > 0 ? valorAtual.toString() : '', (valor) => {
            const valorNum = parseFloat(valor);
            if (!isNaN(valorNum) && valorNum > 0) {
                reserva.valorMeta = valorNum;
                salvarTodosSistemas();
                renderizarReservasFinanceiras();
                alert(`Meta definida: ${valorNum.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`);
            } else {
                alert('Informe um valor válido.');
            }
        });
    }
}



        function popularSeletorHistorico() {
            const select = document.getElementById('seletorMesHistorico');
            if (!select) return;

            // Limpa opções existentes exceto a primeira
            select.innerHTML = '<option value="">Selecione...</option>';

            // Ordena meses do mais recente para o mais antigo
            const meses = Object.keys(historicoMetas).sort().reverse();

            if (meses.length === 0) {
                document.getElementById('conteudoHistorico').innerHTML = `
            <div class="alert alert-info">
                Ainda não há histórico de metas. Continue usando o sistema e o histórico será gerado automaticamente.
            </div>
        `;
                return;
            }

            meses.forEach(mesKey => {
                const [year, month] = mesKey.split('-');
                const data = new Date(year, month - 1);
                const option = document.createElement('option');
                option.value = mesKey;
                option.textContent = data.toLocaleDateString('pt-BR', {
                    month: 'long',
                    year: 'numeric'
                });
                select.appendChild(option);
            });

            // Seleciona automaticamente o mês mais recente
            if (meses.length > 0) {
                select.value = meses[0];
                renderizarHistoricoMes();
            }
        }

        function renderizarHistoricoMes() {
            const select = document.getElementById('seletorMesHistorico');
            const container = document.getElementById('conteudoHistorico');

            if (!select || !container) return;

            const mesKey = select.value;
            if (!mesKey) {
                container.innerHTML = '';
                return;
            }

            const historico = historicoMetas[mesKey];
            if (!historico) {
                container.innerHTML = '<div class="alert alert-warning">Dados não encontrados para este mês.</div>';
                return;
            }

            let html = '';

            // Metas Mensais
            if (historico.metas && historico.metas.length > 0) {
                html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">📊 Metas Mensais</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Meta</th>
                                    <th>Tipo</th>
                                    <th>Progresso</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${historico.metas.map(meta => `
                                    <tr>
                                        <td>${meta.nome}</td>
                                        <td><small>${meta.tipo === 'orcamento_categoria' ? 'Orçamento' : 'Redução'}</small></td>
                                        <td>
                                            <div class="progress" style="height: 20px; min-width: 100px;">
                                                <div class="progress-bar" style="width: ${Math.min(meta.progresso, 100)}%">
                                                    ${meta.progresso.toFixed(0)}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-${meta.status === 'cumprida' ? 'success' : meta.status === 'falhada' ? 'danger' : 'warning'}">
                                                ${getTextStatus(meta.status)}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
            }

            // Objetivos
            if (historico.objetivos && historico.objetivos.length > 0) {
                html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">🎯 Contribuições para Objetivos</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${historico.objetivos.map(obj => `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${obj.nome}</strong><br>
                                        <small class="text-muted">Total: ${obj.totalAcumulado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">
                                            +${obj.contribuicao.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
            }

            // Reservas
            if (historico.reservas && Object.keys(historico.reservas).length > 0) {
                html += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">🛡️ Contribuições para Reservas</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${Object.values(historico.reservas).map(res => `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${res.nome}</strong><br>
                                        <small class="text-muted">Total: ${res.totalAcumulado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-primary">
                                            +${res.contribuicao.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
            }

            if (html === '') {
                html = '<div class="alert alert-info">Nenhum dado registrado para este mês.</div>';
            }

            container.innerHTML = html;
        }

        function atualizarResumoMetas() {
            const ativas = metasMensais.filter(m => m.status === STATUS_META.ATIVA).length;
            const cumpridas = metasMensais.filter(m => m.status === STATUS_META.CUMPRIDA).length;
            const alerta = metasMensais.filter(m => m.status === STATUS_META.ATIVA && m.progresso >= 80).length;
            const falhadas = metasMensais.filter(m => m.status === STATUS_META.FALHADA).length;

            document.getElementById('totalMetasAtivas').textContent = ativas;
            document.getElementById('totalMetasCumpridas').textContent = cumpridas;
            document.getElementById('totalMetasAlerta').textContent = alerta;
            document.getElementById('totalMetasFalhadas').textContent = falhadas;
        }

        function carregarMetasMensais() {
            const saved = localStorage.getItem('metasMensais');
            if (saved) {
                metasMensais = JSON.parse(saved);
            }
        }

        function carregarObjetivosPoupanca() {
            const saved = localStorage.getItem('objetivosPoupanca');
            if (saved) {
                objetivosPoupanca = JSON.parse(saved);
            }
        }

        function carregarReservasFinanceiras() {
            const saved = localStorage.getItem('reservasFinanceiras');
            if (saved) {
                reservasFinanceiras = JSON.parse(saved);
            }
        }

        function carregarHistoricoMetas() {
            const saved = localStorage.getItem('historicoMetas');
            if (saved) {
                historicoMetas = JSON.parse(saved);
            }
        }



        // ===================================================================
        // CONTROLE DAS ABAS DE PLANEJAMENTO
        // ===================================================================

function showPlanningTab(tabName) {
    // Esconde todas as abas
    document.querySelectorAll('.planning-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active de todos os links
    document.querySelectorAll('#planningTabsNav .nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // Mostra aba selecionada
    const targetTab = document.getElementById(`planningTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
    if (targetTab) {
        targetTab.style.display = 'block';
    }

    // Ativa link clicado
    if (event && event.target) {
        event.target.classList.add('active');
    }

    // Atualiza conteúdo específico da aba
    if (tabName === 'orcamento') {
        atualizarOrcamentoBaseZeroView();
    } else if (tabName === 'outros') {
        // Nada específico para carregar
    }
}

        function atualizarVisualizacaoFerramentas() {
            atualizarOrcamentoBaseZeroView();
            atualizarObjetivosView();
            atualizarReservasView();
        }

        function atualizarOrcamentoBaseZeroView() {
            const container = document.getElementById('orcamentoBaseZeroView');
            if (!container) return;

            if (!orcamentoBaseZero.ativo) {
                container.innerHTML = `
                       <div class="text-center p-4">
                           <h5>💰 Orçamento Base Zero</h5>
                           <p class="text-muted mb-4">
                               Aloque cada real da sua renda para uma categoria específica.
                               No orçamento base zero, renda menos gastos deve sempre ser igual a zero.
                           </p>
                           <button class="btn btn-primary" onclick="criarOrcamentoBaseZero()">Criar Meu Orçamento</button>
                       </div>
                   `;
                return;
            }

            const totalAlocado = Object.values(orcamentoBaseZero.alocacoes).reduce((sum, v) => sum + v, 0);
            const percentualAlocado = (totalAlocado / orcamentoBaseZero.rendaMensal) * 100;
            const dataUltimaAtualizacao = new Date(orcamentoBaseZero.dataUltimaAtualizacao).toLocaleDateString('pt-BR');

            // --- LÓGICA DE CÁLCULO ---
            const agora = new Date();
            const periodoSelecionado = document.getElementById('periodoOrcamento')?.value;
            const mesAlvo = periodoSelecionado || `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;
            const dataAlvo = periodoSelecionado ? new Date(mesAlvo + '-02') : agora;

            const gastosReaisMes = {};
            transactions.filter(t => {
                if (t.valor >= 0) return false;
                const [day, month, year] = t.data.split('/').map(Number);
                const transactionMonth = `${year}-${String(month).padStart(2, '0')}`;
                return transactionMonth === mesAlvo;
            }).forEach(t => {
                gastosReaisMes[t.categoria] = (gastosReaisMes[t.categoria] || 0) + Math.abs(t.valor);
            });

            // 1. Define o HTML do seletor de período primeiro.
            const seletorPeriodoHTML = `
                   <div class="mb-3">
                       <label for="periodoOrcamento" class="form-label">Período de Comparação:</label>
                       <select id="periodoOrcamento" class="form-select" onchange="atualizarOrcamentoBaseZeroView()">
                           <option value="">Selecione o mês</option>
                       </select>
                   </div>
               `;

            // 2. Monta o HTML principal da view, incluindo o seletor.
            container.innerHTML = `
                   <div class="row mb-4">
                       <div class="col-md-6">
                           <div class="card bg-light">
                               <div class="card-body text-center">
                                   <h5>Renda Mensal</h5>
                                   <h3 class="text-success">${orcamentoBaseZero.rendaMensal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</h3>
                               </div>
                           </div>
                       </div>
                       <div class="col-md-6">
                           <div class="card bg-light">
                               <div class="card-body text-center">
                                   <h5>Total Alocado</h5>
                                   <h3 class="${percentualAlocado > 105 ? 'text-danger' : percentualAlocado < 95 ? 'text-warning' : 'text-success'}">
                                       ${totalAlocado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                   </h3>
                                   <small>(${percentualAlocado.toFixed(1)}%)</small>
                               </div>
                           </div>
                       </div>
                   </div>
            
                   ${seletorPeriodoHTML} 
            
                   <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Orçado vs Realizado - ${dataAlvo.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</h6>
                       <div>
                           <button class="btn btn-outline-primary btn-sm" onclick="abrirEditorOrcamento()">Editar Orçamento</button>
                           <small class="text-muted ms-2">Atualizado em ${dataUltimaAtualizacao}</small>
                       </div>
                   </div>
            
                   <div class="table-responsive">
                       <table class="table table-sm">
                           <thead>
                               <tr>
                                   <th>Categoria</th>
                                   <th>Orçado</th>
                                   <th>Realizado</th>
                                   <th>Diferença</th>
                                   <th>Status</th>
                               </tr>
                           </thead>
                           <tbody>
                               ${Object.entries(orcamentoBaseZero.alocacoes).map(([categoria, orcado]) => {
                                   const realizado = gastosReaisMes[categoria] || 0;
                                   const diferenca = orcado - realizado;
                                   const percentual = orcado > 0 ? (realizado / orcado) * 100 : 0;
                                   return `
                                   <tr>
                                       <td><strong>${categoria}</strong></td>
                                       <td>${orcado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                                       <td>${realizado.toLocaleString('pt-BR', {style: 'currency', 'currency': 'BRL'})}</td>
                                       <td class="${diferenca >= 0 ? 'text-success' : 'text-danger'}">${diferenca.toLocaleString('pt-BR', {style: 'currency', 'currency': 'BRL'})}</td>
                                       <td><span class="badge bg-${percentual > 110 ? 'danger' : percentual > 90 ? 'warning' : 'success'}">${percentual.toFixed(0)}%</span></td>
                                   </tr>
                                   `;
                               }).join('')}
                           </tbody>
                       </table>
                   </div>
               `;

            // 3. Executa o código para popular o seletor DEPOIS que ele foi criado e inserido no DOM.
            setTimeout(() => {
                const selectPeriodo = document.getElementById('periodoOrcamento');
                if (selectPeriodo && selectPeriodo.options.length === 1) { // Popula apenas uma vez
                    const meses = new Set();
                    transactions.forEach(t => {
                        if (!t.data) return;
                        const [day, month, year] = t.data.split('/').map(Number);
                        const mesKey = `${year}-${String(month).padStart(2, '0')}`;
                        meses.add(mesKey);
                    });

                    Array.from(meses).sort().reverse().forEach(mesKey => {
                        const [year, month] = mesKey.split('-');
                        const data = new Date(year, month - 1);
                        const option = document.createElement('option');
                        option.value = mesKey;
                        option.textContent = data.toLocaleDateString('pt-BR', {
                            month: 'long',
                            year: 'numeric'
                        });
                        selectPeriodo.appendChild(option);
                    });

                    // Seleciona o mês que estava ativo
                    selectPeriodo.value = mesAlvo;
                }
            }, 100);
        }

        function atualizarObjetivosView() {
            const container = document.getElementById('objetivosLongoPrazoView');
            if (!container) return;

            if (objetivosLongoPrazo.length === 0) {
                container.innerHTML = ` 
                   <div class = "text-center p-4 text-muted">
                   <p> Nenhum objetivo definido ainda. </p> 
            <button class = "btn btn-success"
                   onclick = "criarObjetivoLongoPrazo()"> Criar Primeiro Objetivo </button> 
            </div>
                   `;
                return;
            }

            // Ordena por prioridade e progresso
            const objetivosOrdenados = [...objetivosLongoPrazo].sort((a, b) => {
                const prioridadeOrder = {
                    'alta': 3,
                    'media': 2,
                    'baixa': 1
                };
                return prioridadeOrder[b.prioridade] - prioridadeOrder[a.prioridade];
            });

            let html = '<div class="row">';

            objetivosOrdenados.forEach(objetivo => {
                const progresso = (objetivo.valorJuntado / objetivo.valor) * 100;
                const dataObjetivo = new Date(objetivo.dataDesejada);
                const agora = new Date();
                const diasRestantes = Math.ceil((dataObjetivo - agora) / (1000 * 60 * 60 * 24));

                html += ` <div class = "col-md-6 mb-3">
                   <div class = "card h-100">
                   <div class = "card-body">
                   <div class = "d-flex justify-content-between align-items-start mb-2">
                   <h6 class = "card-title">${
                       objetivo.nome
                   } </h6> 
            <div class = "btn-group">
                   <button class = "btn btn-sm btn-outline-secondary"
                   onclick = "adicionarPoupancaObjetivo('${objetivo.id}')"> 💰 </button> 
                   <button class = "btn btn-sm btn-outline-danger"
                   onclick = "excluirObjetivo('${objetivo.id}')"> 🗑️ </button> 
            </div> 
            </div>
            
                   ${
                       objetivo.descricao ? `<p class="card-text small text-muted">${objetivo.descricao}</p>` : ''
                   }
            
                   <div class = "mb-3" >
                   <div class = "d-flex justify-content-between mb-1">
                   <small> Progresso </small> 
                   <small>${
                           progresso.toFixed(1)
                       } % </small> 
                       </div> 
                       <div class = "progress"
                   style = "height: 8px;">
                       <div class = "progress-bar bg-${progresso >= 100 ? 'success' : progresso >= 50 ? 'info' : 'warning'}"
                   style = "width: ${Math.min(progresso, 100)}%"> </div> 
                   </div> 
                       </div>
            
                       <div class = "small mb-2">
                       <strong> Juntado: </strong> ${objetivo.valorJuntado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}<br> 
                       <strong> Meta: </strong> ${objetivo.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}<br> <strong> Faltam: </strong> ${diasRestantes> 0 ? `${diasRestantes} dias` : 'Prazo vencido'}<br> 
                       <strong> Necessário / mês: </strong> ${objetivo.valorMensalNecessario.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})} 
                       </div>
            
                       <span class = "badge bg-${objetivo.prioridade === 'alta' ? 'danger' : 
                   objetivo.prioridade === 'media' ? 'warning' : 'secondary'
            }">
            
                   Prioridade ${
                       objetivo.prioridade
                   } 
                   </span> 
                   </div> 
                   </div> 
                   </div>
                   `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function atualizarReservasView() {
            const container = document.getElementById('sistemaReservasView');
            if (!container) return;

            container.innerHTML = renderizarSistemaReservas();
        }

        function adicionarPoupancaObjetivo(objetivoId) {
            const valor = parseFloat(prompt('Quanto você conseguiu poupar para este objetivo?') || '0');
            if (isNaN(valor) || valor <= 0) {
                alert('Valor inválido.');
                return;
            }

            atualizarObjetivo(objetivoId, valor);
            atualizarVisualizacaoFerramentas();

            const objetivo = objetivosLongoPrazo.find(obj => obj.id === objetivoId);
            if (objetivo) {
                alert(`
                   Parabéns!$ {
                       valor.toLocaleString('pt-BR', {
                           style: 'currency',
                           currency: 'BRL'
                       })
                   }
                   adicionado ao objetivo "${objetivo.nome}".
                   `);
            }
        }

        // Adicione esta função para melhorar performance de scroll

        let scrollTimeout;

        function optimizeScrollPerformance() {
            const transactionList = document.getElementById('transactionList');
            if (!transactionList) return;

            transactionList.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                transactionList.style.pointerEvents = 'none';

                scrollTimeout = setTimeout(function() {
                    transactionList.style.pointerEvents = 'auto';
                }, 150);
            }, {
                passive: true
            });
        }

// Salva estado dos filtros de análise
function salvarEstadoFiltrosAnalise() {
    const estado = {
        periodoAnalise: document.getElementById('periodoAnalise')?.value || ''
    };
    localStorage.setItem('estadoFiltrosAnalise', JSON.stringify(estado));
}

// Restaura estado dos filtros
function restaurarEstadoFiltrosAnalise() {
    const saved = localStorage.getItem('estadoFiltrosAnalise');
    if (saved) {
        const estado = JSON.parse(saved);
        
        const selectPeriodo = document.getElementById('periodoAnalise');
        if (selectPeriodo && estado.periodoAnalise) {
            selectPeriodo.value = estado.periodoAnalise;
        }
    }
}

// Atualiza a função atualizarAnalises para salvar o estado
function atualizarAnalises() {
    salvarEstadoFiltrosAnalise();
    atualizarDashboardExecutivo();
    renderCategoryChart();
}





        window.onload = () => {

            // Detecta se é mobile e ajusta itens por página
            function detectMobile() {
                const isMobile = window.innerWidth <= 768;
                document.body.setAttribute('data-mobile', isMobile);
                if (isMobile) {
                    itemsPerPage = 20; // Reduz de 40 para 20 no mobile
                }
            }

            detectMobile();


            // Carrega o tema
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const toggle = document.getElementById('themeToggle');
                if (toggle) toggle.textContent = '☀️';
            }

            // Carrega transações do localStorage
            const saved = localStorage.getItem('transactions');
            if (saved) {
                transactions = JSON.parse(saved);
            }

            // **ROTINA DE MIGRAÇÃO DE DADOS ANTIGOS**
            let needsSave = false;
            transactions.forEach(t => {
                if (!t.status) {
                    needsSave = true;
                    if (t.tipo === 'Compra no Crédito' || t.tipo === 'Compra Manual (Cartão)') {
                        t.tipoLancamento = 'cartao';
                        t.status = 'pago';
                        const [day, month, year] = t.data.split('/');
                        t.idFatura = `
                   $ {
                       year
                   } - $ {
                       month
                   }
                   `;
                    } else {
                        t.tipoLancamento = 'conta';
                        t.status = 'caixa';
                        t.idFatura = null;
                    }
                }
            });

            let needsManualMigration = false;
            transactions.forEach(t => {
                if (t.identificador && t.identificador.startsWith('manual-')) {
                    if (t.isManual === undefined) {
                        t.isManual = true;
                        t.conciliado = false;
                        t.conciliadoCom = null;
                        needsManualMigration = true;
                    }
                } else if (t.isManual === undefined) {
                    t.isManual = false;
                    t.conciliado = false;
                    t.conciliadoCom = null;
                    needsManualMigration = true;
                }
            });

            if (needsManualMigration) {
                saveTransactions();
            }

            // Salva apenas se a migração tiver feito alguma alteração
            if (needsSave) {
                console.log('Migração de dados concluída. Transações atualizadas para o novo formato.');
                saveTransactions();
            }

            // Carrega o restante dos dados
            const savedBudget = localStorage.getItem('monthlyBudget');
            const budgetInput = document.getElementById('budget');
            if (savedBudget && budgetInput) {
                monthlyBudget = parseFloat(savedBudget);
                budgetInput.value = monthlyBudget;
            }

            const savedStartDate = localStorage.getItem('savedStartDate');
            const savedEndDate = localStorage.getItem('savedEndDate');
            const startDateInput = document.getElementById('startDateFilter');
            const endDateInput = document.getElementById('endDateFilter');

            if (startDateInput && endDateInput) {
                if (savedStartDate && savedEndDate) {
                    startDateInput.value = savedStartDate;
                    endDateInput.value = savedEndDate;
                } else {
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    startDateInput.value = firstDay.toISOString().split('T')[0];
                    endDateInput.value = lastDay.toISOString().split('T')[0];
                }
            }

            // Inicializa a aplicação
            carregarMetas();
            carregarOrcamentoBaseZero();
            carregarObjetivosLongoPrazo();
            carregarSistemaReservas();
            carregarRegrasCategorização();
            loadGoals(); // Manter para compatibilidade
            updateCategories();
            popularSeletorMeses();
            popularSeletorAnalise();
            restaurarEstadoFiltrosAnalise();
            optimizeScrollPerformance();
            loadFiltersState(); // Carrega os valores dos filtros para os inputs
            filteredTransactions = [...transactions];
            applyFilters();
            updateFilterCategories();
            updateGoalsView();
            atualizarVisualizacaoMetas();
            toggleValueInputs();
            window.addEventListener('resize', detectMobile);
           // showPage('page-transactions');
            carregarClassificacaoCategorias();


            // Carrega a última página ativa ou a página de transações como padrão
            const savedPageId = localStorage.getItem('activePageId') || 'page-transactions';
            const buttonToActivate = document.querySelector(`.nav-button[onclick*="'${savedPageId}'"]`);
            
            showPage(savedPageId, buttonToActivate);

            // Garante que os gráficos sejam renderizados se a página de análise for a inicial
            setTimeout(() => {
                if (savedPageId === 'page-analysis') {
                    renderCharts();
                }
            }, 100);

            // Verifica alertas a cada 5 minutos
            setInterval(() => {
                if (transactions.length > 0) {
                    const alertas = verificarAlertasInteligentes();
                    const alertasCriticos = alertas.filter(a => a.prioridade === 'critica');

                    alertasCriticos.forEach(alerta => {
                        mostrarNotificacaoDiscreta(alerta.titulo, alerta.descricao, alerta.prioridade);
                    });
                }
            }, 300000); // 5 minutos

            inicializarSistemaMetasUnificado();

            // Atualiza progresso e registra histórico
            atualizarProgressoTodasMetas();
            registrarProgressoMensal();
            atualizarResumoMetas();

        };
    </script>
</body>

</html>